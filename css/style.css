// URL do Google Apps Script - SUBSTITUA PELA SUA URL
const SCRIPT_URL = 'https://script.google.com/macros/s/SEU_ID_AQUI/exec';

// Mostrar seção específica
function mostrarSecao(secao) {
  // Remover classe active de todas as seções e botões
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  
  // Adicionar classe active à seção e botão selecionados
  document.getElementById(secao).classList.add('active');
  event.target.closest('.nav-btn').classList.add('active');
}

// Mostrar seção específica do admin
function mostrarAdminSecao(secao) {
  // Remover classe active de todas as seções e botões
  document.querySelectorAll('.admin-section').forEach(s => {
    s.classList.remove('active');
  });
  
  document.querySelectorAll('.admin-menu-btn').forEach(b => b.classList.remove('active'));
  
  // Adicionar classe active à seção e botão selecionados
  const secaoElement = document.getElementById(`admin-${secao}`);
  secaoElement.classList.add('active');
  
  event.target.closest('.admin-menu-btn').classList.add('active');
  
  // Carregar dados da seção
  if (secao === 'dashboard') {
    carregarDashboard();
  } else if (secao === 'pedidos') {
    carregarPedidos();
  }
}

// Função para exibir mensagens
function exibirMensagem(elementoId, tipo, mensagem) {
  const elemento = document.getElementById(elementoId);
  const icone = tipo === 'sucesso' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
  
  elemento.innerHTML = `
    <div class="mensagem ${tipo}">
      <i class="${icone}"></i>
      ${mensagem}
    </div>
  `;
  
  // Auto-remover após 5 segundos
  setTimeout(() => {
    elemento.innerHTML = '';
  }, 5000);
}

// Enviar pedido
document.getElementById('formPedido').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  formData.append('action', 'novoPedido');
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      exibirMensagem('mensagemPedido', 'sucesso', `Pedido realizado com sucesso! Número do pedido: ${data.numPedido}`);
      this.reset();
      
      // Resetar campos de quantidade
      document.querySelectorAll('input[type="number"]').forEach(input => {
        if (input.name.includes('infantil_') || input.name.includes('babylook_') || input.name.includes('unissex_')) {
          input.value = 0;
        }
      });
    } else {
      exibirMensagem('mensagemPedido', 'erro', `Erro ao realizar pedido: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    exibirMensagem('mensagemPedido', 'erro', 'Erro na comunicação com o servidor');
  });
});

// Consultar pedido por ID
document.getElementById('formConsultar').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  formData.append('action', 'consultarPedidoPorId');
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    const divResultado = document.getElementById('resultadoConsulta');
    
    if (data.success) {
      const pedido = data.pedido;
      const statusClass = `status-${pedido.status.toLowerCase()}`;
      
      let html = `
        <div class="pedido-item">
          <div class="pedido-header">
            <div class="pedido-numero">#${pedido.numPedido}</div>
            <div class="pedido-status ${statusClass}">${pedido.status}</div>
          </div>
          
          <div class="pedido-info">
            <p><i class="fas fa-calendar"></i> <strong>Data:</strong> ${new Date(pedido.data).toLocaleString()}</p>
            <p><i class="fas fa-user"></i> <strong>Nome:</strong> ${pedido.nome}</p>
            <p><i class="fas fa-map-marker-alt"></i> <strong>Local:</strong> ${pedido.local}</p>
            <p><i class="fas fa-building"></i> <strong>Setor:</strong> ${pedido.setor}</p>
            <p><i class="fas fa-envelope"></i> <strong>Email:</strong> ${pedido.email}</p>
          </div>
          
          <div class="pedido-tamanhos">
            <div class="tipo-tamanhos">
              <h4><i class="fas fa-child"></i> Infantis</h4>
              <ul>
                ${Object.entries(pedido.infantil).map(([tamanho, qtd]) => 
                  qtd > 0 ? `<li>${tamanho}: ${qtd}</li>` : ''
                ).join('')}
              </ul>
            </div>
            
            <div class="tipo-tamanhos">
              <h4><i class="fas fa-female"></i> Babylook</h4>
              <ul>
                ${Object.entries(pedido.babylook).map(([tamanho, qtd]) => 
                  qtd > 0 ? `<li>${tamanho}: ${qtd}</li>` : ''
                ).join('')}
              </ul>
            </div>
            
            <div class="tipo-tamanhos">
              <h4><i class="fas fa-tshirt"></i> Unissex</h4>
              <ul>
                ${Object.entries(pedido.unissex).map(([tamanho, qtd]) => 
                  qtd > 0 ? `<li>${tamanho}: ${qtd}</li>` : ''
                ).join('')}
              </ul>
            </div>
          </div>
          
          <div class="admin-actions">
            <button class="btn-editar" onclick="mostrarFormularioEdicao('${pedido.numPedido}')">
              <i class="fas fa-edit"></i> Editar
            </button>
          </div>
        </div>
      `;
      
      html += `<div id="form-edicao-${pedido.numPedido}"></div>`;
      
      divResultado.innerHTML = html;
    } else {
      exibirMensagem('resultadoConsulta', 'erro', data.error);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    exibirMensagem('resultadoConsulta', 'erro', 'Erro na comunicação com o servidor');
  });
});

// Mostrar formulário de edição
function mostrarFormularioEdicao(numPedido) {
  const formContainer = document.getElementById(`form-edicao-${numPedido}`);
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: new FormData().append('action', 'consultarPedidoPorId').append('numPedido', numPedido)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const pedido = data.pedido;
      
      let html = `
        <div class="edit-form">
          <h3><i class="fas fa-edit"></i> Editar Pedido #${numPedido}</h3>
          <form id="formEditarPedido">
            <input type="hidden" name="numPedido" value="${numPedido}">
            
            <div class="form-grid">
              <div class="form-group">
                <label for="edit-nome">
                  <i class="fas fa-user"></i>
                  Nome do Líder/Coordenador
                </label>
                <input type="text" id="edit-nome" name="nome" value="${pedido.nome}" required>
              </div>
              
              <div class="form-group">
                <label>
                  <i class="fas fa-map-marker-alt"></i>
                  Localização
                </label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="local" value="Capital" ${pedido.local === 'Capital' ? 'checked' : ''} required>
                    <span class="radio-custom"></span>
                    Capital
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="local" value="Interior" ${pedido.local === 'Interior' ? 'checked' : ''} required>
                    <span class="radio-custom"></span>
                    Interior
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label for="edit-setor">
                  <i class="fas fa-building"></i>
                  Setor/Cidade
                </label>
                <input type="text" id="edit-setor" name="setor" value="${pedido.setor}" required>
              </div>
              
              <div class="form-group">
                <label for="edit-email">
                  <i class="fas fa-envelope"></i>
                  E-mail
                </label>
                <input type="email" id="edit-email" name="email" value="${pedido.email}" required>
              </div>
            </div>
            
            <div class="camisetas-section">
              <div class="tipo-camiseta">
                <h3><i class="fas fa-child"></i> Pedidos Infantis</h3>
                <div class="tamanhos-grid">
                  ${['1', '2', '4', '6', '8', '10', '12', '14'].map(tamanho => `
                    <div class="tamanho-item">
                      <label for="edit-infantil_${tamanho}">${tamanho}</label>
                      <input type="number" id="edit-infantil_${tamanho}" name="infantil_${tamanho}" min="0" value="${pedido.infantil[tamanho] || 0}">
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <div class="tipo-camiseta">
                <h3><i class="fas fa-female"></i> Adultos Babylook</h3>
                <div class="tamanhos-grid">
                  ${['PP', 'P', 'M', 'G', 'GG', 'XGG'].map(tamanho => `
                    <div class="tamanho-item">
                      <label for="edit-babylook_${tamanho}">${tamanho}</label>
                      <input type="number" id="edit-babylook_${tamanho}" name="babylook_${tamanho}" min="0" value="${pedido.babylook[tamanho] || 0}">
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <div class="tipo-camiseta">
                <h3><i class="fas fa-tshirt"></i> Adultos Unissex</h3>
                <div class="tamanhos-grid">
                  ${['PP', 'P', 'M', 'G', 'GG', 'XGG'].map(tamanho => `
                    <div class="tamanho-item">
                      <label for="edit-unissex_${tamanho}">${tamanho}</label>
                      <input type="number" id="edit-unissex_${tamanho}" name="unissex_${tamanho}" min="0" value="${pedido.unissex[tamanho] || 0}">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="submit">
                <i class="fas fa-save"></i> Salvar Alterações
              </button>
              <button type="button" onclick="cancelarEdicao('${numPedido}')">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </form>
        </div>
      `;
      
      formContainer.innerHTML = html;
      
      // Adicionar evento de submit ao formulário
      document.getElementById('formEditarPedido').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('action', 'editarPedido');
        
        fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            exibirMensagem('resultadoConsulta', 'sucesso', 'Pedido atualizado com sucesso!');
            cancelarEdicao(numPedido);
            // Recarregar a consulta
            document.getElementById('formConsultar').dispatchEvent(new Event('submit'));
          } else {
            exibirMensagem('resultadoConsulta', 'erro', `Erro ao atualizar pedido: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          exibirMensagem('resultadoConsulta', 'erro', 'Erro na comunicação com o servidor');
        });
      });
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    exibirMensagem('resultadoConsulta', 'erro', 'Erro ao carregar dados do pedido');
  });
}

// Cancelar edição
function cancelarEdicao(numPedido) {
  document.getElementById(`form-edicao-${numPedido}`).innerHTML = '';
}

// Login admin
document.getElementById('formLogin').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  formData.append('action', 'loginAdmin');
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      document.getElementById('loginAdmin').style.display = 'none';
      document.getElementById('painelAdmin').style.display = 'block';
      mostrarAdminSecao('dashboard');
    } else {
      exibirMensagem('mensagemLogin', 'erro', data.error);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    exibirMensagem('mensagemLogin', 'erro', 'Erro na comunicação com o servidor');
  });
});

// Carregar dados do dashboard
function carregarDashboard() {
  const formData = new FormData();
  formData.append('action', 'getDashboardData');
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      const dashboard = data.dashboard;
      
      // Animação de contagem
      animateValue('totalPedidos', 0, dashboard.totalPedidos, 1000);
      animateValue('totalCamisetas', 0, dashboard.totalCamisetas, 1000);
      animateValue('pedidosPendentes', 0, dashboard.pedidosPendentes, 1000);
      animateValue('pedidosAprovados', 0, dashboard.pedidosAprovados, 1000);
      animateValue('totalInfantis', 0, dashboard.totalInfantis, 1000);
      animateValue('totalBabylook', 0, dashboard.totalBabylook, 1000);
      animateValue('totalUnissex', 0, dashboard.totalUnissex, 1000);
      animateValue('pedidosRejeitados', 0, dashboard.pedidosRejeitados, 1000);
    } else {
      console.error('Erro ao carregar dashboard:', data.error);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
  });
}

// Animação de contagem para números
function animateValue(id, start, end, duration) {
  const obj = document.getElementById(id);
  const range = end - start;
  const minTimer = 50;
  let stepTime = Math.abs(Math.floor(duration / range));
  stepTime = Math.max(stepTime, minTimer);
  const startTime = new Date().getTime();
  const endTime = startTime + duration;
  
  function run() {
    const now = new Date().getTime();
    const remaining = Math.max((endTime - now) / duration, 0);
    const value = Math.round(end - (remaining * range));
    obj.innerHTML = value;
    if (value == end) {
      clearInterval(timer);
    }
  }
  
  const timer = setInterval(run, stepTime);
  run();
}

// Carregar pedidos no painel admin
function carregarPedidos() {
  const formData = new FormData();
  formData.append('action', 'listarPedidos');
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    const divLista = document.getElementById('listaPedidos');
    
    if (data.success) {
      if (data.pedidos.length > 0) {
        let html = '';
        data.pedidos.forEach(pedido => {
          const statusClass = `status-${pedido.status.toLowerCase()}`;
          
          html += `
            <div class="pedido-item">
              <div class="pedido-header">
                <div class="pedido-numero">#${pedido.numPedido}</div>
                <div class="pedido-status ${statusClass}">${pedido.status}</div>
              </div>
              
              <div class="pedido-info">
                <p><i class="fas fa-calendar"></i> <strong>Data:</strong> ${new Date(pedido.data).toLocaleString()}</p>
                <p><i class="fas fa-user"></i> <strong>Nome:</strong> ${pedido.nome}</p>
                <p><i class="fas fa-map-marker-alt"></i> <strong>Local:</strong> ${pedido.local}</p>
                <p><i class="fas fa-building"></i> <strong>Setor:</strong> ${pedido.setor}</p>
                <p><i class="fas fa-envelope"></i> <strong>Email:</strong> ${pedido.email}</p>
              </div>
              
              <div class="pedido-tamanhos">
                <div class="tipo-tamanhos">
                  <h4><i class="fas fa-child"></i> Infantis</h4>
                  <ul>
                    ${Object.entries(pedido.infantil).map(([tamanho, qtd]) => 
                      qtd > 0 ? `<li>${tamanho}: ${qtd}</li>` : ''
                    ).join('')}
                  </ul>
                </div>
                
                <div class="tipo-tamanhos">
                  <h4><i class="fas fa-female"></i> Babylook</h4>
                  <ul>
                    ${Object.entries(pedido.babylook).map(([tamanho, qtd]) => 
                      qtd > 0 ? `<li>${tamanho}: ${qtd}</li>` : ''
                    ).join('')}
                  </ul>
                </div>
                
                <div class="tipo-tamanhos">
                  <h4><i class="fas fa-tshirt"></i> Unissex</h4>
                  <ul>
                    ${Object.entries(pedido.unissex).map(([tamanho, qtd]) => 
                      qtd > 0 ? `<li>${tamanho}: ${qtd}</li>` : ''
                    ).join('')}
                  </ul>
                </div>
              </div>
              
              <div class="admin-actions">
                ${pedido.status === 'Pendente' ? `
                  <button class="btn-aprovar" onclick="atualizarStatus('${pedido.numPedido}', 'Aprovado')">
                    <i class="fas fa-check"></i> Aprovar
                  </button>
                  <button class="btn-rejeitar" onclick="atualizarStatus('${pedido.numPedido}', 'Rejeitado')">
                    <i class="fas fa-times"></i> Rejeitar
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        });
        
        divLista.innerHTML = html;
      } else {
        divLista.innerHTML = '<div class="mensagem erro"><i class="fas fa-info-circle"></i> Nenhum pedido encontrado.</div>';
      }
    } else {
      console.error('Erro ao carregar pedidos:', data.error);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
  });
}

// Atualizar status do pedido
function atualizarStatus(numPedido, status) {
  const formData = new FormData();
  formData.append('action', 'atualizarStatus');
  formData.append('numPedido', numPedido);
  formData.append('status', status);
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      carregarPedidos();
    } else {
      alert('Erro ao atualizar status: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('Erro na comunicação com o servidor');
  });
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
  // Mostrar a primeira seção por padrão
  mostrarSecao('pedido');
});
