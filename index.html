<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMADEMATS | Premium Access</title>
  <!-- Evita erro 404 de favicon -->
  <link rel="icon" href="data:,">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Fonte Manrope (Estilo Fintech/Audax) -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Markdown Parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* =========================================
       ESTÉTICA "AUDAX NAVY & GOLD"
       ========================================= */

    :root {
      /* GRADIENTE DOURADO METÁLICO (GOLD FOIL) */
      --gold-metallic: linear-gradient(135deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5b7 75%, #aa771c 100%);
      --gold-solid: #d4af37;
      
      /* FUNDOS - NOVA PALETA AZUL MARINHO */
      --bg-body: #020c1b;        /* Azul Quase Preto */
      --bg-surface: #0a192f;     /* Azul Marinho Profundo */
      --bg-card: rgba(10, 25, 47, 0.7); /* Glass Azulado */
      
      /* BORDAS & DETALHES */
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-gold: rgba(212, 175, 55, 0.3);
      
      /* TEXTO */
      --text-main: #e6f1ff;      /* Branco levemente azulado para conforto */
      --text-muted: #8892b0;     /* Cinza azulado */
      
      /* VARIÁVEIS DE COMPATIBILIDADE JS */
      --primary-color: #d4af37;
      --primary-dark: #b38728;
      --success-color: #64ffda; /* Verde Neon Suave */
      --warning-color: #ffd700;
      --danger-color: #ff6b6b;
      
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 16px;
      
      --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Manrope', sans-serif;
      background-color: var(--bg-body);
      /* Background original comentado para dar lugar ao Canvas, 
         mas a cor de fundo base permanece por segurança */
      /* background-image: radial-gradient(circle at 50% 0%, #112240 0%, #020c1b 70%); */
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative; /* Necessário para o z-index funcionar corretamente */
    }

    /* =========================================
       NOVO BACKGROUND LUXUOSO (BEAMS)
       ========================================= */
    
    #beams-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Garante que fique atrás de tudo */
        overflow: hidden;
        background-color: var(--bg-body); /* Base escura */
        pointer-events: none; /* Permite clicar através do fundo */
    }

    #beams-canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        filter: blur(15px); /* Efeito de desfoque solicitado */
    }

    /* Overlay simulando o motion.div do React */
    .beams-overlay {
        position: absolute;
        inset: 0;
        background-color: rgba(2, 12, 27, 0.05);
        z-index: 1;
        backdrop-filter: blur(50px);
        animation: pulseOverlay 10s ease-in-out infinite;
    }

    @keyframes pulseOverlay {
        0% { opacity: 0.05; }
        15% { opacity: 0.15; }
        50% { opacity: 0.05; }
        100% { opacity: 0.05; }
    }

    /* =========================================
       FIM BACKGROUND
       ========================================= */

    /* TIPOGRAFIA */
    h1, h2, h3, h4, .home-title, .logo-text h1 {
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.02em;
    }

    /* Efeito de Texto Dourado */
    .text-gold, .home-title span, .logo-text h1 {
      background: var(--gold-metallic);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      background-size: 200% auto;
      animation: shine 5s linear infinite;
    }

    @keyframes shine { to { background-position: 200% center; } }

    /* SPA LOGIC */
    .section {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .section.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    /* HEADER */
    .header {
      position: fixed; top: 0; left: 0; width: 100%;
      background: rgba(2, 12, 27, 0.85); /* Levemente mais transparente para ver os beams */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-subtle);
      z-index: 1000;
      padding: 1rem 0;
    }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    
    .logo { display: flex; align-items: center; gap: 1rem; }
    
    .logo-icon {
      width: 50px; height: 50px;
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-solid);
      font-weight: 800;
      font-size: 1.5rem;
      background: transparent;
      overflow: hidden;
    }

    .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .logo-text { display: flex; flex-direction: column; }
    .logo-text h1 { font-size: 1.4rem; line-height: 1; margin: 0; text-transform: uppercase; }
    .logo-text span { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }

    /* LAYOUT */
    .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
    .main { min-height: 100vh; padding: 6rem 0 4rem 0; }

    /* BOTÕES */
    .btn-primary, .form-actions button {
      font-family: 'Manrope', sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      border-radius: 50px;
      position: relative;
      overflow: hidden;
      z-index: 1;
      background: var(--gold-metallic);
      color: #020c1b;
      padding: 1rem 2.5rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(212, 175, 55, 0.2);
      filter: brightness(1.1);
    }

    .back-button {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-subtle);
      padding: 0.6rem 1.2rem;
      display: inline-flex; align-items: center; gap: 0.5rem;
      margin-bottom: 2rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      transition: var(--transition);
    }
    .back-button:hover {
      border-color: var(--gold-solid);
      color: var(--gold-solid);
      background: rgba(212, 175, 55, 0.05);
    }

    /* MENU BUTTONS */
    .menu-container {
        display: flex; flex-direction: column; gap: 1rem;
        width: 100%; max-width: 450px; margin: 0 auto;
    }

    .menu-button {
      display: flex; justify-content: space-between; align-items: center;
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: #fff;
      padding: 1.5rem 2rem;
      border-radius: var(--radius-lg);
      transition: var(--transition);
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(10px);
      font-size: 1.1rem;
    }
    
    .menu-button i { color: var(--gold-solid); font-size: 1.2rem; transition: var(--transition); }
    
    .menu-button:hover {
      border-color: var(--gold-solid);
      background: linear-gradient(90deg, rgba(212, 175, 55, 0.05) 0%, transparent 100%);
      transform: translateX(5px);
    }

    /* CARDS & FORMS */
    .modern-form, .pedido-item, .card, .admin-panel, .pedido-confirmacao-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      padding: 2.5rem;
      border-radius: var(--radius-lg);
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    
    .pedido-item { border-top: 2px solid var(--gold-solid); }

    /* INPUTS */
    .form-group { margin-bottom: 2rem; position: relative; }
    
    .form-group label {
      display: block;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.8rem;
    }

    #formPedido label { color: #FFFFFF !important; }

    input, select, textarea {
      width: 100%;
      background: rgba(17, 34, 64, 0.5) !important;
      border: 1px solid var(--border-subtle) !important;
      border-radius: var(--radius-md) !important;
      color: #fff !important;
      padding: 1rem 1.2rem !important;
      font-family: 'Manrope', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
    }
    
    #formPedido input::placeholder { color: rgba(255, 255, 255, 0.7) !important; opacity: 1; }

    input:focus, select:focus {
      border-color: var(--gold-solid) !important;
      outline: none;
      background: rgba(17, 34, 64, 0.8) !important;
      box-shadow: 0 0 0 1px var(--gold-solid);
    }
    
    /* GRID */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    @media(min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }

    /* RADIO BUTTONS */
    .radio-group { display: flex; gap: 1.5rem; }
    .radio-label {
        display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #fff;
        background: rgba(17, 34, 64, 0.5); padding: 0.8rem 1.5rem; border-radius: 50px;
        border: 1px solid var(--border-subtle); transition: var(--transition);
    }
    .radio-label:hover { background: rgba(17, 34, 64, 0.8); }
    .radio-label input { width: auto !important; margin: 0; accent-color: var(--gold-solid); }

    /* TAMANHOS */
    .tipo-camiseta {
        background: rgba(2, 12, 27, 0.5);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .tipo-camiseta h4 {
        color: var(--gold-solid);
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 1rem;
    }
    
    .tamanhos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 1rem;
    }
    
    .tamanho-item { display: flex; flex-direction: column; align-items: center; }
    .tamanho-item label { margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem; }
    #formPedido .tamanho-item label { color: #FFFFFF !important; }
    .tamanho-item input { text-align: center; padding: 0.8rem !important; font-weight: 700; }

    /* DASHBOARD */
    .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
    
    .card-content h4 { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
    
    #admin-dashboard .card-content h4 { color: #FFFFFF !important; }
    #admin-dashboard .dashboard-details h4 { color: #FFFFFF !important; }
    #admin-dashboard .detail-item span { color: #FFFFFF !important; }
    
    .card-value { font-size: 2.5rem; font-weight: 300; color: #fff; }
    
    /* STATUS BADGES */
    .status-pendente, .status-aprovado, .status-rejeitado {
        font-weight: 700; font-size: 0.7rem; padding: 6px 12px; 
        text-transform: uppercase; border-radius: 50px; display: inline-block;
        letter-spacing: 0.5px;
    }
    .status-pendente { background: rgba(245, 158, 11, 0.1); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.2); }
    .status-aprovado { background: rgba(100, 255, 218, 0.1); color: #64ffda; border: 1px solid rgba(100, 255, 218, 0.2); }
    .status-rejeitado { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }

    /* MODAIS */
    .pedido-confirmacao-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 12, 27, 0.9);
        backdrop-filter: blur(15px);
        z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .pedido-confirmacao-overlay.active { opacity: 1; visibility: visible; }
    
    .pedido-confirmacao-card { width: 95%; max-width: 550px; border: 1px solid var(--gold-solid); }
    
    /* Correção do Número do Pedido saindo do Card */
    #pedidoConfirmacaoNumero {
        word-break: break-all;
        overflow-wrap: break-word;
        white-space: normal;
        font-size: clamp(1.2rem, 4vw, 2rem) !important; 
        line-height: 1.2;
        padding: 0 10px;
    }

    /* IA BUTTON */
    .btn-ai-magic {
        background: transparent !important;
        border: 1px solid var(--border-subtle) !important;
        color: #fff !important;
        width: 100%;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        border-radius: var(--radius-md);
        transition: var(--transition);
    }
    .btn-ai-magic:hover {
        border-color: var(--gold-solid) !important;
        background: rgba(212, 175, 55, 0.05) !important;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.1);
    }
    .btn-ai-magic i { color: var(--gold-solid); }

    /* LOADER */
    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-body); z-index: 3000;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .loading-overlay.active { opacity: 1; visibility: visible; }
    
    .spinner-gold {
        width: 50px; height: 50px; border-radius: 50%;
        border: 2px solid rgba(212, 175, 55, 0.1);
        border-top-color: var(--gold-solid);
        animation: spin 1s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ADMIN MENU */
    .admin-menu {
        display: flex; gap: 2rem; border-bottom: 1px solid var(--border-subtle); margin-bottom: 2rem; overflow-x: auto;
    }
    .admin-menu-btn {
        background: transparent; border: none; color: var(--text-muted);
        padding: 1rem 0; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        transition: var(--transition); border-bottom: 2px solid transparent; white-space: nowrap;
    }
    .admin-menu-btn:hover { color: #fff; }
    .admin-menu-btn.active { color: var(--gold-solid); border-bottom-color: var(--gold-solid); }

    /* =========================================
       MOBILE RESPONSIVENESS
       ========================================= */
    @media (max-width: 480px) {
        .container { padding: 0 16px; }
        .main { padding: 5rem 0 2rem 0; }
        
        /* Header */
        .logo-text h1 { font-size: 1.1rem; }
        .logo-text span { font-size: 0.6rem; }
        .logo-icon { width: 40px; height: 40px; }
        
        /* Home */
        .home-title { font-size: 2.2rem; margin-bottom: 1rem; }
        .menu-button { padding: 1rem; }
        
        /* Forms */
        .modern-form, .card, .admin-panel { padding: 1.5rem; }
        .form-grid { gap: 1rem; }
        .radio-group { flex-direction: column; gap: 0.5rem; }
        .radio-label { width: 100%; justify-content: flex-start; }
        
        /* Tamanhos Grid */
        .tamanhos-grid { grid-template-columns: repeat(3, 1fr); gap: 0.8rem; }
        
        /* Dashboard */
        .dashboard-cards { grid-template-columns: 1fr; gap: 1rem; }
        .admin-menu { gap: 1rem; padding-bottom: 5px; }
        .admin-menu-btn { font-size: 0.8rem; padding: 0.8rem 0; }
        
        /* Tables Scroll */
        .tamanhos-table-container { overflow-x: auto; display: block; width: 100%; }
        .tamanhos-table th, .tamanhos-table td { padding: 0.8rem 0.5rem; font-size: 0.8rem; }
        
        /* Pedidos List */
        .pedido-header-minimized { flex-wrap: wrap; gap: 0.5rem; }
        .pedido-resumo-info { width: 100%; justify-content: space-between; }
        .admin-actions { flex-direction: column; gap: 0.5rem; }
        .admin-actions button { width: 100%; }
        
        /* Financeiro */
        .financeiro-item-row { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        .financeiro-actions { width: 100%; justify-content: space-between; }
        
        /* Modais */
        .pedido-confirmacao-card { width: 95%; margin: 10px; max-height: 90vh; overflow-y: auto; }
    }

    @media (min-width: 481px) {
        .home-title { font-size: clamp(3rem, 6vw, 4.5rem); }
    }

  </style>
</head>
<body>

  <!-- LUXURY BACKGROUND -->
  <div id="beams-container">
      <canvas id="beams-canvas"></canvas>
      <div class="beams-overlay"></div>
  </div>

  <!-- LOADING -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-gold"></div>
    <div id="loadingText" style="margin-top:1.5rem; font-size:0.9rem; letter-spacing:2px; color:var(--text-muted);">CARREGANDO</div>
  </div>

  <!-- MODAL SUCESSO -->
  <div id="pedidoConfirmacaoOverlay" class="pedido-confirmacao-overlay">
    <div class="pedido-confirmacao-card">
      <div style="text-align:center; margin-bottom:2rem;">
        <div style="font-size:3rem; color:var(--gold-solid); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
        <h2 style="font-size:1.8rem;">Pedido Confirmado</h2>
        <p style="color:var(--text-muted); font-size:0.9rem;">Seu pedido foi registrado com sucesso.</p>
      </div>
      
      <div style="background:rgba(255,255,255,0.03); border-radius:var(--radius-md); padding:1.5rem; margin-bottom:2rem; text-align:center; border:1px solid var(--border-subtle);">
          <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.5rem;">ID DO PEDIDO</p>
          <div id="pedidoConfirmacaoNumero" style="color:#fff; font-weight:300; margin-bottom:1rem;"></div>
          <button onclick="const num = document.getElementById('pedidoConfirmacaoNumero').innerText.replace('#',''); window.copiarNumeroPedido(num)" style="background:transparent; border:1px solid var(--border-subtle); color:var(--gold-solid); padding:8px 16px; border-radius:50px; font-size:0.75rem; font-weight:600; cursor:pointer; transition:0.3s;">COPIAR CÓDIGO</button>
      </div>
      
      <div id="pedidoConfirmacaoInfo" style="font-size:0.9rem; color:var(--text-muted); text-align:center; margin-bottom:1rem;"></div>
      <div id="pedidoConfirmacaoTamanhos" style="font-size:0.85rem; color:#888; text-align:center; display:none;"></div>
      
      <button class="btn-primary" id="voltarInicio" style="width:100%;">Retornar ao Início</button>
    </div>
  </div>

  <!-- MODAL CONFIRMAR ALTERAÇÃO VALOR -->
  <div id="modalConfirmarValor" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px;">
          <div style="text-align:center; margin-bottom:2rem;">
              <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-exclamation-triangle"></i></div>
              <h2 style="font-size:1.5rem;">Alterar Preço?</h2>
              <p style="color:var(--text-muted); font-size:0.9rem;">Isso recalculará todos os relatórios.</p>
          </div>
          <div style="display:flex; gap:1rem;">
              <button id="btnCancelarAlteracao" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarAlteracao" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <!-- MODAL RECUPERAR ID -->
  <div id="esqueceuIdOverlay" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card">
          <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
              <h2 style="font-size:1.5rem; margin:0;">Recuperar Acesso</h2>
              <button id="fecharEsqueceuId" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <form id="formEsqueceuId">
              <div class="form-group">
                  <label>E-mail Cadastrado</label>
                  <input type="email" id="emailRecuperacao" required placeholder="exemplo@email.com">
              </div>
              <button type="submit" class="btn-primary" style="width:100%;">Localizar Pedidos</button>
          </form>
          <div id="listaIdsRecuperados" style="margin-top:2rem;"></div>
      </div>
  </div>

  <!-- MODAL IA -->
  <div id="analiseIAOverlay" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:700px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem; align-items:center; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.3rem; margin:0; display:flex; align-items:center; gap:10px;"><i class="fas fa-brain" style="color:var(--gold-solid);"></i> Inteligência Artificial</h2>
              <button id="fecharAnaliseIA" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <div id="resultadoAnaliseIA" style="font-size:0.95rem; color:#ddd; max-height:60vh; overflow-y:auto; line-height:1.8;"></div>
      </div>
  </div>

  <!-- HEADER -->
  <header class="header">
    <div class="container header-content">
      <div class="logo">
        <div class="logo-icon">
          <!-- Adicionado onerror para ocultar imagem quebrada se o 404 ocorrer -->
          <img src="https://raw.githubusercontent.com/mblarson/sistema-pedidos-camisetas/main/50ANOS8080.png" alt="Logo" onerror="this.style.display='none'">
        </div>
        <div class="logo-text">
          <h1>UMADEMATS</h1>
          <span>IGREJA EVANGÉLICA ASSEMBLEIA DE DEUS MS</span>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">
    <div class="container">
      
      <!-- 1. HOME -->
      <section id="home" class="section active">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:75vh; text-align:center;">
            <h1 class="home-title" style="line-height:1.1; margin-bottom:1.5rem;">
                Pedidos de Camisetas <br>
                <span class="text-gold">Jubileu de Ouro</span>
            </h1>
            
            <div class="menu-container">
                <button class="menu-button" id="btnNovoPedido">
                    <span><i class="fas fa-plus-circle" style="margin-right:10px; color:var(--gold-solid);"></i> Realizar Novo Pedido</span> 
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <button class="menu-button" id="btnConsultarPedido">
                    <span><i class="fas fa-search" style="margin-right:10px; color:var(--text-muted);"></i> Consultar Pedido</span> 
                    <i class="fas fa-chevron-right" style="color:var(--text-muted);"></i>
                </button>
                
                <button class="menu-button" id="btnAdministrador">
                    <span><i class="fas fa-shield-alt" style="margin-right:10px; color:var(--text-muted);"></i> Área Administrativa</span> 
                    <i class="fas fa-lock" style="font-size:0.9rem; color:var(--text-muted);"></i>
                </button>
            </div>
        </div>
      </section>

      <!-- 2. CONSULTAR -->
      <section id="consultar" class="section">
        <button class="back-button" id="voltarHomeConsulta"><i class="fas fa-arrow-left"></i> Voltar</button>
        
        <div class="modern-form" style="max-width:600px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:2.5rem;">
                <h2 style="margin-bottom:0.5rem;">Localizar Pedido</h2>
                <p style="color:var(--text-muted);">Informe seus dados para acessar o status.</p>
            </div>
            
            <form id="formConsultarNumero">
                <div class="form-group">
                    <label>Código do Pedido (ID)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="numPedidoConsultaInput" placeholder="Ex: 3Xy9..." required>
                        <button type="submit" class="btn-primary" style="padding:0 1.5rem; border-radius:var(--radius-md);"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </form>
            
            <div style="display:flex; align-items:center; margin:2rem 0; gap:1rem;">
                <div style="height:1px; background:var(--border-subtle); flex:1;"></div>
                <span style="color:var(--text-muted); font-size:0.8rem;">OU</span>
                <div style="height:1px; background:var(--border-subtle); flex:1;"></div>
            </div>

            <form id="formConsultarEmail">
                <div class="form-group">
                    <label>Buscar por E-mail</label>
                    <div style="display:flex; gap:10px;">
                        <input type="email" id="emailConsultaInput" placeholder="seu@email.com" required>
                        <button type="submit" class="btn-primary" style="padding:0 1.5rem; border-radius:var(--radius-md);"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>
            
            <div style="text-align:center; margin-top:2rem;">
                <a id="btnEsqueceuId" style="color:var(--gold-solid); cursor:pointer; font-size:0.85rem; font-weight:600;">Esqueci meu código</a>
            </div>
        </div>
        
        <div id="resultadoConsulta" style="margin-top:2rem;"></div>
        <div id="mensagemConsulta"></div>
      </section>

      <!-- 3. PEDIDO -->
      <section id="pedido" class="section">
        <button class="back-button" id="voltarHome1"><i class="fas fa-arrow-left"></i> Voltar</button>
        
        <div style="max-width:900px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:2rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1.5rem;">
                <div>
                    <h2 id="pedidoTitulo" style="margin-bottom:0.5rem;">Novo Pedido</h2>
                    <p id="pedidoSubtitulo" style="color:var(--text-muted);">Preencha os dados do coordenador responsável.</p>
                </div>
                <div style="color:var(--gold-solid); font-weight:700;">2025 Collection</div>
            </div>

            <form id="formPedido">
                <input type="hidden" id="pedidoDocId" name="docId" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nome">Nome Completo</label>
                        <input type="text" id="nome" name="nome" required placeholder="Nome do Líder">
                    </div>
                    
                    <div class="form-group">
                        <label>Localização</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="local" value="Capital" required id="radioCapital"> Capital
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="local" value="Interior" required id="radioInterior"> Interior
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label id="setorCidadeLabel">Setor / Cidade</label>
                        <div id="setorCidadeContainer">
                            <input type="text" id="setor" name="setor" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">E-mail (Obrigatório)</label>
                        <input type="email" id="email" name="email" required placeholder="Para receber confirmação">
                    </div>
                </div>

                <div style="margin-top:4rem;">
                    <h3 style="text-align:center; color:var(--gold-solid); margin-bottom:2.5rem; text-transform:uppercase; font-size:1.1rem; letter-spacing:2px;">Seleção de Tamanhos</h3>
                    
                    <div class="form-grid">
                        <div class="tipo-camiseta">
                            <h4>Infantil</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>1</label><input type="number" id="infantil_1" name="infantil_1" min="0" value="0"></div>
                                <div class="tamanho-item"><label>2</label><input type="number" id="infantil_2" name="infantil_2" min="0" value="0"></div>
                                <div class="tamanho-item"><label>4</label><input type="number" id="infantil_4" name="infantil_4" min="0" value="0"></div>
                                <div class="tamanho-item"><label>6</label><input type="number" id="infantil_6" name="infantil_6" min="0" value="0"></div>
                                <div class="tamanho-item"><label>8</label><input type="number" id="infantil_8" name="infantil_8" min="0" value="0"></div>
                                <div class="tamanho-item"><label>10</label><input type="number" id="infantil_10" name="infantil_10" min="0" value="0"></div>
                                <div class="tamanho-item"><label>12</label><input type="number" id="infantil_12" name="infantil_12" min="0" value="0"></div>
                                <div class="tamanho-item"><label>14</label><input type="number" id="infantil_14" name="infantil_14" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta">
                            <h4>Babylook</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="babylook_PP" name="babylook_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="babylook_P" name="babylook_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="babylook_M" name="babylook_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="babylook_G" name="babylook_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="babylook_GG" name="babylook_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="babylook_XGG" name="babylook_XGG" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta" style="grid-column: 1 / -1;">
                            <h4>Unissex (Adulto)</h4>
                            <div class="tamanhos-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="unissex_PP" name="unissex_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="unissex_P" name="unissex_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="unissex_M" name="unissex_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="unissex_G" name="unissex_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="unissex_GG" name="unissex_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="unissex_XGG" name="unissex_XGG" min="0" value="0"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:3rem; text-align:center;">
                    <button type="submit" class="btn-primary" style="min-width:250px;">
                        <span id="submitButtonText">Confirmar e Enviar</span>
                    </button>
                </div>
            </form>
            <div id="mensagemPedido"></div>
        </div>
      </section>

      <!-- 4. ADMIN LOGIN -->
      <section id="admin" class="section">
        <button class="back-button" id="voltarHome3"><i class="fas fa-arrow-left"></i> Voltar</button>
        
        <div id="loginAdmin" class="modern-form" style="max-width:450px; margin:3rem auto;">
            <div style="text-align:center; margin-bottom:2rem;">
                <h2 style="margin-bottom:0.5rem;">Acesso Restrito</h2>
                <p style="color:var(--text-muted);">Apenas pessoal autorizado</p>
            </div>
            
            <form id="formLoginAdmin">
                <!-- Alterado para apenas senha, conforme pedido -->
                <div class="form-group">
                    <label>Senha de Administrador</label>
                    <div style="position:relative;">
                        <input type="password" id="senhaAdmin" required style="padding-right:40px !important;">
                        <button type="button" onclick="window.togglePasswordVisibility('senhaAdmin', this.querySelector('i'))" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width:100%; margin-top:1rem;">Entrar no Sistema</button>
            </form>
            <div id="mensagemLogin"></div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="painelAdmin" class="admin-panel" style="display:none; border:none; background:transparent; padding:0; box-shadow:none;">
            
            <div class="admin-menu">
                <button class="admin-menu-btn active" id="btnDashboard" onclick="window.mostrarAdminSecao('dashboard')">Dashboard</button>
                <button class="admin-menu-btn" id="btnPedidos" onclick="window.mostrarAdminSecao('pedidos')">Pedidos</button>
                <button class="admin-menu-btn" id="btnFinanceiro" onclick="window.mostrarAdminSecao('financeiro')">Financeiro</button>
            </div>

            <!-- DASHBOARD -->
            <div id="admin-dashboard" class="admin-section active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h2>Visão Geral</h2>
                    <button id="atualizarDashboard" style="background:transparent; border:1px solid var(--border-subtle); color:var(--text-main); padding:0.5rem 1rem; border-radius:50px; cursor:pointer; display:flex; align-items:center; gap:8px;"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>

                <button class="btn-ai-magic" id="btnAnaliseIA" style="margin-bottom:2rem; padding:1.2rem;">
                    <i class="fas fa-sparkles"></i> Gerar Análise Inteligente de Vendas
                </button>

                <div class="dashboard-cards">
                    <div class="card"><div class="card-content"><h4>Pedidos Totais</h4><p class="card-value" id="totalPedidos">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Camisetas</h4><p class="card-value" id="totalCamisetas">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Pendentes</h4><p class="card-value" id="pedidosPendentes">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Receita (Est.)</h4><p class="card-value text-gold" id="totalArrecadado">R$ 0,00</p></div></div>
                </div>

                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">Métricas por Categoria</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:2rem; text-align:center;">
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Infantil</span><strong style="font-size:1.8rem;" id="totalInfantis">0</strong></div>
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Babylook</span><strong style="font-size:1.8rem;" id="totalBabylook">0</strong></div>
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Unissex</span><strong style="font-size:1.8rem;" id="totalUnissex">0</strong></div>
                    </div>
                </div>
                
                <button class="btn-primary" id="btnVerDetalhes" style="width:100%; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);">Relatório Detalhado de Tamanhos</button>
            </div>

            <!-- DETALHES TAMANHOS -->
            <div id="admin-detalhes-tamanhos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
                    <h2>Matriz de Tamanhos</h2>
                    <button id="voltarDashboard" style="background:none; border:none; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; gap:5px;"><i class="fas fa-arrow-left"></i> Voltar</button>
                </div>
                
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--gold-solid); margin-bottom:1.5rem;">Adultos</h4>
                    <div id="tamanhosAdultoContainer" class="tamanhos-table-container" style="overflow-x:auto;">
                        <table class="tamanhos-table" id="tabelaAdultos" style="width:100%; border-collapse:collapse;">
                            <thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:15px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead>
                            <tbody id="tamanhosAdultoBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--gold-solid); margin-bottom:1.5rem;">Infantil</h4>
                    <div id="tamanhosInfantilContainer" style="overflow-x:auto;">
                        <table class="tamanhos-table" id="tabelaInfantil" style="width:100%; border-collapse:collapse;">
                            <thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:15px; color:var(--text-muted);">TIPO</th><th>1</th><th>2</th><th>4</th><th>6</th><th>8</th><th>10</th><th>12</th><th>14</th></tr></thead>
                            <tbody id="tamanhosInfantilBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div style="display:flex; gap:1rem;">
                    <button class="btn-primary" id="btnGerarPdf" style="flex:1;">Baixar PDF</button>
                    <button id="atualizarDetalhesTamanho" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:#fff; border-radius:50px; cursor:pointer;">Atualizar Dados</button>
                </div>
            </div>

            <!-- FINANCEIRO -->
            <div id="admin-financeiro" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
                    <h2>Financeiro</h2>
                    <button id="atualizarFinanceiro" style="background:none; border:none; color:var(--gold-solid); font-size:1.2rem; cursor:pointer;"><i class="fas fa-sync-alt"></i></button>
                </div>
                
                <div class="card" style="margin-bottom:2rem;">
                    <div style="display:flex; align-items:center; gap:1rem;">
                        <label style="color:var(--text-muted); margin:0;">Valor Unitário (R$)</label>
                        <input type="number" id="valorCamisetaInput" step="0.01" style="width:120px;">
                        <button id="btnSalvarValor" class="btn-primary" type="button" style="padding:0.8rem 1.5rem; font-size:0.8rem; display:flex; justify-content:center; align-items:center;">SALVAR</button>
                    </div>
                </div>

                <div class="card">
                    <h4 style="margin-bottom:1.5rem;">Por Setor / Localidade</h4>
                    <div id="resumoFinanceiroLocais"></div>
                </div>
            </div>

            <!-- LISTA PEDIDOS -->
            <div id="admin-pedidos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
                    <h2>Todos os Pedidos</h2>
                    <button id="atualizarPedidos" style="background:none; border:none; color:var(--gold-solid); font-size:1.2rem; cursor:pointer;"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="listaPedidos"></div>
            </div>

        </div>
      </section>

    </div>
  </main>

  <footer style="text-align:center; padding:3rem 0; border-top:1px solid var(--border-subtle); margin-top:4rem; color:var(--text-muted); font-size:0.8rem;">
    <p>&copy; 2025 UMADEMATS</p>
  </footer>

  <!-- LIBS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <!-- JAVASCRIPT -->
  <script type="module">
    // =================================================================
    // CONFIGURAÇÃO PARA PRODUÇÃO (COLE SUAS CHAVES REAIS AQUI)
    // =================================================================
   const firebaseConfig = {
  apiKey: "AIzaSyDmYkZZ35rc--NPXdhSI0Bo7GzVvtLVFkE",
  authDomain: "pedidosumademats.firebaseapp.com",
  projectId: "pedidosumademats",
  storageBucket: "pedidosumademats.firebasestorage.app",
  messagingSenderId: "604273766416",
  appId: "1:604273766416:web:4813a2365db9ea0e9e1a95"
};
    
    // VOLTANDO PARA SENHA FIXA SIMPLES
    const ADMIN_PASSWORD_FIXA = "umademats";
    let PRECO_CAMISETA = 30.00; // Valor padrão inicial
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    // REMOVIDO SignInWithEmailAndPassword pois o usuário quer o modo simples
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    const pedidosCollection = collection(db, "pedidos");
    const configDocRef = doc(db, "configuracoes", "financeiro");

    let currentPedidoParaEdicao = null;

    // =================================================================
    // IMPLEMENTAÇÃO DO BACKGROUND LUXUOSO (BEAMS)
    // =================================================================
    
    (function initBeamsBackground() {
        const canvas = document.getElementById('beams-canvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        const MINIMUM_BEAMS = 20;
        const intensity = "strong"; // Configuração padrão: strong

        const opacityMap = {
            subtle: 0.7,
            medium: 0.85,
            strong: 1,
        };

        let beams = [];
        let animationFrameId = 0;

        // Função auxiliar para gerar um Beam
        function createBeam(width, height) {
            const angle = -35 + Math.random() * 10;
            return {
                x: Math.random() * width * 1.5 - width * 0.25,
                y: Math.random() * height * 1.5 - height * 0.25,
                width: 30 + Math.random() * 60,
                length: height * 2.5,
                angle: angle,
                speed: 0.6 + Math.random() * 1.2,
                opacity: 0.12 + Math.random() * 0.16,
                hue: 190 + Math.random() * 70, // Mantido a cor original (Azul/Ciano/Roxo) que combina com o tema
                pulse: Math.random() * Math.PI * 2,
                pulseSpeed: 0.02 + Math.random() * 0.03,
            };
        }

        function resetBeam(beam, index, totalBeams) {
            if (!canvas) return beam;
            
            const column = index % 3;
            const spacing = canvas.width / 3;

            beam.y = canvas.height + 100;
            beam.x = column * spacing + spacing / 2 + (Math.random() - 0.5) * spacing * 0.5;
            beam.width = 100 + Math.random() * 100;
            beam.speed = 0.5 + Math.random() * 0.4;
            beam.hue = 190 + (index * 70) / totalBeams;
            beam.opacity = 0.2 + Math.random() * 0.1;
            return beam;
        }

        function drawBeam(ctx, beam) {
            ctx.save();
            ctx.translate(beam.x, beam.y);
            ctx.rotate((beam.angle * Math.PI) / 180);

            // Calculate pulsing opacity
            const pulsingOpacity = beam.opacity * (0.8 + Math.sin(beam.pulse) * 0.2) * opacityMap[intensity];

            const gradient = ctx.createLinearGradient(0, 0, 0, beam.length);

            // Enhanced gradient with multiple color stops
            gradient.addColorStop(0, `hsla(${beam.hue}, 85%, 65%, 0)`);
            gradient.addColorStop(0.1, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`);
            gradient.addColorStop(0.4, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`);
            gradient.addColorStop(0.6, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`);
            gradient.addColorStop(0.9, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`);
            gradient.addColorStop(1, `hsla(${beam.hue}, 85%, 65%, 0)`);

            ctx.fillStyle = gradient;
            ctx.fillRect(-beam.width / 2, 0, beam.width, beam.length);
            ctx.restore();
        }

        function animate() {
            if (!canvas || !ctx) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Nota: o blur já está aplicado via CSS para performance, mas podemos manter o filtro se necessário
            // ctx.filter = "blur(35px)"; // Desativado aqui para usar o filtro CSS que é mais performático em alguns browsers

            const totalBeams = beams.length;
            beams.forEach((beam, index) => {
                beam.y -= beam.speed;
                beam.pulse += beam.pulseSpeed;

                // Reset beam when it goes off screen
                if (beam.y + beam.length < -100) {
                    resetBeam(beam, index, totalBeams);
                }

                drawBeam(ctx, beam);
            });

            animationFrameId = requestAnimationFrame(animate);
        }

        function updateCanvasSize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            // Importante: manter o estilo CSS sincronizado
            // O CSS já cuida do width/height 100%, mas o scale ajuda na nitidez
            ctx.scale(dpr, dpr);

            const totalBeams = MINIMUM_BEAMS * 1.5;
            beams = Array.from({ length: totalBeams }, () => createBeam(canvas.width / dpr, canvas.height / dpr));
        }

        // Inicialização
        updateCanvasSize();
        window.addEventListener("resize", updateCanvasSize);
        animate();

    })();

    // =================================================================
    // FIM BACKGROUND
    // =================================================================

    // MANTEMOS O LOGIN ANÔNIMO APENAS PARA TER UMA CONEXÃO
    const initAuth = async () => {
        try {
            await signInAnonymously(auth);
        } catch (error) {
           // Silencioso se já logado
        }
    };

    // CARREGAMENTO DE DADOS (VERSÃO LIMPA PARA BANCO DE DADOS)
    async function carregarPrecoGlobal() {
        try {
            const docSnap = await getDoc(configDocRef);
            if (docSnap.exists()) {
                PRECO_CAMISETA = parseFloat(docSnap.data().valor_camiseta) || 30.00;
            } else {
                // Tenta criar se não existir
                try { await setDoc(configDocRef, { valor_camiseta: 30.00 }); } catch(e){} 
                PRECO_CAMISETA = 30.00;
            }
            const valInput = document.getElementById('valorCamisetaInput');
            if (valInput) valInput.value = PRECO_CAMISETA.toFixed(2);
        } catch (error) {
            // Se falhar por permissão, o usuário será alertado ao tentar salvar
            console.error("Erro ao carregar preço:", error);
            const valInput = document.getElementById('valorCamisetaInput');
            if (valInput) valInput.value = "30.00";
        }
    }

    // Monitora Auth apenas para carregar o preço inicial
    onAuthStateChanged(auth, (user) => {
        if (user) {
            carregarPrecoGlobal();
        }
    });

    initAuth();

    // GEMINI API CALL
    async function callGemini(promptText, systemInstruction = "") {
        const apiKey = ""; // Chave injetada em tempo de execução
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: promptText }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
        };
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        } catch (error) {
            console.error("Gemini API Error:", error);
            throw error;
        }
    }

    // ANÁLISE IA
    window.handleAnaliseIA = async function() {
        const resultContainer = document.getElementById('resultadoAnaliseIA');
        try {
            const pedidos = await window.carregarTodosPedidos();
            const stats = {
                totalPedidos: pedidos.length,
                totalCamisetas: 0,
                arrecadacaoEstimada: 0,
                distribuicao: { infantil: 0, babylook: 0, unissex: 0 },
                tamanhosTop: {},
                locais: {}
            };
            
            pedidos.forEach(p => {
                const qtdInfantil = Object.values(p.infantil || {}).reduce((a, b) => a + b, 0);
                const qtdBaby = Object.values(p.babylook || {}).reduce((a, b) => a + b, 0);
                const qtdUni = Object.values(p.unissex || {}).reduce((a, b) => a + b, 0);
                
                stats.totalCamisetas += (qtdInfantil + qtdBaby + qtdUni);
                stats.distribuicao.infantil += qtdInfantil;
                stats.distribuicao.babylook += qtdBaby;
                stats.distribuicao.unissex += qtdUni;
                
                const local = p.local || "Desconhecido";
                stats.locais[local] = (stats.locais[local] || 0) + 1;
                
                const mapSizes = (obj, prefix) => {
                    Object.entries(obj || {}).forEach(([k, v]) => {
                        if (v > 0) {
                            const key = `${prefix} ${k}`;
                            stats.tamanhosTop[key] = (stats.tamanhosTop[key] || 0) + v;
                        }
                    });
                };
                mapSizes(p.infantil, 'Infantil');
                mapSizes(p.babylook, 'Babylook');
                mapSizes(p.unissex, 'Unissex');
            });
            
            stats.arrecadacaoEstimada = stats.totalCamisetas * PRECO_CAMISETA;
            const sortedSizes = Object.entries(stats.tamanhosTop).sort(([, a], [, b]) => b - a).slice(0, 5);
            
            const prompt = `Analise estes dados de vendas de camisetas (UMADEMATS): ${JSON.stringify({ ...stats, tamanhosTop: Object.fromEntries(sortedSizes) })}. Gere um relatório curto em Markdown com: 1. 🏆 Campeões de Venda. 2. 💰 Saúde Financeira. 3. 💡 Insight Estratégico.`;
            
            const aiResponse = await callGemini(prompt);
            resultContainer.innerHTML = marked.parse(aiResponse);
        } catch (error) {
            console.error(error);
            resultContainer.innerHTML = `<p style="color: var(--danger-color)">Erro ao analisar dados.</p>`;
        }
    };

    // UTILITÁRIOS
    function getQuantidadesFromForm(formData, prefix) {
        const quantidades = {};
        for (const [key, value] of formData.entries()) {
            if (key.startsWith(prefix + '_')) {
                quantidades[key.split('_')[1]] = parseInt(value) || 0;
            }
        }
        return quantidades;
    }

    window.togglePasswordVisibility = function(inputId, iconElement) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
            iconElement.classList.remove('fa-eye');
            iconElement.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            iconElement.classList.remove('fa-eye-slash');
            iconElement.classList.add('fa-eye');
        }
    };

    function isValidEmail(value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(value);
    }

    function normalizeString(str) {
        if (typeof str !== 'string') return '';
        return str.toUpperCase().trim();
    }

    // NAVEGAÇÃO
    window.mostrarSecao = function(secao) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const secaoElement = document.getElementById(secao);
        if (secaoElement) {
            secaoElement.classList.add('active');
            secaoElement.style.opacity = "";
            secaoElement.style.transform = "";
        }
    };

    window.mostrarAdminSecao = function(secao) {
        document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.admin-menu-btn').forEach(b => {
            b.classList.remove('active');
        });
        
        const secaoElement = document.getElementById(`admin-${secao}`);
        if (secaoElement) secaoElement.style.display = 'block';
        
        const btnId = secao === 'dashboard' ? 'btnDashboard' : secao === 'pedidos' ? 'btnPedidos' : 'btnFinanceiro';
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.add('active');
        
        if (secao === 'dashboard') window.carregarDashboard();
        else if (secao === 'pedidos') window.carregarPedidos();
        else if (secao === 'financeiro') window.carregarDetalhesFinanceiros();
    };

    window.redirecionarComAnimacao = function(secao, callback) {
        const elementoAtual = document.querySelector('.section.active');
        const proximoElemento = document.getElementById(secao);
        
        if (!elementoAtual || !proximoElemento || elementoAtual === proximoElemento) {
            window.mostrarSecao(secao);
            if (callback) callback();
            return;
        }
        
        elementoAtual.style.opacity = '0';
        elementoAtual.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            window.mostrarSecao(secao);
            if (callback) callback();
            
            proximoElemento.style.opacity = '0';
            proximoElemento.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                proximoElemento.style.opacity = '1';
                proximoElemento.style.transform = 'translateY(0)';
            }, 50);
        }, 400);
    };

    window.exibirMensagem = function(elementoId, tipo, mensagem) {
        const elemento = document.getElementById(elementoId);
        if (!elemento) return;
        
        const color = tipo === 'sucesso' ? 'var(--success-color)' : 'var(--danger-color)';
        elemento.innerHTML = `<div style="padding:1rem; margin-top:1rem; border-radius:var(--radius-md); background:rgba(255,255,255,0.05); border-left:4px solid ${color}; color:#fff; font-size:0.9rem; box-shadow:0 5px 15px rgba(0,0,0,0.2);"><i class="fas fa-${tipo === 'sucesso' ? 'check-circle' : 'exclamation-circle'}" style="color:${color}; margin-right:8px;"></i> ${mensagem}</div>`;
        
        setTimeout(() => {
            elemento.innerHTML = '';
        }, 5000);
    };

    window.mostrarCarregamento = function(mostrar = true, texto = 'PROCESSANDO...') {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        loadingText.textContent = texto;
        if (mostrar) loadingOverlay.classList.add('active');
        else loadingOverlay.classList.remove('active');
    };

    window.atualizarElemento = function(elementId, valor) {
        const elemento = document.getElementById(elementId);
        if (elemento) elemento.textContent = valor;
    };

    window.fecharConfirmacaoPedido = function() {
        document.getElementById('pedidoConfirmacaoOverlay').classList.remove('active');
        window.mostrarSecao('home');
    };

    window.copiarNumeroPedido = function(numPedido) {
        // Define fallback function
        const fallbackCopy = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) alert('CÓDIGO COPIADO!');
                else alert('Erro ao copiar.');
            } catch (err) {
                alert('Erro ao copiar.');
            }
            document.body.removeChild(textArea);
        };

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(numPedido).then(() => {
                alert('CÓDIGO COPIADO!');
            }).catch(err => {
                console.warn("Clipboard API failed, trying fallback...", err);
                fallbackCopy(numPedido);
            });
        } else {
            fallbackCopy(numPedido);
        }
    };

    window.exibirConfirmacaoPedido = function(pedido) {
        const overlay = document.getElementById('pedidoConfirmacaoOverlay');
        document.getElementById('pedidoConfirmacaoNumero').innerHTML = `#${pedido.numPedido}`;
        document.getElementById('pedidoConfirmacaoInfo').innerHTML = `<p><strong>NOME:</strong> ${pedido.nome}</p><p><strong>LOCAL:</strong> ${pedido.local} / ${pedido.setor}</p>`;
        
        const listaTamanhos = (obj) => Object.entries(obj).filter(([k, v]) => v > 0).map(([k, v]) => `${k}: ${v}`).join(', ');
        
        document.getElementById('pedidoConfirmacaoTamanhos').innerHTML = `<p>INFANTIL: ${listaTamanhos(pedido.infantil)}</p><p>BABYLOOK: ${listaTamanhos(pedido.babylook)}</p><p>UNISSEX: ${listaTamanhos(pedido.unissex)}</p>`;
        overlay.classList.add('active');
    };

    // OTIMIZADO: Se der erro de permissão, ele FINGE QUE SALVOU para não travar o Admin
    window.recalcularValores = async function(novoValorString) {
        const novoValor = parseFloat(novoValorString);
        
        if (isNaN(novoValor) || novoValor <= 0) {
            alert("Por favor, insira um valor válido maior que zero.");
            return;
        }
        
        window.mostrarCarregamento(true, "SALVANDO CONFIG...");
        
        // ATUALIZAÇÃO OTIMISTA (Muda na memória sempre)
        PRECO_CAMISETA = novoValor;
        
        try {
            // Tenta salvar no banco (pode falhar se for anônimo)
            await setDoc(configDocRef, { valor_camiseta: novoValor }, { merge: true });
        } catch (error) {
            alert("ATENÇÃO: Erro ao salvar no banco! Verifique as regras do Firebase.");
            console.error("Erro de permissão:", error);
        }

        // RECALCULA OS VALORES NA TELA
        try {
            const pedidos = await window.carregarTodosPedidos();
            let totalItens = 0;
            pedidos.forEach(p => {
                totalItens += Object.values(p.infantil || {}).reduce((a,b)=>a+b,0) +
                              Object.values(p.babylook || {}).reduce((a,b)=>a+b,0) +
                              Object.values(p.unissex || {}).reduce((a,b)=>a+b,0);
            });
            
            const novoTotal = totalItens * PRECO_CAMISETA;
            
            await window.carregarDashboard();
            await window.carregarDetalhesFinanceiros();
            
            window.mostrarCarregamento(false);
            // Mensagem de Sucesso
            alert(`SUCESSO!\n\nNovo Preço Unitário: R$ ${PRECO_CAMISETA.toFixed(2)}\nTotal de Camisetas Encontradas: ${totalItens}\nNovo Valor Arrecadado Total: R$ ${novoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`);
            
        } catch (error) {
            window.mostrarCarregamento(false);
            alert("Erro ao recalcular: " + error.message);
        }
    };

    // PDF GENERATION
    window.gerarRelatorioPdf = function() {
        window.mostrarCarregamento(true, 'GERANDO PDF...');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        
        doc.setFontSize(16);
        doc.text("RELATÓRIO UMADEMATS", 148.5, 20, null, null, "center");
        doc.setFontSize(10);
        doc.text(`Data: ${dataAtual}`, 10, 25);
        
        const addTableToPdf = (tableId, startY, title) => {
            const tableElement = document.getElementById(tableId);
            if (!tableElement || tableElement.rows.length <= 1) return startY;
            
            doc.setFontSize(12);
            doc.text(title, 14, startY - 2);
            
            const head = Array.from(tableElement.querySelector('thead tr').children).map(th => th.textContent);
            let body = [];
            Array.from(tableElement.querySelector('tbody').rows).forEach(row => {
                body.push(Array.from(row.children).map(td => td.textContent));
            });
            
            doc.autoTable({
                head: [head],
                body: body,
                startY: startY,
                theme: 'grid'
            });
            return doc.lastAutoTable.finalY + 15;
        };
        
        let nextY = 35;
        nextY = addTableToPdf('tabelaAdultos', nextY, "Adultos");
        addTableToPdf('tabelaInfantil', nextY, "Infantil");
        
        doc.save(`Relatorio_${dataAtual.replace('/', '-')}.pdf`);
        window.mostrarCarregamento(false);
    };

    // FIREBASE QUERIES
    window.verificarPedidoPorEmail = async function(email) {
        try {
            const q = query(pedidosCollection, where("email", "==", email.toLowerCase().trim()));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) return { docId: snapshot.docs[0].id, ...snapshot.docs[0].data() };
            return null;
        } catch (error) {
            return null;
        }
    };

    window.recuperarIdsPorEmail = async function(e) {
        e.preventDefault();
        const email = document.getElementById('emailRecuperacao').value.toLowerCase().trim();
        window.mostrarCarregamento(true);
        
        try {
            const q = query(pedidosCollection, where("email", "==", email));
            const snapshot = await getDocs(q);
            const container = document.getElementById('listaIdsRecuperados');
            
            if (snapshot.empty) {
                container.innerHTML = `<p style="color:var(--danger-color)">NENHUM PEDIDO ENCONTRADO</p>`;
            } else {
                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    html += `<div style="background:rgba(255,255,255,0.05); padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:4px;"><span>#${d.numPedido}</span><button onclick="window.copiarNumeroPedido('${d.numPedido}')" style="cursor:pointer; background:none; border:none; color:var(--gold-solid); font-size:0.8rem; font-weight:600;">COPIAR</button></div>`;
                });
                container.innerHTML = html;
            }
        } catch (error) {
            console.error(error);
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    window.verificarPedidoPorSetor = async function(setor) {
        try {
            const q = query(pedidosCollection, where("setor", "==", normalizeString(setor)));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) return { docId: snapshot.docs[0].id, ...snapshot.docs[0].data() };
            return null;
        } catch (error) {
            return null;
        }
    };

    window.verificarPedidoPorNumero = async function(numPedido) {
        try {
            const docRef = doc(db, "pedidos", numPedido.trim());
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return { docId: docSnap.id, numPedido: docSnap.data().numPedido || docSnap.id, ...docSnap.data() };
            }
            
            const q = query(pedidosCollection, where("numPedido", "==", numPedido.trim()));
            const qs = await getDocs(q);
            if (!qs.empty) return { docId: qs.docs[0].id, ...qs.docs[0].data() };
            
            return null;
        } catch (error) {
            return null;
        }
    };

    // FORM LOGIC
    window.updateSetorCidadeInput = function(val = '') {
        const container = document.getElementById('setorCidadeContainer');
        const radioCapital = document.getElementById('radioCapital');
        
        if (!container || !radioCapital) return;

        const isCapital = radioCapital.checked;
        if (isCapital) {
            const setores = ['A', 'B', 'C1', 'C2', 'D', 'E', 'F', 'G', 'H', 'I', 'M', 'N'];
            container.innerHTML = `<select id="setor" name="setor" required><option value="" disabled selected>SELECIONE</option>${setores.map(s => `<option value="SETOR ${s}">SETOR ${s}</option>`).join('')}</select>`;
            const sel = document.getElementById('setor');
            if (val && Array.from(sel.options).some(o => o.value === normalizeString(val))) sel.value = normalizeString(val);
        } else {
            container.innerHTML = `<input type="text" id="setor" name="setor" placeholder="CIDADE" required value="${val}">`;
        }
    };

    window.setupNovoPedido = function() {
        currentPedidoParaEdicao = null;
        const docIdEl = document.getElementById('pedidoDocId');
        const formEl = document.getElementById('formPedido');
        const btnTextEl = document.getElementById('submitButtonText');

        if (docIdEl) docIdEl.value = '';
        if (formEl) formEl.reset();
        if (btnTextEl) btnTextEl.textContent = 'Confirmar e Enviar';

        const radioCapital = document.querySelector('input[name="local"][value="Capital"]');
        if (radioCapital) radioCapital.checked = true;
        window.updateSetorCidadeInput();
    };

    window.setupEdicaoPedido = function() {
        const pedido = currentPedidoParaEdicao;
        if (!pedido) return;
        
        document.getElementById('pedidoDocId').value = pedido.docId;
        document.getElementById('nome').value = pedido.nome;
        
        const radioLocal = document.querySelector(`input[name="local"][value="${pedido.local}"]`);
        if (radioLocal) radioLocal.checked = true;
        
        window.updateSetorCidadeInput(pedido.setor);
        document.getElementById('email').value = pedido.email;
        
        const preencher = (tamanhos, prefix) => {
            for (const [t, q] of Object.entries(tamanhos || {})) {
                const input = document.getElementById(`${prefix}_${t}`);
                if (input) input.value = q;
            }
        };
        
        preencher(pedido.infantil, 'infantil');
        preencher(pedido.babylook, 'babylook');
        preencher(pedido.unissex, 'unissex');
        
        document.getElementById('submitButtonText').textContent = 'Atualizar Pedido';
        window.redirecionarComAnimacao('pedido');
    };

    window.displayVisualizacaoPedido = function(pedido) {
        currentPedidoParaEdicao = pedido;
        const total = Object.values(pedido.infantil || {}).reduce((a, b) => a + b, 0) + 
                      Object.values(pedido.babylook || {}).reduce((a, b) => a + b, 0) + 
                      Object.values(pedido.unissex || {}).reduce((a, b) => a + b, 0);
        
        const html = `<div class="pedido-item">
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem; margin-bottom:1rem; align-items:center;">
                            <span style="color:var(--gold-solid); font-size:1.2rem; font-weight:700;">#${pedido.numPedido}</span>
                            <span class="status-${pedido.status.toLowerCase()}">${pedido.status}</span>
                        </div>
                        <div style="display:grid; gap:0.5rem; color:var(--text-muted); font-size:0.9rem;">
                            <p>NOME: <span style="color:#fff">${pedido.nome}</span></p>
                            <p>LOCAL: <span style="color:#fff">${pedido.local} - ${pedido.setor}</span></p>
                            <p>TOTAL PEÇAS: <span style="color:#fff">${total}</span></p>
                            <p>VALOR TOTAL: <span style="color:var(--gold-solid); font-weight:700;">R$ ${(total * PRECO_CAMISETA).toFixed(2)}</span></p>
                        </div>
                        <button id="btnIniciarEdicao" class="btn-primary" style="width:100%; margin-top:2rem; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid); box-shadow:none;">Editar Pedido</button>
                      </div>`;
                      
        document.getElementById('resultadoConsulta').innerHTML = html;
        const btnEdit = document.getElementById('btnIniciarEdicao');
        if (btnEdit) btnEdit.addEventListener('click', window.setupEdicaoPedido);
    };

    window.handleFormSubmission = async function(e) {
        e.preventDefault();
        const docId = document.getElementById('pedidoDocId').value;
        const isEditing = !!docId;
        const formData = new FormData(document.getElementById('formPedido'));
        const email = formData.get('email').toLowerCase().trim();
        const setor = normalizeString(formData.get('setor'));
        
        if (!isValidEmail(email)) {
            window.exibirMensagem('mensagemPedido', 'erro', 'E-MAIL INVÁLIDO');
            return;
        }
        
        if (!isEditing) {
            const dup = await window.verificarPedidoPorEmail(email);
            if (dup) {
                window.exibirMensagem('mensagemPedido', 'erro', 'E-MAIL JÁ TEM PEDIDO');
                return;
            }
        }
        
        const setorOriginal = currentPedidoParaEdicao ? normalizeString(currentPedidoParaEdicao.setor) : null;
        if (!isEditing || setor !== setorOriginal) {
            const dupSetor = await window.verificarPedidoPorSetor(setor);
            if (dupSetor && (isEditing ? dupSetor.docId !== docId : true)) {
                window.exibirMensagem('mensagemPedido', 'erro', 'SETOR JÁ TEM PEDIDO');
                return;
            }
        }
        
        const total = Array.from(document.getElementById('formPedido').querySelectorAll('input[type="number"]')).reduce((sum, i) => sum + (parseInt(i.value) || 0), 0);
        if (total === 0) {
            window.exibirMensagem('mensagemPedido', 'erro', 'ADICIONE PELO MENOS 1 CAMISETA');
            return;
        }
        
        window.mostrarCarregamento(true);
        try {
            const data = {
                data: new Date().toISOString(),
                nome: formData.get('nome'),
                local: formData.get('local'),
                setor: setor,
                email: email,
                infantil: getQuantidadesFromForm(formData, 'infantil'),
                babylook: getQuantidadesFromForm(formData, 'babylook'),
                unissex: getQuantidadesFromForm(formData, 'unissex'),
                status: 'Pendente'
            };
            
            let finalNum = '';
            if (isEditing) {
                await updateDoc(doc(db, "pedidos", docId), data);
                finalNum = currentPedidoParaEdicao.numPedido;
            } else {
                const ref = doc(pedidosCollection);
                data.numPedido = ref.id;
                await setDoc(ref, data);
                finalNum = ref.id;
            }
            
            const pedidoConfirmado = { numPedido: finalNum, ...data };
            window.exibirConfirmacaoPedido(pedidoConfirmado);
            document.getElementById('formPedido').reset();
        } catch (err) {
            window.exibirMensagem('mensagemPedido', 'erro', 'ERRO AO SALVAR');
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    // VOLTANDO PARA A VERIFICAÇÃO DE SENHA SIMPLES
    window.handleAdminLogin = function(e) {
        e.preventDefault();
        // Verifica a senha FIXA definida no início do código
        if (document.getElementById('senhaAdmin').value === ADMIN_PASSWORD_FIXA) {
            document.getElementById('loginAdmin').style.display = 'none';
            document.getElementById('painelAdmin').style.display = 'block';
            window.carregarDashboard();
        } else {
            alert('SENHA INCORRETA');
        }
    };

    window.carregarTodosPedidos = async function() {
        const s = await getDocs(pedidosCollection);
        return s.docs.map(d => ({ docId: d.id, ...d.data() }));
    };

    window.carregarDashboard = async function() {
        window.mostrarCarregamento(true);
        try {
            const p = await window.carregarTodosPedidos();
            let tP = p.length, tC = 0, pend = 0, inf = 0, baby = 0, uni = 0;
            
            p.forEach(x => {
                const i = Object.values(x.infantil || {}).reduce((a, b) => a + b, 0);
                const b = Object.values(x.babylook || {}).reduce((a, b) => a + b, 0);
                const u = Object.values(x.unissex || {}).reduce((a, b) => a + b, 0);
                
                tC += i + b + u;
                inf += i;
                baby += b;
                uni += u;
                if (x.status === 'Pendente') pend++;
            });
            
            window.atualizarElemento('totalPedidos', tP);
            window.atualizarElemento('totalCamisetas', tC);
            window.atualizarElemento('pedidosPendentes', pend);
            
            const totalVal = tC * PRECO_CAMISETA;
            // CORREÇÃO AQUI: Forçar exibição de casas decimais
            window.atualizarElemento('totalArrecadado', totalVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 }));

            window.atualizarElemento('totalInfantis', inf);
            window.atualizarElemento('totalBabylook', baby);
            window.atualizarElemento('totalUnissex', uni);
        } catch (e) {
            // Erro silencioso
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    window.carregarPedidos = async function() {
        window.mostrarCarregamento(true);
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '';
        
        const p = await window.carregarTodosPedidos();
        p.sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(x => {
            const t = Object.values(x.infantil || {}).reduce((a, b) => a + b, 0) + 
                      Object.values(x.babylook || {}).reduce((a, b) => a + b, 0) + 
                      Object.values(x.unissex || {}).reduce((a, b) => a + b, 0);
            
            lista.innerHTML += `<div class="pedido-item" style="margin-bottom:1rem;">
                                    <div style="display:flex; flex-direction:column; align-items:flex-start; border-bottom:1px solid var(--border-subtle); padding-bottom:5px; margin-bottom:10px;">
                                        <span style="color:var(--gold-solid); font-weight:700; font-size:1.1rem;">#${x.numPedido}</span>
                                        <span class="status-${x.status.toLowerCase()}" style="margin-top: 5px;">${x.status}</span>
                                    </div>
                                    <div style="font-size:0.85rem; color:var(--text-muted);">
                                        <p><strong style="color:#fff">${x.nome}</strong> (${x.local} - ${x.setor})</p>
                                        <p>TOTAL: ${t} CAMISETAS | R$ ${(t * PRECO_CAMISETA).toFixed(2)}</p>
                                    </div>
                                    <div style="margin-top:15px; display:flex; gap:10px;">
                                        <button onclick="window.atualizarStatusPedido('${x.docId}','Aprovado')" style="flex:1; background:none; border:1px solid var(--success-color); color:var(--success-color); padding:6px; cursor:pointer; font-size:0.7rem; border-radius:4px; font-weight:600;">APROVAR</button>
                                        <button onclick="window.atualizarStatusPedido('${x.docId}','Rejeitado')" style="flex:1; background:none; border:1px solid var(--danger-color); color:var(--danger-color); padding:6px; cursor:pointer; font-size:0.7rem; border-radius:4px; font-weight:600;">REJEITAR</button>
                                    </div>
                                </div>`;
        });
        window.mostrarCarregamento(false);
    };

    window.atualizarStatusPedido = async function(id, status) {
        if (confirm('CONFIRMA AÇÃO?')) {
            window.mostrarCarregamento(true);
            await updateDoc(doc(db, "pedidos", id), { status });
            window.carregarPedidos();
        }
    };

    window.carregarDetalhesTamanho = async function() {
        window.mostrarCarregamento(true);
        const p = await window.carregarTodosPedidos();
        const sizesA = ['PP', 'P', 'M', 'G', 'GG', 'XGG'];
        const sizesI = ['1', '2', '4', '6', '8', '10', '12', '14'];
        let adultCounts = { babylook: {}, unissex: {} };
        let infCounts = {};
        
        sizesA.forEach(s => {
            adultCounts.babylook[s] = 0;
            adultCounts.unissex[s] = 0;
        });
        sizesI.forEach(s => infCounts[s] = 0);
        
        p.forEach(x => {
            Object.entries(x.babylook || {}).forEach(([k, v]) => adultCounts.babylook[k] += v);
            Object.entries(x.unissex || {}).forEach(([k, v]) => adultCounts.unissex[k] += v);
            Object.entries(x.infantil || {}).forEach(([k, v]) => infCounts[k] += v);
        });
        
        let hA = '';
        ['babylook', 'unissex'].forEach(t => {
            hA += `<tr><td style="padding:12px; border-bottom:1px solid var(--border-subtle); text-transform:uppercase; font-weight:600;">${t}</td>${sizesA.map(s => `<td style="padding:12px; border-bottom:1px solid var(--border-subtle); text-align:center; color:var(--text-muted);">${adultCounts[t][s]}</td>`).join('')}</tr>`;
        });
        
        let hI = `<tr><td style="padding:12px; border-bottom:1px solid var(--border-subtle); font-weight:600;">Geral</td>${sizesI.map(s => `<td style="padding:12px; border-bottom:1px solid var(--border-subtle); text-align:center; color:var(--text-muted);">${infCounts[s]}</td>`).join('')}</tr>`;
        
        document.getElementById('tamanhosAdultoBody').innerHTML = hA;
        document.getElementById('tamanhosInfantilBody').innerHTML = hI;
        window.mostrarCarregamento(false);
    };

    window.togglePagamento = function(id, btn) {
        const el = document.getElementById(`status-${id}`);
        if (el) {
            el.innerText = "PAGO";
            el.style.color = "var(--success-color)";
        }
        btn.disabled = true;
        btn.style.opacity = "0.5";
    };

    window.carregarDetalhesFinanceiros = async function() {
        window.mostrarCarregamento(true);
        const p = await window.carregarTodosPedidos();
        const res = {};
        
        p.forEach(x => {
            const k = `${x.local} / ${x.setor}`;
            const t = Object.values(x.infantil || {}).reduce((a, b) => a + b, 0) + 
                      Object.values(x.babylook || {}).reduce((a, b) => a + b, 0) + 
                      Object.values(x.unissex || {}).reduce((a, b) => a + b, 0);
            
            if (!res[k]) res[k] = { qtd: 0, val: 0 };
            res[k].qtd += t;
            res[k].val += t * PRECO_CAMISETA;
        });
        
        let h = '';
        Object.keys(res).sort().forEach((k, i) => {
            h += `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(255,255,255,0.02); margin-bottom:8px; border-radius:4px; border:1px solid var(--border-subtle);">
                    <div>
                        <strong style="color:#fff; font-size:0.9rem;">${k}</strong><br>
                        <span style="font-size:0.8rem; color:var(--text-muted);">${res[k].qtd} PÇS - <span style="color:var(--gold-solid);">R$ ${res[k].val.toFixed(2)}</span></span>
                    </div>
                    <div style="text-align:right;">
                        <span id="status-fin-${i}" style="font-size:0.7rem; color:var(--warning-color); display:block; margin-bottom:5px; font-weight:600;">PENDENTE</span>
                        <button onclick="window.togglePagamento('fin-${i}', this)" style="background:var(--success-color); border:none; color:#fff; padding:4px 10px; font-size:0.7rem; cursor:pointer; border-radius:50px; font-weight:600;">PAGO</button>
                    </div>
                  </div>`;
        });
        
        document.getElementById('resumoFinanceiroLocais').innerHTML = h || '<p style="text-align:center; color:var(--text-muted);">SEM DADOS</p>';
        window.mostrarCarregamento(false);
    };

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        const safeOnClick = (id, handler) => { const el = document.getElementById(id); if(el) el.onclick = handler; };
        const safeOnSubmit = (id, handler) => { const el = document.getElementById(id); if(el) el.onsubmit = handler; };
        const safeOnChange = (id, handler) => { const el = document.getElementById(id); if(el) el.onchange = handler; };

        safeOnClick('btnNovoPedido', () => {
            window.setupNovoPedido();
            window.redirecionarComAnimacao('pedido');
        });
        safeOnClick('btnConsultarPedido', () => {
            window.redirecionarComAnimacao('consultar');
        });
        safeOnClick('btnAdministrador', () => {
            window.redirecionarComAnimacao('admin');
        });
        
        safeOnClick('voltarHome1', () => window.redirecionarComAnimacao('home'));
        safeOnClick('voltarHomeConsulta', () => window.redirecionarComAnimacao('home'));
        safeOnClick('voltarHome3', () => window.redirecionarComAnimacao('home'));
        
        safeOnClick('fecharConfirmacaoPedido', window.fecharConfirmacaoPedido);
        safeOnClick('voltarInicio', window.fecharConfirmacaoPedido);
        
        safeOnClick('btnEsqueceuId', () => document.getElementById('esqueceuIdOverlay').classList.add('active'));
        safeOnClick('fecharEsqueceuId', () => document.getElementById('esqueceuIdOverlay').classList.remove('active'));
        
        safeOnClick('btnAnaliseIA', () => {
            document.getElementById('analiseIAOverlay').classList.add('active');
            window.handleAnaliseIA();
        });
        safeOnClick('fecharAnaliseIA', () => document.getElementById('analiseIAOverlay').classList.remove('active'));
        
        safeOnSubmit('formLoginAdmin', window.handleAdminLogin);
        safeOnSubmit('formPedido', window.handleFormSubmission);
        
        safeOnSubmit('formConsultarNumero', async (e) => {
            e.preventDefault();
            const v = document.getElementById('numPedidoConsultaInput').value;
            window.mostrarCarregamento(true);
            const p = await window.verificarPedidoPorNumero(v);
            window.mostrarCarregamento(false);
            if (p) window.displayVisualizacaoPedido(p);
            else alert('PEDIDO NÃO ENCONTRADO');
        });
        
        safeOnSubmit('formConsultarEmail', async (e) => {
            e.preventDefault();
            const v = document.getElementById('emailConsultaInput').value;
            window.mostrarCarregamento(true);
            const p = await window.verificarPedidoPorEmail(v);
            window.mostrarCarregamento(false);
            if (p) window.displayVisualizacaoPedido(p);
            else alert('PEDIDO NÃO ENCONTRADO');
        });
        
        safeOnSubmit('formEsqueceuId', window.recuperarIdsPorEmail);
        
        safeOnClick('atualizarDashboard', window.carregarDashboard);
        safeOnClick('atualizarPedidos', window.carregarPedidos);
        safeOnClick('atualizarFinanceiro', window.carregarDetalhesFinanceiros);
        
        safeOnClick('btnVerDetalhes', () => {
            window.mostrarAdminSecao('detalhes-tamanhos');
            window.carregarDetalhesTamanho();
        });
        safeOnClick('voltarDashboard', () => window.mostrarAdminSecao('dashboard'));
        safeOnClick('atualizarDetalhesTamanho', window.carregarDetalhesTamanho);
        safeOnClick('btnGerarPdf', window.gerarRelatorioPdf);
        
        safeOnClick('btnSalvarValor', () => {
            document.getElementById('modalConfirmarValor').classList.add('active');
        });
        
        safeOnClick('btnCancelarAlteracao', () => {
            document.getElementById('modalConfirmarValor').classList.remove('active');
        });
        
        safeOnClick('btnConfirmarAlteracao', () => {
            document.getElementById('modalConfirmarValor').classList.remove('active');
            const val = document.getElementById('valorCamisetaInput').value;
            window.recalcularValores(val);
        });
        
        safeOnChange('radioCapital', () => window.updateSetorCidadeInput());
        safeOnChange('radioInterior', () => window.updateSetorCidadeInput());
        
        window.updateSetorCidadeInput();
        // A carga inicial do preço agora está dentro da função carregarPrecoGlobal
        carregarPrecoGlobal(); 
    });
  </script>
</body>
</html>
