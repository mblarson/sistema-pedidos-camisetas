<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMADEMATS | Premium Access</title>
  <link rel="icon" href="data:,">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* =========================================
       ESTÉTICA "AUDAX NAVY & GOLD"
       ========================================= */

    :root {
      /* GRADIENTE DOURADO METÁLICO (GOLD FOIL) */
      --gold-metallic: linear-gradient(135deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5f7 75%, #aa771c 100%);
      --gold-solid: #d4af37;
      
      /* NOVAS CORES DE CAMISETAS */
      --shirt-verde: #556B2F;   /* Verde Oliva */
      --shirt-terracota: #c05838; /* Terracota */

      /* FUNDOS - NOVA PALETA AZUL MARINHO */
      --bg-body: #020c1b;         /* Azul Quase Preto */
      --bg-surface: #0a192f;      /* Azul Marinho Profundo */
      --bg-card: rgba(10, 25, 47, 0.7); /* Glass Azulado */
      
      /* BORDAS & DETALHES */
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-gold: rgba(212, 175, 55, 0.3);
      
      /* TEXTO */
      --text-main: #e6f1ff;       /* Branco levemente azulado para conforto */
      --text-muted: #8892b0;      /* Cinza azulado */
      
      /* VARIÁVEIS DE COMPATIBILIDADE JS */
      --primary-color: #d4af37;
      --primary-dark: #b38728;
      --success-color: #64ffda; /* Verde Neon Suave */
      --warning-color: #ffd700;
      --danger-color: #ff6b6b;
      
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 16px;
      
      --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Manrope', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* =========================================
       BACKGROUND LUXUOSO (BEAMS)
       ========================================= */
    #beams-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; overflow: hidden; background-color: var(--bg-body); pointer-events: none;
    }
    #beams-canvas {
        position: absolute; inset: 0; width: 100%; height: 100%; filter: blur(15px);
    }
    .beams-overlay {
        position: absolute; inset: 0; background-color: rgba(2, 12, 27, 0.05);
        z-index: 1; backdrop-filter: blur(50px); animation: pulseOverlay 10s ease-in-out infinite;
    }
    @keyframes pulseOverlay {
        0% { opacity: 0.05; } 15% { opacity: 0.15; } 50% { opacity: 0.05; } 100% { opacity: 0.05; }
    }

    /* TIPOGRAFIA */
    h1, h2, h3, h4, .home-title, .logo-text h1 { font-weight: 700; color: #fff; letter-spacing: -0.02em; }
    .text-gold, .home-title span, .logo-text h1 {
      background: var(--gold-metallic); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; background-size: 200% auto; animation: shine 5s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    /* SPA LOGIC */
    .section { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    /* HEADER */
    .header {
      position: fixed; top: 0; left: 0; width: 100%;
      background: rgba(2, 12, 27, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-subtle); z-index: 1000; padding: 1rem 0;
    }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; gap: 1rem; }
    .logo-icon {
      width: 50px; height: 50px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-solid); font-weight: 800; font-size: 1.5rem; background: transparent; overflow: hidden;
    }
    .logo-icon img { width: 100%; height: 100%; object-fit: contain; }
    .logo-text { display: flex; flex-direction: column; }
    .logo-text h1 { font-size: 1.4rem; line-height: 1; margin: 0; text-transform: uppercase; }
    .logo-text span { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }

    /* LAYOUT */
    .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
    .main { min-height: 100vh; padding: 6rem 0 4rem 0; }

    /* BOTÕES */
    .btn-primary, .form-actions button {
      font-family: 'Manrope', sans-serif; font-weight: 700; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;
      border: none; cursor: pointer; transition: var(--transition); border-radius: 50px; position: relative; overflow: hidden; z-index: 1;
      background: var(--gold-metallic); color: #020c1b; padding: 1rem 2.5rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(212, 175, 55, 0.2); filter: brightness(1.1); }
    .back-button {
      background: transparent; color: var(--text-muted); border: 1px solid var(--border-subtle); padding: 0.6rem 1.2rem;
      display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem; border-radius: 50px;
      font-size: 0.8rem; font-weight: 600; transition: var(--transition);
    }
    .back-button:hover { border-color: var(--gold-solid); color: var(--gold-solid); background: rgba(212, 175, 55, 0.05); }

    /* MENU BUTTONS */
    .menu-container { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 450px; margin: 0 auto; }
    .menu-button {
      display: flex; justify-content: space-between; align-items: center; width: 100%;
      background: var(--bg-card); border: 1px solid var(--border-subtle); color: #fff;
      padding: 1.5rem 2rem; border-radius: var(--radius-lg); transition: var(--transition);
      font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); font-size: 1.1rem;
    }
    .menu-button i { color: var(--gold-solid); font-size: 1.2rem; transition: var(--transition); }
    .menu-button:hover { border-color: var(--gold-solid); background: linear-gradient(90deg, rgba(212, 175, 55, 0.05) 0%, transparent 100%); transform: translateX(5px); }

    /* CARDS & FORMS */
    .modern-form, .pedido-item, .card, .admin-panel, .pedido-confirmacao-card {
      background: var(--bg-card); border: 1px solid var(--border-subtle); padding: 2.5rem;
      border-radius: var(--radius-lg); backdrop-filter: blur(20px); box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .pedido-item { border-top: 2px solid var(--gold-solid); }

    /* INPUTS */
    .form-group { margin-bottom: 2rem; position: relative; }
    .form-group label { display: block; color: var(--text-muted); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.8rem; }
    #formPedido label { color: #FFFFFF !important; }
    input, select, textarea {
      width: 100%; background: rgba(17, 34, 64, 0.5) !important; border: 1px solid var(--border-subtle) !important;
      border-radius: var(--radius-md) !important; color: #fff !important; padding: 1rem 1.2rem !important;
      font-family: 'Manrope', sans-serif; font-size: 1rem; transition: var(--transition);
    }
    #formPedido input::placeholder { color: rgba(255, 255, 255, 0.7) !important; opacity: 1; }
    input:focus, select:focus { border-color: var(--gold-solid) !important; outline: none; background: rgba(17, 34, 64, 0.8) !important; box-shadow: 0 0 0 1px var(--gold-solid); }

    /* REMOVENDO SETAS DOS INPUTS NUMBER */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
    }

    /* GRID */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    @media(min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }

    /* RADIO BUTTONS */
    .radio-group { display: flex; gap: 1.5rem; }
    .radio-label {
        display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #fff;
        background: rgba(17, 34, 64, 0.5); padding: 0.8rem 1.5rem; border-radius: 50px;
        border: 1px solid var(--border-subtle); transition: var(--transition);
    }
    .radio-label:hover { background: rgba(17, 34, 64, 0.8); }
    .radio-label input { 
        width: auto !important; 
        margin: 0; 
        accent-color: var(--gold-solid); 
        width: 16px; 
        height: 16px;
    }

    /* ESTILOS DE FILTRO E BUSCA */
    .search-container { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
    .filter-container { display: flex; gap: 1.0rem; align-items: center; flex-wrap: wrap; }
    .filter-radio { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; }
    .filter-radio input { 
        width: auto !important; 
        margin: 0; 
        accent-color: var(--gold-solid); 
        width: 16px; 
        height: 16px;
    }
    .filter-radio input:checked + span { color: var(--gold-solid); font-weight: 600; }
    
    /* TAMANHOS E CORES (NOVO) */
    .tipo-camiseta {
        background: rgba(2, 12, 27, 0.5); border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg); padding: 2rem; margin-bottom: 2rem;
    }
    .tipo-camiseta h4 {
        color: var(--gold-solid); margin-bottom: 1.5rem; font-size: 1.1rem;
        text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 1rem;
    }
    .tamanhos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1rem; }
    .tamanho-item { display: flex; flex-direction: column; align-items: center; }
    .tamanho-item label { margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem; }
    #formPedido .tamanho-item label { color: #FFFFFF !important; }
    .tamanho-item input { text-align: center; padding: 0.8rem !important; font-weight: 700; }

    /* HEADER DAS CORES */
    .cor-header {
        display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;
        padding: 1rem; background: rgba(255,255,255,0.03); border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
    }
    .cor-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); }

    /* DASHBOARD */
    .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
    .card-content h4 { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
    #admin-dashboard .card-content h4, #admin-dashboard .dashboard-details h4, #admin-dashboard .detail-item span { color: #FFFFFF !important; }
    
    .card-value { font-size: clamp(1.3rem, 2vw, 1.7rem); font-weight: 200; color: #fff; white-space: nowrap; } 
    
    .pedido-card-expandable { cursor: pointer; transition: background 0.3s ease; }
    .pedido-card-expandable:hover { background: rgba(255, 255, 255, 0.05); }
    .pedido-details-content { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .tabela-detalhe-pedido { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 1rem; color: #ddd; }
    .tabela-detalhe-pedido th, .tabela-detalhe-pedido td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: left; }
    .tabela-detalhe-pedido th { color: var(--gold-solid); font-weight: 600; text-transform: uppercase; }

    /* MODAIS */
    .pedido-confirmacao-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 12, 27, 0.9); backdrop-filter: blur(15px); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .pedido-confirmacao-overlay.active { opacity: 1; visibility: visible; }
    .pedido-confirmacao-card { width: 95%; max-width: 550px; border: 1px solid var(--gold-solid); max-height: 90vh; overflow-y: auto; }
    
    #pedidoConfirmacaoNumero {
        word-break: break-all; overflow-wrap: break-word; white-space: normal;
        font-size: clamp(1.2rem, 4vw, 2rem) !important; line-height: 1.2; padding: 0 10px;
    }

    /* IA BUTTON */
    .btn-ai-magic {
        background: transparent !important; border: 1px solid var(--border-subtle) !important; color: #fff !important;
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
        border-radius: var(--radius-md); transition: var(--transition);
    }
    .btn-ai-magic:hover {
        border-color: var(--gold-solid) !important; background: rgba(212, 175, 55, 0.05) !important;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.1);
    }
    .btn-ai-magic i { color: var(--gold-solid); }

    /* LOADER */
    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-body); z-index: 3000;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .loading-overlay.active { opacity: 1; visibility: visible; }
    .spinner-gold {
        width: 50px; height: 50px; border-radius: 50%;
        border: 2px solid rgba(212, 175, 55, 0.1); border-top-color: var(--gold-solid);
        animation: spin 1s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ADMIN MENU */
    .admin-menu { display: flex; gap: 2rem; border-bottom: 1px solid var(--border-subtle); margin-bottom: 2rem; overflow-x: auto; }
    .admin-menu-btn {
        background: transparent; border: none; color: var(--text-muted);
        padding: 1rem 0; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        transition: var(--transition); border-bottom: 2px solid transparent; white-space: nowrap;
    }
    .admin-menu-btn:hover { color: #fff; }
    .admin-menu-btn.active { color: var(--gold-solid); border-bottom-color: var(--gold-solid); }

    /* ESTILO PARA TABELA DE LIQUIDAÇÕES */
    .hist-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.85rem; }
    .hist-table th, .hist-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
    .hist-table th { color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; }
    .hist-table td { color: #fff; }

    /* ESTILOS ESPECÍFICOS PARA OS BOTÕES DO MODAL DE DETALHES (Regra 4) */
    #modalDetalhesPedido .modal-actions {
        display: flex; gap: 1rem; margin-top: 2rem; 
        /* Envolve os botões para garantir que fiquem lado a lado */
    }
    #modalDetalhesPedido .modal-actions button {
        flex: 1; /* Distribui o espaço igualmente */
        padding: 0.7rem 1.2rem; /* Reduz o padding */
        font-size: 0.75rem; /* Reduz o tamanho da fonte */
        letter-spacing: 0.5px; /* Ajusta o espaçamento entre letras */
        border-radius: 50px;
    }
    /* Estilo específico para o botão de fechar para manter a consistência */
    #modalDetalhesPedido button:not(.btn-primary) {
        background: transparent; 
        border: 1px solid var(--border-subtle); 
        color: var(--text-muted); 
        cursor: pointer;
        transition: var(--transition);
    }
    #modalDetalhesPedido button:not(.btn-primary):hover {
        border-color: var(--gold-solid); 
        color: var(--gold-solid); 
    }
    
    /* =========================================
       TELA INICIAL MOBILE (SPLASH SCREEN)
       ========================================= */
    #mobileSplashScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-body);
        z-index: 4000; 
        justify-content: center;
        align-items: center;
        flex-direction: column;
        overflow: hidden;
        
        /* Controle de visibilidade via classe JS */
        display: none; 
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }
    
    #mobileSplashScreen.active {
        opacity: 1;
        visibility: visible;
        display: flex; 
    }

    #splashVideo {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translate(-50%, -50%);
        z-index: 1;
        object-fit: cover; 
        filter: brightness(0.5); 
    }

    /* Reposicionamento e centralização do conteúdo (botão/loader) */
    #splashContent {
        position: fixed; 
        bottom: 60px; /* SUBINDO BOTÃO PARA 60PX DO FUNDO */
        left: 0;
        right: 0;
        z-index: 2;
        text-align: center;
        width: 100%;
        padding: 0 20px; /* Adiciona padding lateral para os textos */
    }

    /* Estilos para o bloco de texto (NOVO LAYOUT) */
    #splashTextContainer {
        position: fixed;
        bottom: 140px; /* SUBINDO TEXTO PARA 140PX DO FUNDO */
        left: 0;
        right: 0;
        z-index: 2;
        text-align: left; /* Alinhamento conforme imagem */
        padding: 0 40px; /* Espaçamento lateral */
        color: #fff;
    }
    #splashTitle {
        font-family: 'Manrope', sans-serif;
        font-size: 2.2rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 0.5rem;
    }
    #splashSubtitle {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.4;
    }


    /* =========================================
       NOVOS ESTILOS DO BOTÃO E LOADER
       ========================================= */

    /* ESTILO NOVO DO BOTÃO (Dourado Metálico) */
    .button {
        width: 250px; 
        height: 50px; 
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        
        /* CORREÇÃO AQUI: USANDO GRADIENTE DOURADO */
        background: var(--gold-metallic); 
        
        border-radius: 30px;
        color: #020c1b; /* Texto na cor do fundo para contraste */
        font-weight: 700;
        border: none;
        position: relative;
        cursor: pointer;
        transition-duration: .2s;
        box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
        padding: 0 16px; 
        transition-duration: .5s;
        margin: 0 auto; /* Centraliza o botão */
    }
    .button .text {
        font-family: 'Manrope', sans-serif; 
        font-size: 0.95rem; 
        letter-spacing: 1px;
    }
    .svgIcon {
        height: 25px;
        transition-duration: 1.5s;
        display: none; 
    }
    .bell path {
        fill: rgb(19, 19, 19);
    }
    .button:hover {
        background-color: var(--gold-solid); /* Dourado sólido no hover */
        transition-duration: .5s;
        transform: translateY(-2px); /* Efeito do btn-primary */
        box-shadow: 0 7px 15px rgba(212, 175, 55, 0.4);
    }
    .button:active {
        transform: scale(0.97);
        transition-duration: .2s;
    }
    .button:hover .svgIcon {
        transform: rotate(250deg);
        transition-duration: 1.5s;
    }

    /* ESTILO NOVO DO LOADER (EXATO DO USUÁRIO) - AJUSTADO PARA SER RELATIVO AO splashContent */
    .loader {
      position: absolute; 
      top: 5px; 
      left: 50%;
      transform: translateX(-50%);
      animation: speeder 0.4s linear infinite;
      display: none; 
      width: 150px; 
      height: 50px;
      margin: 0; 
    }
    .loader.active {
      display: block;
    }
    /* Ajustando as posições internas para centralizar o loader */
    .loader > span {
      height: 5px;
      width: 35px;
      background: #fff; /* Alterado para branco para contraste */
      position: absolute;
      top: 15px; 
      left: 50%;
      margin-left: -50px;
      border-radius: 2px 10px 1px 0;
    }
    .base {
        position: relative; 
    }
    .base span {
      position: absolute;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-right: 100px solid #fff; 
      border-bottom: 6px solid transparent;
      left: -50px;
      top: 25px;
    }
    .base span:before {
      content: "";
      height: 22px;
      width: 22px;
      border-radius: 50%;
      background: #fff; 
      position: absolute;
      right: -110px;
      top: -16px;
    }
    .base span:after {
      content: "";
      position: absolute;
      width: 0;
      height: 0;
      border-top: 0 solid transparent;
      border-right: 55px solid #fff; 
      border-bottom: 16px solid transparent;
      top: -16px;
      right: -98px;
    }
    .face {
      position: absolute;
      height: 12px;
      width: 20px;
      background: #fff; 
      border-radius: 20px 20px 0 0;
      transform: rotate(-40deg);
      right: -125px;
      top: -15px;
    }
    .face:after {
      content: "";
      height: 12px;
      width: 12px;
      background: #fff; 
      right: 4px;
      top: 7px;
      position: absolute;
      transform: rotate(40deg);
      transform-origin: 50% 50%;
      border-radius: 0 0 0 2px;
    }
    .loader > span > span:nth-child(1),.loader > span > span:nth-child(2),.loader > span > span:nth-child(3),.loader > span > span:nth-child(4) {
      width: 30px;
      height: 1px;
      background: #fff; 
      position: absolute;
      animation: fazer1 0.2s linear infinite;
    }
    .loader > span > span:nth-child(2) {
      top: 3px;
      animation: fazer2 0.4s linear infinite;
    }
    .loader > span > span:nth-child(3) {
      top: 1px;
      animation: fazer3 0.4s linear infinite;
      animation-delay: -1s;
    }
    .loader > span > span:nth-child(4) {
      top: 4px;
      animation: fazer4 1s linear infinite;
      animation-delay: -1s;
    }
    @keyframes fazer1 {
      0% { left: 0; }
      100% { left: -80px; opacity: 0; }
    }
    @keyframes fazer2 {
      0% { left: 0; }
      100% { left: -100px; opacity: 0; }
    }
    @keyframes fazer3 {
      0% { left: 0; }
      100% { left: -50px; opacity: 0; }
    }
    @keyframes fazer4 {
      0% { left: 0; }
      100% { left: -150px; opacity: 0; }
    }
    @keyframes speeder {
      0% { transform: translate(2px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -3px) rotate(-1deg); }
      20% { transform: translate(-2px, 0px) rotate(1deg); }
      30% { transform: translate(1px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 3px) rotate(-1deg); }
      60% { transform: translate(-1px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-2px, -1px) rotate(1deg); }
      90% { transform: translate(2px, 1px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .longfazers {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    .longfazers span {
      position: absolute;
      height: 2px;
      width: 20%;
      background: #fff; 
    }
    .longfazers span:nth-child(1) {
      top: 20%;
      animation: lf 0.6s linear infinite;
      animation-delay: -5s;
    }
    .longfazers span:nth-child(2) {
      top: 40%;
      animation: lf2 0.8s linear infinite;
      animation-delay: -1s;
    }
    .longfazers span:nth-child(3) {
      top: 60%;
      animation: lf3 0.6s linear infinite;
    }
    .longfazers span:nth-child(4) {
      top: 80%;
      animation: lf4 0.5s linear infinite;
      animation-delay: -3s;
    }
    @keyframes lf {
      0% { left: 200%; }
      100% { left: -200%; opacity: 0; }
    }
    @keyframes lf2 {
      0% { left: 200%; }
      100% { left: -200%; opacity: 0; }
    }
    @keyframes lf3 {
      0% { left: 200%; }
      100% { left: -100%; opacity: 0; }
    }
    @keyframes lf4 {
      0% { left: 200%; }
      100% { left: -100%; opacity: 0; }
    }

    /* =========================================
       MOBILE RESPONSIVENESS
       ========================================= */
    
    /* PERFORMANCE OPTIMIZATION - ESTÁTICO EM CELULARES */
    @media (max-width: 768px) {
        #beams-canvas { display: none !important; }
        #beams-container { background: radial-gradient(circle at top, #0a192f 0%, #020c1b 100%); }
    }

    @media (max-width: 767px) {
        /* Garante que o splash screen esteja escondido no desktop */
        #mobileSplashScreen:not(.active) {
            display: none !important;
        }
    }
    
    @media (max-width: 480px) {
        /* *** AJUSTES PARA MELHORAR O FILTRO EM TELAS PEQUENAS (SOLICITAÇÃO DO USUÁRIO) *** */
        
        /* Reduz o espaçamento e garante que caiba em uma linha */
        .filter-container { 
            display: flex; /* Garante que os itens fiquem lado a lado */
            justify-content: flex-start; 
            gap: 0.2rem; /* Reduz o gap entre os elementos */
            flex-wrap: nowrap; 
            overflow-x: auto; 
            padding-bottom: 5px; 
            padding-right: 5px;
        }

        /* Reduz o tamanho do rádio e o padding do rótulo para economizar espaço */
        .filter-radio {
             /* Reduz o padding para diminuir a largura total do elemento */
             padding: 0.2rem 0.4rem; /* Redução mais agressiva no padding */
             font-size: 0.75rem; 
             white-space: nowrap; 
        }
        
        /* Reduz o tamanho da bolinha do radio button para o mobile */
        .filter-radio input { 
            width: 12px !important; /* Tamanho final ajustado (12px) */
            height: 12px !important; 
            margin-right: 0.1rem; /* Redução máxima na margem interna do rádio */
        }

        .filter-container > span {
             white-space: nowrap; 
             margin-right: 0.1rem; 
             font-size: 0.75rem; 
        }
        
        /* Layout Geral (mantido e ajustado) */
        .container { padding: 0 16px; }
        .main { padding: 5rem 0 2rem 0; }
        .logo-text h1 { font-size: 1.1rem; }
        .logo-text span { font-size: 0.6rem; }
        .logo-icon { width: 40px; height: 40px; }
        .home-title { font-size: 2.2rem; margin-bottom: 1rem; }
        .menu-button { padding: 1rem; }
        .modern-form, .card, .admin-panel { padding: 1.5rem; }
        .form-grid { gap: 1rem; }
        .radio-group { flex-direction: column; gap: 0.5rem; }
        .radio-label { width: 100%; justify-content: flex-start; }
        .tamanhos-grid { grid-template-columns: repeat(3, 1fr); gap: 0.8rem; }
        .dashboard-cards { grid-template-columns: 1fr; gap: 1rem; }
        .admin-menu { gap: 1rem; padding-bottom: 5px; }
        /* AJUSTE 2: Reduz a fonte e padding do menu do ADMIN no mobile */
        .admin-menu-btn { font-size: 1rem; padding: 0.6rem 0; } 
        .tamanhos-table-container { overflow-x: auto; display: block; width: 100%; margin-bottom: 1rem; }
        .tamanhos-table th, .tamanhos-table td { padding: 0.8rem 0.5rem; font-size: 0.8rem; }
        .pedido-header-minimized { flex-wrap: wrap; gap: 0.5rem; }
        .pedido-resumo-info { width: 100%; justify-content: space-between; }
        .admin-actions { flex-direction: column; gap: 0.5rem; }
        .admin-actions button { width: 100%; }
        .financeiro-item-row { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        .financeiro-actions { width: 100%; justify-content: space-between; }
        .pedido-confirmacao-card { width: 95%; margin: 10px; max-height: 90vh; overflow-y: auto; }
        
        /* Garantir que os botões do modalDetalhesPedido fiquem em coluna no mobile */
        #modalDetalhesPedido .modal-actions {
            flex-direction: column;
        }
        #modalDetalhesPedido .modal-actions button {
            padding: 0.8rem 1.2rem; /* Aumenta um pouco para ser melhor de tocar */
            font-size: 0.85rem;
        }

        /* REFINAMENTO VISUAL DO MODAL DE DETALHES (MOBILE) */
        #modalDetalhesPedido .pedido-confirmacao-card {
            width: 92% !important; /* Margem segura */
            margin: 0 auto !important;
            padding: 1.2rem !important; /* Padding reduzido */
            max-height: 85vh;
            border-radius: 12px; /* Curva mais suave */
            overflow-x: hidden !important;
        }

        /* Títulos e Textos */
        #modalDetalhesPedido h2 {
            font-size: 1.1rem !important;
            margin-bottom: 0.8rem !important;
        }
        
        #modalDetalhesPedido p, 
        #modalDetalhesPedido span,
        #modalDetalhesPedido label {
            font-size: 0.8rem !important; /* Fonte menor e mais delicada */
        }
        
        #modalDetalhesPedido .form-group label {
            font-size: 0.7rem !important;
        }

        /* Tabelas Compactas */
        #modalDetalhesPedido table {
            font-size: 0.75rem !important;
        }
        #modalDetalhesPedido table th, 
        #modalDetalhesPedido table td {
            padding: 4px 8px !important; /* Células mais apertadas */
        }

        /* Botões Compactos */
        #modalDetalhesPedido .modal-actions {
            display: flex !important;
            flex-direction: row !important; /* Força lado a lado */
            gap: 8px !important;
            margin-top: 1.5rem !important;
        }
        
        #modalDetalhesPedido .modal-actions button {
            padding: 8px 10px !important; /* Redução drástica de padding */
            font-size: 0.7rem !important; /* Fonte pequena */
            letter-spacing: 0.5px !important;
            height: auto !important;
            border-radius: 50px !important;
            flex: 1; /* Distribui igual */
            white-space: nowrap; /* Evita quebra de linha feia */
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2 !important;
            min-height: 35px !important;
        }
        
        /* Ajuste de ícones nos botões */
        #modalDetalhesPedido .modal-actions button i {
            font-size: 0.7rem !important;
            margin-right: 4px !important;
        }
        
        #modalDetalhesPedido button:not(.btn-primary) {
             font-size: 0.75rem !important;
        }
    }
    @media (min-width: 481px) { .home-title { font-size: clamp(3rem, 6vw, 4.5rem); } }
  </style>
</head>
<body>

  <!-- TELA INICIAL EXCLUSIVA PARA MOBILE -->
  <div id="mobileSplashScreen">
    <video id="splashVideo" autoplay loop muted playsinline>
        <source src="https://raw.githubusercontent.com/mblarson/sistema-pedidos-camisetas/main/aberturasite.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
    </video>
    
    <!-- NOVO BLOCO DE TEXTO -->
    <div id="splashTextContainer">
        <h1 id="splashTitle">PEDIDOS DE CAMISETA</h1>
        <p id="splashSubtitle">Registre aqui os pedidos de camisetas para o Jubileu de Ouro da UMADEMATS</p>
    </div>
    
    <div id="splashContent">
        <!-- BOTÃO ACESSAR SISTEMA (NOVO ESTILO) -->
        <button id="btnAcessarSistema" class="button" onclick="window.handleAccessAndLoading()">
          <!-- Oculta o ícone SVG e centraliza o texto -->
          <span class="text">ACESSAR O SISTEMA</span>
        </button>

        <!-- LOADER OCULTO -->
        <div id="splashLoader" class="loader">
            <span>
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </span>
            <div class="base">
              <span></span>
              <div class="face"></div>
            </div>
            <div class="longfazers">
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </div>
        </div>
    </div>
  </div>
  <!-- FIM TELA INICIAL MOBILE -->

  <div id="beams-container"><canvas id="beams-canvas"></canvas><div class="beams-overlay"></div></div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-gold"></div>
    <div id="loadingText" style="margin-top:1.5rem; font-size:0.9rem; letter-spacing:2px; color:var(--text-muted);">CARREGANDO</div>
  </div>
  
  <!-- MODAL DE EXCLUSÃO DE PEDIDO -->
  <div id="modalExcluirPedido" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-trash-alt"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Excluir Pedido?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Tem certeza que deseja excluir este pedido? Essa ação não poderá ser desfeita.</p>
          <input type="hidden" id="excluirPedidoDocId">
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalExcluirPedido').classList.remove('active')" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarExclusao" class="btn-primary" onclick="window.excluirPedido()" style="flex:1; background:var(--danger-color); color:#fff;">Excluir Pedido</button>
          </div>
      </div>
  </div>

  <!-- MODAL DE ENCERRAMENTO DE EVENTO -->
  <div id="modalEncerrarEvento" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:500px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-exclamation-triangle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Encerrar Evento?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem; font-weight:700;">NÃO SE ESQUEÇA DE GERAR OS RELATÓRIOS ANTES DE ENCERRAR.</p>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Tem certeza que deseja ENCERRAR o evento? Todos os pedidos serão removidos do sistema.</p>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalEncerrarEvento').classList.remove('active')" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarEncerrarEvento" class="btn-primary" onclick="window.acaoEncerrarEvento()" style="flex:1; background:var(--danger-color); color:#fff;">Encerrar Evento</button>
          </div>
      </div>
  </div>

  <div id="modalLiquidacao" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width: 500px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.4rem; margin:0;">Liquidar Pagamento</h2>
              <button onclick="document.getElementById('modalLiquidacao').classList.remove('active')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;"><i class="fas fa-times"></i></button>
          </div>
          
          <input type="hidden" id="liquidacaoDocId">
          
          <div class="form-group">
              <label>Valor Pago</label>
              <input type="text" id="valorLiquidacao" placeholder="R$ 0,00" inputmode="numeric" oninput="window.formatarMoedaInput(this)">
          </div>
          
          <div class="form-group">
              <label>Data do Recebimento</label>
              <input type="text" id="dataLiquidacao" placeholder="DD/MM/AAAA" maxlength="10">
          </div>

          <button id="btnConfirmarLiquidacao" class="btn-primary" style="width:100%; margin-bottom:1rem;">CONFIRMAR PAGAMENTO</button>
          
          <div id="historicoLiquidacoesContainer" style="display:none; margin-top:2rem; padding-top:1rem; border-top:1px solid var(--border-subtle);">
              <h3 style="color:var(--text-muted); font-size:0.9rem; text-transform:uppercase; margin-bottom:1rem;">Histórico de Pagamentos</h3>
              <table class="hist-table">
                  <thead><tr><th>Data</th><th>Valor</th></tr></thead>
                  <tbody id="listaHistoricoLiquidacoes"></tbody>
              </table>
              <div style="margin-top:1.5rem; text-align:right;">
                   <button id="btnCancelarLiquidacao" onclick="window.cancelarUltimaLiquidacao()" style="background:transparent; border:1px solid var(--danger-color); color:var(--danger-color); padding:8px 16px; border-radius:50px; font-size:0.8rem; cursor:pointer;">CANCELAR ÚLTIMA LIQUIDAÇÃO</button>
              </div>
          </div>
      </div>
  </div>
  
  <!-- NOVO MODAL DE FEEDBACK DE ATUALIZAÇÃO (Regra 2) -->
  <div id="modalFeedbackSucesso" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">TELA ATUALIZADA</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">As métricas foram recarregadas com sucesso.</p>
          <button onclick="document.getElementById('modalFeedbackSucesso').classList.remove('active')" class="btn-primary" style="width:100%;">OK</button>
      </div>
  </div>

  <!-- MODAL DE SUCESSO PARA LIQUIDAÇÃO (Mantido do passo anterior) -->
  <div id="modalSucessoLiquidacao" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Pagamento Registrado!</h2>
          <!-- Chamada para carregarPagamentos() ao clicar em OK (Regra 2) -->
          <p id="msgSucessoLiquidacao" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">O valor foi salvo e a lista será atualizada.</p>
          <button onclick="document.getElementById('modalSucessoLiquidacao').classList.remove('active');" class="btn-primary" style="width:100%;">OK</button>
      </div>
  </div>
  
  <!-- NOVO MODAL DE CANCELAMENTO DE LIQUIDAÇÃO (Regra 1) -->
  <div id="modalSucessoCancelamento" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-undo-alt"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Cancelamento Concluído</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">A quitação foi cancelada com sucesso. A lista será atualizada.</p>
          <!-- CORREÇÃO: Atualização imediata ao clicar em OK -->
          <button onclick="document.getElementById('modalSucessoCancelamento').classList.remove('active');" class="btn-primary" style="width:100%;">OK</button>
      </div>
  </div>


  <div id="modalDetalhesPedido" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.4rem; margin:0;">Detalhes do Pedido</h2>
              <button onclick="document.getElementById('modalDetalhesPedido').classList.remove('active')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;"><i class="fas fa-times"></i></button>
          </div>
          <div id="conteudoDetalhesPedido">
              </div>
          
          <!-- Botões ajustados para caberem lado a lado (Regra 2, 4) -->
          <div class="modal-actions">
              <button onclick="document.getElementById('modalDetalhesPedido').classList.remove('active')" style="flex:1;">Fechar</button>
              <button id="btnBaixarNoModal" class="btn-primary" type="button" style="flex:1; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);"><i class="fas fa-download"></i> BAIXAR PEDIDO</button>
              <!-- BOTÃO DE EDIÇÃO GARANTIDO NO HTML ESTÁTICO (Regra 2) -->
              <button id="btnEditarNoModal" class="btn-primary" style="flex:1;"><i class="fas fa-edit"></i> EDITAR PEDIDO</button>
          </div>
      </div>
  </div>

  <!-- NOVO MODAL DE ERRO DE PDF -->
  <div id="modalErroPDF" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center; border:1px solid var(--danger-color);">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-exclamation-triangle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Erro na Geração</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Não foi possível gerar o PDF. Tente novamente.</p>
          <button onclick="document.getElementById('modalErroPDF').classList.remove('active')" class="btn-primary" style="width:100%;">Entendido</button>
      </div>
  </div>

  <div id="pedidoConfirmacaoOverlay" class="pedido-confirmacao-overlay">
    <div class="pedido-confirmacao-card">
      <div style="text-align:center; margin-bottom:2rem;">
        <div style="font-size:3rem; color:var(--gold-solid); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
        <h2 style="font-size:1.8rem;">Pedido Confirmado</h2>
        <p style="color:var(--text-muted); font-size:0.9rem;">Seu pedido foi registrado com sucesso.</p>
      </div>
      <div style="background:rgba(255,255,255,0.03); border-radius:var(--radius-md); padding:1.5rem; margin-bottom:2rem; text-align:center; border:1px solid var(--border-subtle);">
          <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.5rem;">ID DO PEDIDO</p>
          <div id="pedidoConfirmacaoNumero" style="color:#fff; font-weight:300; margin-bottom:1rem;"></div>
          <button onclick="const num = document.getElementById('pedidoConfirmacaoNumero').innerText.replace('#',''); window.copiarNumeroPedido(num)" style="background:transparent; border:1px solid var(--border-subtle); color:var(--gold-solid); padding:8px 16px; border-radius:50px; font-size:0.75rem; font-weight:600; cursor:pointer; transition:0.3s;">COPIAR CÓDIGO</button>
      </div>
      <div id="pedidoConfirmacaoInfo" style="font-size:0.9rem; color:var(--text-muted); text-align:center; margin-bottom:1rem;"></div>
      <div id="pedidoConfirmacaoTamanhos" style="font-size:0.85rem; color:#888; text-align:center; display:none;"></div>
      <button class="btn-primary" id="voltarInicio" style="width:100%;" onclick="window.fecharConfirmacaoPedido()">Retornar ao Início</button>
    </div>
  </div>

  <div id="modalSucessoFinanceiro" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Valor Atualizado!</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">O preço foi alterado e os totais recalculados.</p>
          <div style="background:rgba(255,255,255,0.03); border-radius:var(--radius-md); padding:1.5rem; margin-bottom:2rem; border:1px solid var(--border-subtle);">
              <div style="margin-bottom:1rem;">
                  <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.3rem;">Novo Valor Unitário</p>
                  <p id="confirmacaoNovoValor" style="font-size:1.5rem; color:var(--gold-solid); font-weight:700;">R$ 0,00</p>
              </div>
              <div>
                  <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.3rem;">Novo Total Arrecadado</p>
                  <p id="confirmacaoNovoTotal" style="font-size:1.2rem; color:#fff;">R$ 0,00</p>
              </div>
          </div>
          <button onclick="document.getElementById('modalSucessoFinanceiro').classList.remove('active')" class="btn-primary" style="width:100%;">Fechar</button>
      </div>
  </div>

  <div id="modalErroLogin" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-times-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Acesso Negado</h2>
          <p id="msgErroLogin" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">E-mail ou senha incorretos.</p>
          <button onclick="document.getElementById('modalErroLogin').classList.remove('active')" class="btn-primary" style="width:100%; background:transparent; border:1px solid var(--danger-color); color:var(--danger-color);">Tentar Novamente</button>
      </div>
  </div>

  <div id="modalFecharPedidos" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-lock"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Fechar Pedidos?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Tem certeza que deseja FECHAR os pedidos? Insira a senha para confirmar.</p>
          <div class="form-group" style="margin-bottom:1.5rem;">
              <input type="password" id="senhaFecharPedidos" placeholder="Senha de Confirmação" style="text-align:center;">
          </div>
          <div id="msgErroSenhaFechar" style="color:var(--danger-color); font-size:0.8rem; margin-bottom:1rem; display:none;">SENHA INCORRETA</div>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalFecharPedidos').classList.remove('active'); document.getElementById('senhaFecharPedidos').value='';" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button onclick="window.confirmarFechamentoPedidos()" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="modalReabrirPedidos" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-lock-open"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Reabrir Pedidos?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Deseja realmente reabrir os pedidos?</p>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalReabrirPedidos').classList.remove('active')" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button onclick="window.confirmarReaberturaPedidos()" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="modalPedidosFechados" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-store-slash"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Pedidos Fechados</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Os pedidos estão temporariamente fechados.</p>
          <button onclick="document.getElementById('modalPedidosFechados').classList.remove('active')" class="btn-primary" style="width:100%;">Entendido</button>
      </div>
  </div>

  <div id="modalSenhaValor" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-lock"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Segurança Necessária</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Esta ação recalcula todos os relatórios. Digite a senha para confirmar.</p>
          <div class="form-group" style="margin-bottom:1.5rem;">
              <input type="password" id="senhaAlterarValor" placeholder="Senha de Confirmação" style="text-align:center;">
          </div>
          <div id="msgErroSenhaValor" style="color:var(--danger-color); font-size:0.8rem; margin-bottom:1rem; display:none;">SENHA INCORRETA</div>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalSenhaValor').classList.remove('active'); document.getElementById('senhaAlterarValor').value='';" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarSenhaValor" onclick="window.confirmarAlteracaoValorComSenha()" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="esqueceuIdOverlay" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card">
          <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
              <h2 style="font-size:1.5rem; margin:0;">Recuperar Acesso</h2>
              <button id="fecharEsqueceuId" onclick="window.mostrarSecao('consultar')" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <form id="formEsqueceuId" onclick="window.recuperarIdsPorEmail(event)">
              <div class="form-group">
                  <label>E-mail Cadastrado</label>
                  <input type="email" id="emailRecuperacao" required placeholder="exemplo@email.com">
              </div>
              <button type="submit" class="btn-primary" style="width:100%;">Localizar Pedidos</button>
          </form>
          <div id="listaIdsRecuperados" style="margin-top:2rem;"></div>
      </div>
  </div>

  <div id="analiseIAOverlay" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:700px;">
          <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.3rem; margin:0; display:flex; align-items:center; gap:10px;"><i class="fas fa-brain" style="color:var(--gold-solid);"></i> Inteligência Artificial</h2>
              <button id="fecharAnaliseIA" onclick="document.getElementById('analiseIAOverlay').classList.remove('active')" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <div id="resultadoAnaliseIA" style="font-size:0.95rem; color:#ddd; max-height:60vh; overflow-y:auto; line-height:1.8;"></div>
      </div>
  </div>

  <header class="header">
    <div class="container header-content">
      <div class="logo">
        <div class="logo-icon"><img src="https://raw.githubusercontent.com/mblarson/sistema-pedidos-camisetas/main/50ANOS8080.png" alt="Logo" onerror="this.style.display='none'"></div>
        <div class="logo-text"><h1>UMADEMATS</h1><span>IGREJA EVANGÉLICA ASSEMBLEIA DE DEUS MS</span></div>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="container">
      
      <section id="home" class="section active">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:75vh; text-align:center;">
            <h1 class="home-title" style="line-height:1.1; margin-bottom:1.5rem;">Pedidos de Camisetas <br><span class="text-gold">Jubileu de Ouro</span></h1>
            <div class="menu-container">
                <button class="menu-button" id="btnNovoPedido" onclick="window.setupNovoPedido(); window.mostrarSecao('pedido')"><span><i class="fas fa-plus-circle" style="margin-right:10px; color:var(--gold-solid);"></i> Realizar Novo Pedido</span> <i class="fas fa-chevron-right"></i></button>
                <button class="menu-button" id="btnConsultarPedido" onclick="window.mostrarSecao('consultar')"><span><i class="fas fa-search" style="margin-right:10px; color:var(--gold-solid);"></i> Consultar Pedido</span> <i class="fas fa-chevron-right" style="color:var(--gold-solid);"></i></button>
                <button class="menu-button" id="btnAdministrador" onclick="window.mostrarSecao('admin')"><span><i class="fas fa-shield-alt" style="margin-right:10px; color:var(--gold-solid);"></i> Área Administrativa</span> <i class="fas fa-lock" style="font-size:0.9rem; color:var(--gold-solid);"></i></button>
            </div>
        </div>
      </section>

      <section id="consultar" class="section">
        <button class="back-button" id="voltarHomeConsulta" onclick="window.mostrarSecao('home')"><i class="fas fa-arrow-left"></i> Voltar</button>
        <div class="modern-form" style="max-width:600px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:2.5rem;">
                <h2 style="margin-bottom:0.5rem;">Localizar Pedido</h2>
                <p style="color:var(--text-muted);">Informe seus dados para acessar o status.</p>
            </div>
            <form id="formConsultarNumero" onsubmit="event.preventDefault(); const num = document.getElementById('numPedidoConsultaInput').value; window.verificarPedidoPorNumero(num).then(res => { if(res) window.displayVisualizacaoPedido(res); else alert('Não encontrado'); })">
                <div class="form-group">
                    <label>Código do Pedido (ID)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="numPedidoConsultaInput" placeholder="Ex: 3Xy9..." required>
                        <button type="submit" class="btn-primary" style="padding:0 1.5rem; border-radius:var(--radius-md);"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </form>
            <div style="display:flex; align-items:center; margin:2rem 0; gap:1rem;">
                <div style="height:1px; background:var(--border-subtle); flex:1;"></div>
                <span style="color:var(--text-muted); font-size:0.8rem;">OU</span>
                <div style="height:1px; background:var(--border-subtle); flex:1;"></div>
            </div>
            <form id="formConsultarEmail" onsubmit="event.preventDefault(); const email = document.getElementById('emailConsultaInput').value; window.verificarPedidoPorEmail(email).then(res => { if(res) window.displayVisualizacaoPedido(res); else alert('Não encontrado'); })">
                <div class="form-group">
                    <label>Buscar por E-mail</label>
                    <div style="display:flex; gap:10px;">
                        <input type="email" id="emailConsultaInput" placeholder="seu@email.com" required>
                        <button type="submit" class="btn-primary" style="padding:0 1.5rem; border-radius:var(--radius-md);"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>
            <div style="text-align:center; margin-top:2rem;">
                <a id="btnEsqueceuId" onclick="document.getElementById('esqueceuIdOverlay').classList.add('active')" style="color:var(--gold-solid); cursor:pointer; font-size:0.85rem; font-weight:600;">Esqueci meu código</a>
            </div>
        </div>
        <div id="resultadoConsulta" style="margin-top:2rem;"></div>
        <div id="mensagemConsulta"></div>
      </section>

      <section id="pedido" class="section">
        <button class="back-button" id="voltarHome1" onclick="window.mostrarSecao('home')"><i class="fas fa-arrow-left"></i> Voltar</button>
        
        <div style="max-width:900px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:2rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1.5rem;">
                <div><h2 id="pedidoTitulo" style="margin-bottom:0.5rem;">Novo Pedido</h2><p id="pedidoSubtitulo" style="color:var(--text-muted);">Preencha os dados do coordenador responsável.</p></div>
                <div style="color:var(--gold-solid); font-weight:700;">2025 Collection</div>
            </div>

            <form id="formPedido" onsubmit="window.handleFormSubmission(event)">
                <input type="hidden" id="pedidoDocId" name="docId" value="">
                
                <div class="form-grid">
                    <div class="form-group"><label for="nome">Nome Completo</label><input type="text" id="nome" name="nome" required placeholder="Nome do Líder"></div>
                    <div class="form-group"><label>Localização</label><div class="radio-group"><label class="radio-label"><input type="radio" name="local" value="Capital" required id="radioCapital" onchange="window.updateSetorCidadeInput()"> Capital</label><label class="radio-label"><input type="radio" name="local" value="Interior" required id="radioInterior" onchange="window.updateSetorCidadeInput()"> Interior</label></div></div>
                    <div class="form-group"><label id="setorCidadeLabel">Setor / Cidade</label><div id="setorCidadeContainer"><input type="text" id="setor" name="setor" required></div></div>
                    <div class="form-group"><label for="email">E-mail (Obrigatório)</label><input type="email" id="email" name="email" required placeholder="Para receber confirmação"></div>
                    <div class="form-group"><label for="contato">Número para Contato</label><input type="text" id="contato" name="contato" required placeholder="(XX) 9XXXX-XXXX" maxlength="15" oninput="window.mascaraTelefone(this)"></div>
                    <!-- CAMPO DE OBSERVAÇÕES ADICIONADO AQUI -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="observacao">Observações (Opcional)</label>
                        <textarea id="observacao" name="observacao" rows="3" placeholder="Ex: Detalhes sobre entrega, nomes específicos, etc."></textarea>
                    </div>
                </div>

                <div style="margin-top:4rem;">
                    <h3 style="text-align:center; color:var(--gold-solid); margin-bottom:2.5rem; text-transform:uppercase; font-size:1.1rem; letter-spacing:2px;">Seleção de Tamanhos</h3>
                    
                    <div class="cor-header">
                        <div class="cor-dot" style="background-color: var(--shirt-verde);"></div>
                        <h4 style="margin:0; color:#fff;">Cor: <span style="color: var(--shirt-verde);">Verde-Oliva</span></h4>
                    </div>

                    <div class="form-grid">
                        <div class="tipo-camiseta">
                            <h4>Infantil (Verde)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>1</label><input type="number" id="verde_infantil_1" name="verde_infantil_1" min="0" value="0"></div>
                                <div class="tamanho-item"><label>2</label><input type="number" id="verde_infantil_2" name="verde_infantil_2" min="0" value="0"></div>
                                <div class="tamanho-item"><label>4</label><input type="number" id="verde_infantil_4" name="verde_infantil_4" min="0" value="0"></div>
                                <div class="tamanho-item"><label>6</label><input type="number" id="verde_infantil_6" name="verde_infantil_6" min="0" value="0"></div>
                                <div class="tamanho-item"><label>8</label><input type="number" id="verde_infantil_8" name="verde_infantil_8" min="0" value="0"></div>
                                <div class="tamanho-item"><label>10</label><input type="number" id="verde_infantil_10" name="verde_infantil_10" min="0" value="0"></div>
                                <div class="tamanho-item"><label>12</label><input type="number" id="verde_infantil_12" name="verde_infantil_12" min="0" value="0"></div>
                                <div class="tamanho-item"><label>14</label><input type="number" id="verde_infantil_14" name="verde_infantil_14" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta">
                            <h4>Babylook (Verde)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="verde_babylook_PP" name="verde_babylook_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="verde_babylook_P" name="verde_babylook_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="verde_babylook_M" name="verde_babylook_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="verde_babylook_G" name="verde_babylook_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="verde_babylook_GG" name="verde_babylook_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="verde_babylook_XGG" name="verde_babylook_XGG" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta" style="grid-column: 1 / -1;">
                            <h4>Unissex (Verde)</h4>
                            <div class="tamanhos-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="verde_unissex_PP" name="verde_unissex_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="verde_unissex_P" name="verde_unissex_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="verde_unissex_M" name="verde_unissex_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="verde_unissex_G" name="verde_unissex_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="verde_unissex_GG" name="verde_unissex_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="verde_unissex_XGG" name="verde_unissex_XGG" min="0" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="cor-header" style="margin-top: 3rem;">
                        <div class="cor-dot" style="background-color: var(--shirt-terracota);"></div>
                        <h4 style="margin:0; color:#fff;">Cor: <span style="color: var(--shirt-terracota);">Terracota</span></h4>
                    </div>

                    <div class="form-grid">
                        <div class="tipo-camiseta">
                            <h4>Infantil (Terracota)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>1</label><input type="number" id="terracota_infantil_1" name="terracota_infantil_1" min="0" value="0"></div>
                                <div class="tamanho-item"><label>2</label><input type="number" id="terracota_infantil_2" name="terracota_infantil_2" min="0" value="0"></div>
                                <div class="tamanho-item"><label>4</label><input type="number" id="terracota_infantil_4" name="terracota_infantil_4" min="0" value="0"></div>
                                <div class="tamanho-item"><label>6</label><input type="number" id="terracota_infantil_6" name="terracota_infantil_6" min="0" value="0"></div>
                                <div class="tamanho-item"><label>8</label><input type="number" id="terracota_infantil_8" name="terracota_infantil_8" min="0" value="0"></div>
                                <div class="tamanho-item"><label>10</label><input type="number" id="terracota_infantil_10" name="terracota_infantil_10" min="0" value="0"></div>
                                <div class="tamanho-item"><label>12</label><input type="number" id="terracota_infantil_12" name="terracota_infantil_12" min="0" value="0"></div>
                                <div class="tamanho-item"><label>14</label><input type="number" id="terracota_infantil_14" name="terracota_infantil_14" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta">
                            <h4>Babylook (Terracota)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="terracota_babylook_PP" name="terracota_babylook_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="terracota_babylook_P" name="terracota_babylook_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="terracota_babylook_M" name="terracota_babylook_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="terracota_babylook_G" name="terracota_babylook_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="terracota_babylook_GG" name="terracota_babylook_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="terracota_babylook_XGG" name="terracota_babylook_XGG" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta" style="grid-column: 1 / -1;">
                            <h4>Unissex (Terracota)</h4>
                            <div class="tamanhos-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="terracota_unissex_PP" name="terracota_unissex_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="terracota_unissex_P" name="terracota_unissex_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="terracota_unissex_M" name="terracota_unissex_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="terracota_unissex_G" name="terracota_unissex_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="terracota_unissex_GG" name="terracota_unissex_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="terracota_unissex_XGG" name="terracota_unissex_XGG" min="0" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:3rem; text-align:center;">
                        <button type="submit" class="btn-primary" style="min-width:250px;"><span id="submitButtonText">Confirmar e Enviar</span></button>
                    </div>
                </form>
            <div id="mensagemPedido"></div>
        </div>
      </section>

      <section id="admin" class="section">
        <button class="back-button" id="voltarHome3" onclick="window.mostrarSecao('home')"><i class="fas fa-arrow-left"></i> Voltar</button>
        <div id="loginAdmin" class="modern-form" style="max-width:450px; margin:3rem auto;">
            <div style="text-align:center; margin-bottom:2rem;"><h2 style="margin-bottom:0.5rem;">Acesso Restrito</h2><p style="color:var(--text-muted);">Apenas pessoal autorizado</p></div>
            <form id="formLoginAdmin" style="text-align:center;" onsubmit="window.handleAdminLogin(event)">
                <input type="hidden" id="emailAdmin" value="admin@umademats.com.br">
                <div class="form-group"><label>Senha de Administrador</label><div style="position:relative;"><input type="password" id="senhaAdmin" required style="padding-right:40px !important;"><button type="button" onclick="window.togglePasswordVisibility('senhaAdmin', this.querySelector('i'))" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-eye"></i></button></div></div>
                <button type="submit" class="btn-primary" style="width:100%; margin-top:1rem;">Entrar no Sistema</button>
            </form>
            <div id="mensagemLogin"></div>
        </div>

        <div id="painelAdmin" class="admin-panel" style="display:none; border:none; background:transparent; padding:0; box-shadow:none;">
            <div class="admin-menu">
                <button class="admin-menu-btn active" id="btnDashboard" onclick="window.mostrarAdminSecao('dashboard')">Dashboard</button>
                <button class="admin-menu-btn" id="btnPedidos" onclick="window.mostrarAdminSecao('pedidos')">Pedidos</button>
                <button class="admin-menu-btn" id="btnEvento" onclick="window.mostrarAdminSecao('evento')">Evento</button>
                <button class="admin-menu-btn" id="btnPagamentos" onclick="window.mostrarAdminSecao('pagamentos')">Pagamentos</button>
            </div>

            <div id="admin-dashboard" class="admin-section active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h2>Visão Geral</h2>
                    <button id="atualizarDashboard" onclick="window.recarregarDashboardComFeedback()" style="background:transparent; border:1px solid var(--border-subtle); color:var(--text-main); padding:0.5rem 1rem; border-radius:50px; cursor:pointer; display:flex; align-items:center; gap:8px;"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>
                <button class="btn-ai-magic" id="btnAnaliseIA" style="margin-bottom:2rem; padding:1.2rem;"><i class="fas fa-sparkles"></i> Gerar Análise Inteligente de Vendas</button>
                <div class="dashboard-cards">
                    <div class="card"><div class="card-content"><h4>Pedidos Totais</h4><p class="card-value" id="totalPedidos">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Camisetas</h4><p class="card-value" id="totalCamisetas">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Receita Prevista</h4><p class="card-value text-gold" id="totalArrecadado">R$ 0,00</p></div></div>
                    <div class="card"><div class="card-content"><h4>Total Recebido (Real)</h4><p class="card-value text-gold" id="totalRecebidoReal">R$ 0,00</p></div></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">Métricas por Categoria</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:2rem; text-align:center;">
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Infantil</span><strong style="font-size:1.8rem;" id="totalInfantis">0</strong></div>
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Babylook</span><strong style="font-size:1.8rem;" id="totalBabylook">0</strong></div>
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Unissex</span><strong style="font-size:1.8rem;" id="totalUnissex">0</strong></div>
                    </div>
                </div>
                <button class="btn-primary" id="btnVerDetalhes" onclick="window.mostrarAdminSecao('detalhes-tamanhos')" style="width:100%; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);">Relatório Detalhado de Tamanhos</button>
            </div>

            <div id="admin-detalhes-tamanhos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;"><h2>Matriz de Tamanhos</h2><button id="voltarDashboard" onclick="window.mostrarAdminSecao('dashboard')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; gap:5px;"><i class="fas fa-arrow-left"></i> Voltar</button></div>
                
                <!-- ADULTO -->
                <h3 style="color:#fff; margin-bottom:1rem; border-bottom:1px solid var(--gold-solid); padding-bottom:0.5rem;">ADULTO</h3>
                <div class="card" style="margin-bottom:1rem;">
                    <h4 style="color:var(--shirt-verde); margin-bottom:1rem;">Verde-Oliva</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaAdultoVerde" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="adultoVerdeBody"></tbody></table></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--shirt-terracota); margin-bottom:1rem;">Terracota</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaAdultoTerra" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="adultoTerraBody"></tbody></table></div>
                </div>

                <!-- BABYLOOK -->
                <h3 style="color:#fff; margin-bottom:1rem; border-bottom:1px solid var(--gold-solid); padding-bottom:0.5rem;">BABYLOOK</h3>
                <div class="card" style="margin-bottom:1rem;">
                    <h4 style="color:var(--shirt-verde); margin-bottom:1rem;">Verde-Oliva</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaBabyVerde" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="babyVerdeBody"></tbody></table></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--shirt-terracota); margin-bottom:1rem;">Terracota</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaBabyTerra" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="babyTerraBody"></tbody></table></div>
                </div>

                <!-- INFANTIL -->
                <h3 style="color:#fff; margin-bottom:1rem; border-bottom:1px solid var(--gold-solid); padding-bottom:0.5rem;">INFANTIL</h3>
                <div class="card" style="margin-bottom:1rem;">
                    <h4 style="color:var(--shirt-verde); margin-bottom:1rem;">Verde-Oliva</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaInfantilVerde" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>1</th><th>2</th><th>4</th><th>6</th><th>8</th><th>10</th><th>12</th><th>14</th></tr></thead><tbody id="infantilVerdeBody"></tbody></table></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--shirt-terracota); margin-bottom:1rem;">Terracota</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaInfantilTerra" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>1</th><th>2</th><th>4</th><th>6</th><th>8</th><th>10</th><th>12</th><th>14</th></tr></thead><tbody id="infantilTerraBody"></tbody></table></div>
                </div>
                
                <div style="display:flex; gap:1rem;"><button id="btnGerarPdf" onclick="window.gerarRelatorioPdf()" class="btn-primary" style="flex:1;">Baixar PDF</button><button id="atualizarDetalhesTamanho" onclick="window.carregarDetalhesEvento()" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:#fff; border-radius:50px; cursor:pointer;">Atualizar Dados</button></div>
            </div>

            <div id="admin-evento" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;"><h3>Configuração do Evento</h3> <button id="atualizarEvento" onclick="window.recarregarDetalhesEventoComFeedback()" style="background:none; border:none; color:var(--gold-solid); font-size:1.0rem; cursor:pointer;"><i class="fas fa-sync-alt"></i> Atualizar</button></div>
                <div class="card" style="margin-bottom:2rem;">
                    <div style="display:flex; align-items:center; gap:1rem; margin-bottom: 1.5rem;">
                        <label style="color:var(--text-muted); margin:0;">Valor Unitário (R$)</label>
                        <input type="number" id="valorCamisetaInput" step="0.01" style="width:120px;">
                        <button id="btnSalvarValor" class="btn-primary" type="button" onclick="window.abrirModalSenhaValor()" style="padding:0.8rem 1.5rem; font-size:0.8rem; display:flex; justify-content:center; align-items:center;">SALVAR</button>
                    </div>
                    <!-- BOTÃO ENCERRAR EVENTO ADICIONADO AQUI -->
                    <button id="btnEncerrarEventoAction" class="btn-primary" type="button" style="width:100%; background:var(--danger-color); color:#fff; margin-top: 1rem;" onclick="document.getElementById('modalEncerrarEvento').classList.add('active')">ENCERRAR EVENTO</button>
                </div>
                <div class="card"><h4 style="margin-bottom:1.5rem;">Por Setor / Localidade</h4><div id="resumoEventoLocais"></div></div>
            </div>

            <div id="admin-pedidos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h3>Todos os Pedidos</h3>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btnFecharPedidosAction" style="background:rgba(212, 175, 55, 0.1); border:1px solid var(--gold-solid); color:var(--gold-solid); font-size:0.75rem; cursor:pointer; padding:6px 12px; border-radius:50px; font-weight:700; text-transform:uppercase;" onclick="document.getElementById('modalFecharPedidos').classList.add('active')"><i class="fas fa-ban"></i> Fechar Pedidos</button>
                        <button id="btnReabrirPedidosAction" style="background:rgba(100, 255, 218, 0.1); border:1px solid var(--success-color); color:var(--success-color); font-size:0.75rem; cursor:pointer; padding:6px 12px; border-radius:50px; font-weight:700; text-transform:uppercase; display:none;" onclick="document.getElementById('modalReabrirPedidos').classList.add('active')"><i class="fas fa-check"></i> Reabrir Pedidos</button>
                        <button id="atualizarPedidos" onclick="window.recarregarPedidosComFeedback()" style="background:none; border:none; color:var(--gold-solid); font-size:1.2rem; cursor:pointer;"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                
                <div id="filtrosPedidos" class="search-container">
                    <div class="form-group" style="margin-bottom:0.5rem;">
                        <input type="text" id="buscaInput" placeholder="🔍 Buscar por nome, ID, setor, cidade, telefone..." style="background:rgba(255,255,255,0.05)!important; border-color:var(--border-subtle)!important;" oninput="window.carregarPedidos()">
                        
                    </div>
                    <div class="filter-container">
                        <span style="color:var(--text-muted); text-transform:uppercase;">LOCAL:</span>
                        <label class="filter-radio"><input type="radio" name="filtroLocal" value="todos" checked onchange="window.carregarPedidos()"> <span>Todos</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroLocal" value="Capital" onchange="window.carregarPedidos()"> <span>Capital</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroLocal" value="Interior" onchange="window.carregarPedidos()"> <span>Interior</span></label>
                    </div>
                </div>

                <div id="listaPedidos" style="margin-top:1.5rem;"></div>
            </div>

            <div id="admin-pagamentos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h3>Pagamentos</h3>
                    <button id="atualizarPagamentos" onclick="window.recarregarPagamentosComFeedback()" style="background:none; border:none; color:var(--gold-solid); font-size:1rem; cursor:pointer;"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>
                
                <!-- INÍCIO: NOVOS FILTROS E BUSCA -->
                <div id="filtrosPagamentos" class="search-container">
                    <div class="form-group" style="margin-bottom:0.5rem;">
                        <input type="text" id="buscaPagamentosInput" placeholder="🔍 Buscar por nome, ID, setor, cidade, telefone..." style="background:rgba(255,255,255,0.05)!important; border-color:var(--border-subtle)!important;" oninput="window.carregarPagamentos()">
                        
                    </div>
                    <div class="filter-container">
                        <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase;">Status:</span>
                        <label class="filter-radio"><input type="radio" name="filtroStatusPagamento" value="todos" checked onchange="window.carregarPagamentos()"> <span>Todos</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroStatusPagamento" value="parcialmente" onchange="window.carregarPagamentos()"> <span>PARCIAL</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroStatusPagamento" value="quitado" onchange="window.carregarPagamentos()"> <span>Quitado</span></label>
                    </div>
                </div>
                <!-- FIM: NOVOS FILTROS E BUSCA -->
                
                <div id="listaPagamentos">
                    </div>
            </div>

        </div>
      </section>

    </div>
  </main>

  <footer style="text-align:center; padding:3rem 0; border-top:1px solid var(--border-subtle); margin-top:4rem; color:var(--text-muted); font-size:0.8rem;">
    <p>&copy; 2025 UMADEMATS</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script type="module">
// @ts-nocheck
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, getDoc, onSnapshot, serverTimestamp, deleteDoc, limit, orderBy, startAfter, writeBatch, increment, runTransaction, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmYkZZ35rc--NPXdhSI0Bo7GzVvtLVFkE",
  authDomain: "pedidosumademats.firebaseapp.com",
  projectId: "pedidosumademats",
  storageBucket: "pedidosumademats.firebasestorage.app",
  messagingSenderId: "604273766416",
  appId: "1:604273766416:web:4813a2365db9ea0e9e1a95"
};

window.pedidosCache = [];
let PRECO_CAMISETA = 30.00; 
let SISTEMA_ABERTO = true; 
let pedidoDoModal = null; // Variável global para armazenar o pedido exibido no modal
let pedidoParaExcluir = null; // Variável global para exclusão
let ultimoDocumentoCarregado = null; // Controle para o botão Expandir
let ultimoDocPagamentos = null; // Controle para paginação de pagamentos

function escapeHTML(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const pedidosCollection = collection(db, "pedidos");

// REGRA DE RENOMEAÇÃO: configDocRef agora aponta para "evento"
const configDocRef = doc(db, "configuracoes", "evento"); 

const configSistemaRef = doc(db, "configuracoes", "sistema");

let currentPedidoParaEdicao = null;
window.adminAcessouPainel = false;

// ===============================================
// FUNÇÕES DA TELA INICIAL MÓVEL
// ===============================================

window.handleAccessAndLoading = function() {
    const btn = document.getElementById('btnAcessarSistema');
    const loader = document.getElementById('splashLoader');

    // LOG: Início do processo de acesso e loading.
    console.log("LOG: Splash Screen - Início do processo de loading.");

    // 1. Esconder botão, exibir loader
    if(btn) btn.style.display = 'none';
    if(loader) {
        loader.style.display = 'block'; // Garante que o loader apareça
        loader.classList.add('active'); 
    }

    // 2. Aguardar 2 segundos e sumir com o splash
    setTimeout(() => {
        const splashScreen = document.getElementById('mobileSplashScreen');
        const header = document.querySelector('header');
        const main = document.querySelector('main');
        const footer = document.querySelector('footer');

        // LOG: 2 segundos passados. Removendo splash e exibindo sistema.
        console.log("LOG: Splash Screen - Loading concluído. Exibindo sistema principal.");

        if(splashScreen) splashScreen.classList.remove('active');
        
        // 3. Remover a ocultação do conteúdo principal
        if(header) header.style.display = '';
        if(main) main.style.display = '';
        if(footer) footer.style.display = '';

        // Oculta o loader e exibe o botão para próxima vez (se houver)
        if(loader) {
            loader.classList.remove('active');
            loader.style.display = 'none'; // Esconde o loader
        }
        if(btn) btn.style.display = 'flex'; 

    }, 2000); // 2 segundos de loading
};

window.checkAndShowSplash = () => {
    const splashScreen = document.getElementById('mobileSplashScreen');
    const video = document.getElementById('splashVideo');
    const header = document.querySelector('header');
    const main = document.querySelector('main');
    const footer = document.querySelector('footer');

    // A tela inicial deve aparecer apenas em mobile (largura < 768px)
    if (window.innerWidth >= 768) {
        if(splashScreen) splashScreen.style.display = 'none'; // Garante que esteja oculto no desktop
        // LOG: Desktop detectado. Splash oculto. Sistema visível.
        console.log("LOG: Splash Screen - Desktop detectado. Exibição direta.");
        return;
    }

    if(splashScreen) {
        // Se for Mobile, exibir o splash e ocultar o conteúdo principal.
        splashScreen.classList.add('active'); // Para ativar a transição e o display: flex
        
        // Oculta o conteúdo principal para mostrar apenas o splash
        if(header) header.style.display = 'none';
        if(main) main.style.display = 'none';
        if(footer) footer.style.display = 'none';
        
        // LOG: Mobile detectado. Exibindo Splash e ocultando sistema principal.
        console.log("LOG: Splash Screen - Mobile detectado. Exibindo tela inicial.");

        // Tenta garantir que o vídeo comece a tocar em mobile
        if (video) {
            video.play().catch(e => console.log('Video auto-play blocked:', e));
        }
    }
};


// ===============================================
// FUNÇÕES DE AUTENTICAÇÃO E INICIALIZAÇÃO
// ===============================================

(function initBeamsBackground() {
    const canvas = document.getElementById('beams-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    const MINIMUM_BEAMS = 20; const intensity = "strong";
    const opacityMap = { subtle: 0.7, medium: 0.85, strong: 1 };
    let beams = []; let animationFrameId = 0;
    function createBeam(width, height) {
        const angle = -35 + Math.random() * 10;
        return { x: Math.random() * width * 1.5 - width * 0.25, y: Math.random() * height * 1.5 - height * 0.25, width: 30 + Math.random() * 60, length: height * 2.5, angle: angle, speed: 0.6 + Math.random() * 1.2, opacity: 0.12 + Math.random() * 0.16, hue: 190 + Math.random() * 70, pulse: Math.random() * Math.PI * 2, pulseSpeed: 0.02 + Math.random() * 0.03 };
    }
    function resetBeam(beam, index, totalBeams) {
        if (!canvas) return beam;
        const column = index % 3; const spacing = canvas.width / 3;
        beam.y = canvas.height + 100; beam.x = column * spacing + spacing / 2 + (Math.random() - 0.5) * spacing * 0.5; beam.width = 100 + Math.random() * 100; beam.speed = 0.5 + Math.random() * 0.4; beam.hue = 190 + (index * 70) / totalBeams; beam.opacity = 0.2 + Math.random() * 0.1; return beam;
    }
    function drawBeam(ctx, beam) {
        ctx.save(); ctx.translate(beam.x, beam.y); ctx.rotate((beam.angle * Math.PI) / 180);
        const pulsingOpacity = beam.opacity * (0.8 + Math.sin(beam.pulse) * 0.2) * opacityMap[intensity];
        const gradient = ctx.createLinearGradient(0, 0, 0, beam.length);
        gradient.addColorStop(0, `hsla(${beam.hue}, 85%, 65%, 0)`); gradient.addColorStop(0.1, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`); gradient.addColorStop(0.4, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`); gradient.addColorStop(0.6, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`); gradient.addColorStop(0.9, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`); gradient.addColorStop(1, `hsla(${beam.hue}, 85%, 65%, 0)`);
        ctx.fillStyle = gradient; ctx.fillRect(-beam.width / 2, 0, beam.width, beam.length); ctx.restore();
    }
    function animate() {
        if (!canvas || !ctx) return; ctx.clearRect(0, 0, canvas.width, canvas.height); const totalBeams = beams.length;
        beams.forEach((beam, index) => { beam.y -= beam.speed; beam.pulse += beam.pulseSpeed; if (beam.y + beam.length < -100) { resetBeam(beam, index, totalBeams); } drawBeam(ctx, beam); }); animationFrameId = requestAnimationFrame(animate);
    }
    function updateCanvasSize() {
        const dpr = window.devicePixelRatio || 1; canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr; ctx.scale(dpr, dpr);
        const totalBeams = MINIMUM_BEAMS * 1.5; beams = Array.from({ length: totalBeams }, () => createBeam(canvas.width / dpr, canvas.height / dpr));
    }
    updateCanvasSize(); window.addEventListener("resize", updateCanvasSize); animate();
})();

const initAuth = async () => {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            if (!user.isAnonymous) {
                // Usuário logado. Apenas inicia monitores.
                iniciarMonitoramentoPreco();
                iniciarMonitoramentoSistema();
            } else {
                // Usuário Anônimo. Garante que os monitores estejam rodando.
                const painelDiv = document.getElementById('painelAdmin');
                if (painelDiv) { painelDiv.style.display = 'none'; }
                iniciarMonitoramentoPreco();
                iniciarMonitoramentoSistema();
            }
        } else { signInAnonymously(auth).catch(console.error); }
    });
};

const formatarMoeda = (valor) => { return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 }); };

// Função auxiliar para data
const formatarDataPTBR = (dataStr) => {
    if(!dataStr) return "-";
    // Se for string DDMMAAAA (legado/input)
    if(dataStr.length === 8 && !dataStr.includes('-') && !dataStr.includes('/')) {
            return `${dataStr.substr(0,2)}/${dataStr.substr(2,2)}/${dataStr.substr(4,4)}`;
    }
    // Se ja tiver barra, retorna igual
    if(dataStr.includes('/')) return dataStr;

    // Se for ISO ou data JS
    const dateObj = new Date(dataStr);
    // Garante que é uma data válida antes de formatar
    if(isNaN(dateObj)) return dataStr; 
    return dateObj.toLocaleDateString('pt-BR');
};

let unsubscribePreco = null; let unsubscribeSistema = null;

function iniciarMonitoramentoPreco() {
    if (unsubscribePreco) return; 
    unsubscribePreco = onSnapshot(configDocRef, (docSnap) => {
        if (docSnap.exists()) {
            const novoPreco = parseFloat(docSnap.data().valor_camiseta) || 30.00;
            if (PRECO_CAMISETA !== novoPreco) {
                PRECO_CAMISETA = novoPreco;
                const valInput = document.getElementById('valorCamisetaInput');
                if (valInput && document.activeElement !== valInput) { valInput.value = PRECO_CAMISETA.toFixed(2); }
                // Verifica se o painel está visível antes de carregar o dashboard
                if (document.getElementById('painelAdmin').style.display === 'block') { window.carregarDashboard(); window.carregarDetalhesEvento(); }
            } else {
                const valInput = document.getElementById('valorCamisetaInput');
                if(valInput && valInput.value === "") valInput.value = PRECO_CAMISETA.toFixed(2);
            }
        } else { setDoc(configDocRef, { valor_camiseta: 30.00 }).catch(console.error); PRECO_CAMISETA = 30.00; }
    }, (error) => { console.error("Erro no monitoramento de preço:", error); });
}

function iniciarMonitoramentoSistema() {
    if (unsubscribeSistema) return;
    unsubscribeSistema = onSnapshot(configSistemaRef, (docSnap) => {
        if (docSnap.exists()) { const data = docSnap.data(); SISTEMA_ABERTO = data.aberto !== false; } else { SISTEMA_ABERTO = true; setDoc(configSistemaRef, { aberto: true }).catch(console.error); }
        const btnFechar = document.getElementById('btnFecharPedidosAction'); const btnReabrir = document.getElementById('btnReabrirPedidosAction');
        if (btnFechar && btnReabrir) {
            if (SISTEMA_ABERTO) { btnFechar.style.display = 'inline-block'; btnReabrir.style.display = 'none'; } else { btnFechar.style.display = 'none'; btnReabrir.style.display = 'inline-block'; }
        }
    });
}

initAuth();

async function callGemini(promptText) { return "Simulated Gemini Response"; }

window.handleAnaliseIA = async function() {
    document.getElementById('resultadoAnaliseIA').innerHTML = `<p style="color:#8892b0">A análise requer chave de API válida.</p>`;
};

function getQuantidadesFromForm(formData, prefix) {
    const quantidades = {};
    for (const [key, value] of formData.entries()) {
        if (key.startsWith(prefix + '_')) {
            // remove prefixo "verde_infantil_" -> "1"
            const cleanKey = key.replace(prefix + '_', '');
            quantidades[cleanKey] = parseInt(value) || 0;
        }
    }
    return quantidades;
}

window.togglePasswordVisibility = function(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (input.type === "password") { input.type = "text"; iconElement.classList.remove('fa-eye'); iconElement.classList.add('fa-eye-slash'); } else { input.type = "password"; iconElement.classList.remove('fa-eye-slash'); iconElement.classList.add('fa-eye'); }
};

function isValidEmail(value) { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return emailRegex.test(value); }
function normalizeString(str) { if (typeof str !== 'string') return ''; return str.toUpperCase().trim(); }

window.mostrarSecao = function(secao) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    const secaoElement = document.getElementById(secao);
    if (secaoElement) { secaoElement.classList.add('active'); secaoElement.style.opacity = ""; secaoElement.style.transform = ""; }
};

window.mostrarAdminSecao = function(secao) {
    document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.admin-menu-btn').forEach(b => { b.classList.remove('active'); });
    
    let secaoId = `admin-${secao}`;
    let btnId = `btn${secao.charAt(0).toUpperCase() + secao.slice(1)}`;
    
    const secaoElement = document.getElementById(secaoId); 
    if (secaoElement) secaoElement.style.display = 'block';
    
    const btn = document.getElementById(btnId); 
    if (btn) btn.classList.add('active');
    
    // === IMPLEMENTAÇÃO: AUTO REFRESH E LIMPEZA DE CACHE ===
    if (window.adminRefreshInterval) clearInterval(window.adminRefreshInterval);
    window.pedidosCache = []; // Força leitura fresca (Regra: Ignorar cache local na primeira carga)

    let refreshFunc = null;

    if (secao === 'dashboard') {
        window.carregarDashboard();
        refreshFunc = window.carregarDashboard;
    } else if (secao === 'pedidos') {
        window.carregarPedidos();
        refreshFunc = window.carregarPedidos;
    } else if (secao === 'evento') {
        window.carregarDetalhesEvento();
        refreshFunc = window.carregarDetalhesEvento;
    } else if (secao === 'pagamentos') {
        window.carregarPagamentos();
        refreshFunc = window.carregarPagamentos;
    } else if (secao === 'detalhes-tamanhos') {
        window.carregarDetalhesEvento();
        refreshFunc = window.carregarDetalhesEvento;
    }

    // Configura o Auto Refresh (15 segundos)
    if (refreshFunc) {
        window.adminRefreshInterval = setInterval(() => {
            if (document.getElementById(secaoId).style.display !== 'none') {
                window.pedidosCache = []; // Garante dados atualizados
                refreshFunc();
            }
        }, 15000);
    }
};

window.redirecionarComAnimacao = function(secao, callback) {
    const elementoAtual = document.querySelector('.section.active');
    const proximoElemento = document.getElementById(secao);
    if (!elementoAtual || !proximoElemento || elementoAtual === proximoElemento) { window.mostrarSecao(secao); if (callback) callback(); return; }
    elementoAtual.style.opacity = '0'; elementoAtual.style.transform = 'translateY(20px)';
    setTimeout(() => { window.mostrarSecao(secao); if (callback) callback(); proximoElemento.style.opacity = '0'; proximoElemento.style.transform = 'translateY(20px)'; setTimeout(() => { proximoElemento.style.opacity = '1'; proximoElemento.style.transform = 'translateY(0)'; }, 50); }, 400);
};

window.exibirMensagem = function(elementoId, tipo, mensagem) {
    const elemento = document.getElementById(elementoId); if (!elemento) return;
    const color = tipo === 'sucesso' ? 'var(--success-color)' : 'var(--danger-color)';
    elemento.innerHTML = `<div style="padding:1rem; margin-top:1rem; border-radius:var(--radius-md); background:rgba(255,255,255,0.05); border-left:4px solid ${color}; color:#fff; font-size:0.9rem; box-shadow:0 5px 15px rgba(0,0,0,0.2);"><i class="fas fa-${tipo === 'sucesso' ? 'check-circle' : 'exclamation-circle'}" style="color:${color}; margin-right:8px;"></i> ${mensagem}</div>`;
    setTimeout(() => { elemento.innerHTML = ''; }, 5000);
};

window.mostrarCarregamento = function(mostrar = true, texto = 'PROCESSANDO...') {
    const loadingOverlay = document.getElementById('loadingOverlay'); const loadingText = document.getElementById('loadingText'); loadingText.textContent = texto; if (mostrar) loadingOverlay.classList.add('active'); else loadingOverlay.classList.remove('active');
};

window.atualizarElemento = function(elementId, valor) { const elemento = document.getElementById(elementId); if (elemento) elemento.textContent = valor; };
window.fecharConfirmacaoPedido = function() { document.getElementById('pedidoConfirmacaoOverlay').classList.remove('active'); window.mostrarSecao('home'); };

window.copiarNumeroPedido = function(numPedido) {
    const fallbackCopy = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if (successful) alert('CÓDIGO COPIADO!'); else alert('Erro ao copiar.'); } catch (err) { alert('Erro ao copiar.'); } document.body.removeChild(textArea); };
    if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(numPedido).then(() => { alert('CÓDIGO COPIADO!'); }).catch(err => { console.warn("Clipboard API failed, trying fallback...", err); fallbackCopy(numPedido); }); } else { fallbackCopy(numPedido); }
};

window.exibirConfirmacaoPedido = function(pedido) {
    const overlay = document.getElementById('pedidoConfirmacaoOverlay');
    document.getElementById('pedidoConfirmacaoNumero').innerHTML = `#${pedido.numPedido}`;
    document.getElementById('pedidoConfirmacaoInfo').innerHTML = `<p><strong>NOME:</strong> ${pedido.nome}</p><p><strong>LOCAL:</strong> ${pedido.local} / ${pedido.setor}</p>`;
    
    let resumo = "";
    const listaTamanhos = (obj) => Object.entries(obj || {}).filter(([k, v]) => v > 0).map(([k, v]) => `${k}: ${v}`).join(', ');
    
    if (pedido.verdeOliva) {
        const vInf = listaTamanhos(pedido.verdeOliva.infantil);
        const vBaby = listaTamanhos(pedido.verdeOliva.babylook);
        const vUni = listaTamanhos(pedido.verdeOliva.unissex);
        if(vInf || vBaby || vUni) {
            resumo += `<p style="margin-top:10px; color:var(--shirt-verde); font-weight:bold;">VERDE-OLIVA</p>`;
            if(vInf) resumo += `<p>Inf: ${vInf}</p>`;
            if(vBaby) resumo += `<p>Baby: ${vBaby}</p>`;
            if(vUni) resumo += `<p>Uni: ${vUni}</p>`;
        }
    }
    if (pedido.terracota) {
        const tInf = listaTamanhos(pedido.terracota.infantil);
        const tBaby = listaTamanhos(pedido.terracota.babylook);
        const tUni = listaTamanhos(pedido.terracota.unissex);
        if(tInf || tBaby || tUni) {
            resumo += `<p style="margin-top:10px; color:var(--shirt-terracota); font-weight:bold;">TERRACOTA</p>`;
            if(tInf) resumo += `<p>Inf: ${tInf}</p>`;
            if(tBaby) resumo += `<p>Baby: ${tBaby}</p>`;
            if(tUni) resumo += `<p>Uni: ${tUni}</p>`;
        }
    }
    // Legado
    if (!pedido.verdeOliva && !pedido.terracota) {
            const lInf = listaTamanhos(pedido.infantil);
            const lBaby = listaTamanhos(pedido.babylook);
            const lUni = listaTamanhos(pedido.unissex);
            if(lInf) resumo += `<p>INFANTIL: ${lInf}</p>`;
            if(lBaby) resumo += `<p>BABYLOOK: ${lBaby}</p>`;
            if(lUni) resumo += `<p>UNISSEX: ${lUni}</p>`;
    }
    
    document.getElementById('pedidoConfirmacaoTamanhos').innerHTML = resumo;
    document.getElementById('pedidoConfirmacaoTamanhos').style.display = 'block';
    overlay.classList.add('active');
};

window.recalcularValores = async function(novoValorString) {
    const novoValor = parseFloat(novoValorString);
    if (isNaN(novoValor) || novoValor <= 0) { console.error("Valor inválido para recalcular."); return; }
    
    window.mostrarCarregamento(true, "RECALCULANDO ESTATÍSTICAS...");
    
    try {
        // 1. Salva o novo preço na configuração
        await setDoc(configDocRef, { valor_camiseta: novoValor }, { merge: true });
        
        // 2. Chama carregarDashboard para recalcular tudo com o novo preço
        // Isso garante que o documento de estatísticas seja atualizado
        await window.carregarDashboard();

        // 3. Feedback Visual e Atualização Local (Opcional, pois carregarDashboard já atualiza a UI)
        // Mas mantemos para dar feedback no modal
        const docSnap = await getDoc(doc(db, "configuracoes", "estatisticas"));
        if(docSnap.exists()) {
             const stats = docSnap.data();
             document.getElementById('confirmacaoNovoValor').innerText = formatarMoeda(novoValor);
             document.getElementById('confirmacaoNovoTotal').innerText = formatarMoeda(stats.valor_total || 0);
             document.getElementById('modalSucessoFinanceiro').classList.add('active');
        }

    } catch (error) { 
        console.error("Erro fatal ao salvar preço:", error); 
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao atualizar estatísticas. Tente novamente."; 
        document.getElementById('modalErroPDF').classList.add('active'); 
    } finally {
        window.mostrarCarregamento(false);
    }
};

// HELPER CENTRAL PARA CONTAR ITENS (SUPORTA LEGADO E NOVO)
function calcularTotalPedido(p) {
    const sumObj = (obj) => Object.values(obj || {}).reduce((a, b) => a + b, 0);
    let total = 0;
    // Legado
    total += sumObj(p.infantil);
    total += sumObj(p.babylook);
    total += sumObj(p.unissex);
    // Novo: Verde
    if(p.verdeOliva) {
        total += sumObj(p.verdeOliva.infantil);
        total += sumObj(p.verdeOliva.babylook);
        total += sumObj(p.verdeOliva.unissex);
    }
    // Novo: Terracota
    if(p.terracota) {
        total += sumObj(p.terracota.infantil);
        total += sumObj(p.terracota.babylook);
        total += sumObj(p.terracota.unissex);
    }
    return total;
}

window.gerarRelatorioPdf = function() {
    window.mostrarCarregamento(true, 'GERANDO PDF...');
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        
        doc.setFontSize(16); doc.text("RELATÓRIO DE TAMANHOS - UMADEMATS", 148.5, 20, null, null, "center");
        doc.setFontSize(10); doc.text(`Gerado em: ${dataAtual}`, 10, 25);
        
        // Função para capturar dados das tabelas HTML
        const getTableData = (tableId) => {
            const tableElement = document.getElementById(tableId);
            if (!tableElement || tableElement.rows.length <= 1) return { head: [], body: [] };
            const head = Array.from(tableElement.querySelector('thead tr').children).map(th => th.textContent);
            let body = []; 
            Array.from(tableElement.querySelector('tbody').rows).forEach(row => { 
                body.push(Array.from(row.children).map(td => td.textContent)); 
            });
            return { head: [head], body: body };
        };

        let nextY = 30;

        // Helper para adicionar tabela com estilo
        const addSection = (title, tableId, colorRGB) => {
            const data = getTableData(tableId);
            if (data.body.length === 0) return nextY;

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(title, 14, nextY);
            nextY += 2;

            doc.autoTable({
                head: data.head,
                body: data.body,
                startY: nextY,
                theme: 'grid',
                headStyles: { fillColor: colorRGB, textColor: [255, 255, 255], fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 2 },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });
            
            nextY = doc.lastAutoTable.finalY + 10;
            // Se não couber na página, adiciona nova página
            if (nextY > 180) { doc.addPage(); nextY = 20; }
            return nextY;
        };

        // Verde RGB: [85, 107, 47]
        // Terracota RGB: [192, 88, 56]

        // ADULTO
        doc.setFontSize(14); doc.text("ADULTO (Unissex)", 14, nextY); nextY += 6;
        nextY = addSection("Verde-Oliva", 'tabelaAdultoVerde', [85, 107, 47]);
        nextY = addSection("Terracota", 'tabelaAdultoTerra', [192, 88, 56]);

        // BABYLOOK
        if (nextY > 160) { doc.addPage(); nextY = 20; }
        doc.setFontSize(14); doc.text("BABYLOOK", 14, nextY); nextY += 6;
        nextY = addSection("Verde-Oliva", 'tabelaBabyVerde', [85, 107, 47]);
        nextY = addSection("Terracota", 'tabelaBabyTerra', [192, 88, 56]);

        // INFANTIL
        if (nextY > 160) { doc.addPage(); nextY = 20; }
        doc.setFontSize(14); doc.text("INFANTIL", 14, nextY); nextY += 6;
        nextY = addSection("Verde-Oliva", 'tabelaInfantilVerde', [85, 107, 47]);
        nextY = addSection("Terracota", 'tabelaInfantilTerra', [192, 88, 56]);

        // TOTALIZADORES NO FINAL
        if (nextY > 150) { doc.addPage(); nextY = 20; }
        
        const tInf = parseInt(document.getElementById('totalInfantis').innerText) || 0;
        const tBaby = parseInt(document.getElementById('totalBabylook').innerText) || 0;
        const tUni = parseInt(document.getElementById('totalUnissex').innerText) || 0;
        const tGeral = tInf + tBaby + tUni;
        
        doc.setDrawColor(212, 175, 55);
        doc.setLineWidth(0.5);
        doc.rect(14, nextY, 180, 40);
        
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text("RESUMO GERAL", 20, nextY + 10);
        
        doc.setFontSize(11);
        doc.text(`Total Infantil: ${tInf}`, 20, nextY + 20);
        doc.text(`Total Babylook: ${tBaby}`, 20, nextY + 26);
        doc.text(`Total Unissex: ${tUni}`, 20, nextY + 32);
        
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(`TOTAL GERAL DE PEÇAS: ${tGeral.toLocaleString('pt-BR')}`, 100, nextY + 25);

        doc.save(`Relatorio_Detalhado_Tamanhos_${dataAtual.replace(/\//g, '-')}.pdf`);
        window.mostrarCarregamento(false);
    } catch (error) {
        window.mostrarCarregamento(false);
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Não foi possível gerar o PDF. Tente novamente.";
        document.getElementById('modalErroPDF').classList.add('active');
        console.error("Erro ao gerar PDF do Relatório:", error);
    }
};

// FUNÇÃO QUE RECUPERA O PEDIDO E CHAMA A GERAÇÃO DE PDF
window.baixarPedidoDoModal = function() {
    if (pedidoDoModal) {
        window.gerarPdfPedidoIndividual(pedidoDoModal);
    } else {
        console.error('Erro: Pedido não está disponível no modal.');
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao tentar baixar o pedido. Tente reabrir a consulta.";
        document.getElementById('modalErroPDF').classList.add('active');
    }
}

// FUNÇÃO AJUSTADA PARA GERAR PDF DO PEDIDO INDIVIDUALMENTE
window.gerarPdfPedidoIndividual = async function(pedido) {
    if (!pedido || !pedido.numPedido) {
        console.error('Erro: Pedido inválido para gerar PDF.');
        // Exibe o modal de erro se o pedido for inválido
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Pedido não encontrado. Tente novamente.";
        document.getElementById('modalErroPDF').classList.add('active');
        return;
    }

    // Inicia o loading, pois agora só é chamado via clique explícito
    window.mostrarCarregamento(true, 'GERANDO PDF DO PEDIDO...');
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // Tenta carregar o logo dinamicamente e converte para PRETO
        try {
            const logoUrl = "https://raw.githubusercontent.com/mblarson/sistema-pedidos-camisetas/main/50ANOS8080.png";
            
            // 1. Fetch original image
            const response = await fetch(logoUrl);
            const blob = await response.blob();
            
            // 2. Convert to Base64 (original)
            const originalBase64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });

            // 3. Create Image element to draw on Canvas
            const img = new Image();
            img.src = originalBase64;
            await new Promise(r => img.onload = r);

            // 4. Create Canvas
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            
            // 5. Draw image
            ctx.drawImage(img, 0, 0);
            
            // 6. Manipulate pixels to Black
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            for (let i = 0; i < data.length; i += 4) {
                const alpha = data[i + 3];
                // Se o pixel não for totalmente transparente, transforma em preto
                if (alpha > 0) {
                    data[i] = 0;     // Red -> 0
                    data[i + 1] = 0; // Green -> 0
                    data[i + 2] = 0; // Blue -> 0
                    // Alpha permanece o mesmo para manter a forma/transparência
                }
            }
            ctx.putImageData(imgData, 0, 0);
            
            // 7. Get new Base64 (Black Logo)
            const blackLogoData = canvas.toDataURL('image/png');

            // 8. Add to PDF
            doc.addImage(blackLogoData, 'PNG', 10, 10, 20, 20); // x=10, y=10 (Canto Superior Esquerdo)

        } catch (e) {
            console.warn("Logo não carregado no PDF", e);
        }
        
        // Título e Subtítulo
        doc.setFontSize(18); doc.text("PEDIDO #" + pedido.numPedido, 105, 20, null, null, "center");
        doc.setFontSize(10); doc.text("UMADEMATS - Jubileu de Ouro", 105, 26, null, null, "center");
        
        
        // Dados do Coordenador
        doc.setFontSize(11);
        doc.text(`Nome: ${pedido.nome}`, 14, 40);
        doc.text(`Local: ${pedido.local} - ${pedido.setor}`, 14, 46);
        doc.text(`Contato: ${pedido.contato || 'Não informado'}`, 14, 52);
        doc.text(`E-mail: ${pedido.email}`, 14, 58);
        doc.text(`Data: ${new Date(pedido.data).toLocaleDateString('pt-BR')}`, 140, 40);

        let bodyData = [];
        let totalQtd = 0;

        const addRows = (categoryName, dataObj) => {
            Object.entries(dataObj || {}).forEach(([tamanho, qtd]) => {
                if (qtd > 0) { 
                    // Adiciona a Categoria, Tamanho, e Quantidade
                    bodyData.push([categoryName, tamanho, qtd.toString()]); 
                    totalQtd += qtd; 
                }
            });
        };

        // Adiciona linhas de acordo com a estrutura (Novo vs Legado)
        if (!pedido.verdeOliva && !pedido.terracota) {
            addRows("Infantil (LEGADO)", pedido.infantil);
            addRows("Babylook (LEGADO)", pedido.babylook);
            addRows("Unissex (LEGADO)", pedido.unissex);
        } else {
            if (pedido.verdeOliva) {
                addRows("Verde - Infantil", pedido.verdeOliva.infantil);
                addRows("Verde - Babylook", pedido.verdeOliva.babylook);
                addRows("Verde - Unissex", pedido.verdeOliva.unissex);
            }
            if (pedido.terracota) {
                addRows("Terra - Infantil", pedido.terracota.infantil);
                addRows("Terra - Babylook", pedido.terracota.babylook);
                addRows("Terra - Unissex", pedido.terracota.unissex);
            }
        }

        const valorTotal = totalQtd * PRECO_CAMISETA;

        doc.autoTable({
            head: [['Categoria', 'Tamanho', 'Qtd']],
            body: bodyData,
            startY: 65,
            theme: 'striped',
            headStyles: { fillColor: [212, 175, 55] },
            styles: { fontSize: 10 },
        });

        // Resumo Financeiro e Total
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12); doc.setFont(undefined, 'bold');
        doc.text(`Total de Peças: ${totalQtd}`, 14, finalY);
        doc.text(`Valor Unitário: ${formatarMoeda(PRECO_CAMISETA)}`, 14, finalY + 6);
        doc.text(`Valor Total: ${formatarMoeda(valorTotal)}`, 14, finalY + 12);

        // Adiciona Observação se existir (Regra de PDF)
        if (pedido.observacao && pedido.observacao.trim() !== '') {
            const finalY2 = finalY + 20; 
            doc.setFontSize(10);
            doc.setTextColor(100); // Dark Gray
            doc.text("Observações:", 14, finalY2);
            
            doc.setFontSize(9);
            doc.setTextColor(0);
            // Quebra o texto para caber na largura da página (margin left 14 + right 14 approx)
            const splitObs = doc.splitTextToSize(pedido.observacao, 180);
            doc.text(splitObs, 14, finalY2 + 5);
        }

        // Abre o PDF
        doc.save(`Pedido_${pedido.numPedido}.pdf`);

    } catch (error) {
        console.error("Erro ao gerar PDF do Pedido Individual:", error);
        // Exibe o modal de erro (Regra 5)
        document.getElementById('modalErroPDF').querySelector('h2').textContent = "Erro na Geração";
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Não foi possível gerar o PDF. Tente novamente.";
        document.getElementById('modalErroPDF').classList.add('active');
    } finally {
        window.mostrarCarregamento(false);
    }
};

window.verificarPedidoPorEmail = async function(email) {
    try { const q = query(pedidosCollection, where("email", "==", email.toLowerCase().trim())); const snapshot = await getDocs(q); if (!snapshot.empty) return { docId: snapshot.docs[0].id, ...snapshot.docs[0].data() }; return null; } catch (error) { return null; }
};

window.prepararEdicaoViaBusca = function(pedido) {
    if(!SISTEMA_ABERTO) { 
        document.getElementById('modalPedidosFechados').classList.add('active'); 
        return; 
    }
    currentPedidoParaEdicao = pedido;
    window.setupEdicaoPedido();
};

window.displayVisualizacaoPedido = function(pedido) {
    const container = document.getElementById('resultadoConsulta');
    if(!container) return;
    
    const total = calcularTotalPedido(pedido);
    
    // Status visual
    let statusBadge = `<span style="background:rgba(255,255,255,0.1); color:#fff; padding:2px 8px; border-radius:4px; font-size:0.75rem;">PENDENTE</span>`;
    if(pedido.statusPagamento === 'Pago') {
        statusBadge = `<span style="background:rgba(100, 255, 218, 0.2); color:var(--success-color); padding:2px 8px; border-radius:4px; font-size:0.75rem; border:1px solid var(--success-color);">PAGO</span>`;
    } else if(pedido.statusPagamento === 'Parcial') {
        statusBadge = `<span style="background:rgba(255, 215, 0, 0.2); color:var(--warning-color); padding:2px 8px; border-radius:4px; font-size:0.75rem; border:1px solid var(--warning-color);">PARCIAL</span>`;
    }

    let obsHtml = '';
    if (pedido.observacao) {
        obsHtml = `<div style="margin-top:15px; background:rgba(255,215,0,0.05); padding:10px; border-radius:4px; border-left:3px solid var(--warning-color);"><p style="color:var(--warning-color); font-weight:700; font-size:0.75rem; margin-bottom:5px;">OBSERVAÇÕES</p><p style="color:#ddd; font-style:italic; font-size:0.85rem;">${escapeHTML(pedido.observacao)}</p></div>`;
    }

    // Tabela de itens
    let listaItens = '';
    const renderItems = (label, color, dataObj) => {
        let rows = '';
        if(!dataObj) return '';
        ['infantil', 'babylook', 'unissex'].forEach(tipo => {
            Object.entries(dataObj[tipo] || {}).forEach(([tam, qtd]) => {
                if(qtd > 0) {
                    rows += `<tr>
                        <td style="color:${color}">${label} - ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</td>
                        <td style="text-align:center; color:#fff;">${tam}</td>
                        <td style="text-align:right; color:#fff;">${qtd}</td>
                    </tr>`;
                }
            });
        });
        return rows;
    };

    if(pedido.verdeOliva || pedido.terracota) {
        listaItens += renderItems('Verde', 'var(--shirt-verde)', pedido.verdeOliva);
        listaItens += renderItems('Terra', 'var(--shirt-terracota)', pedido.terracota);
    } else {
        // Legado
        const legacyObj = { infantil: pedido.infantil, babylook: pedido.babylook, unissex: pedido.unissex };
        ['infantil', 'babylook', 'unissex'].forEach(tipo => {
             Object.entries(pedido[tipo] || {}).forEach(([tam, qtd]) => {
                if(qtd > 0) {
                    listaItens += `<tr>
                        <td style="color:#fff">Legado - ${tipo}</td>
                        <td style="text-align:center; color:#fff;">${tam}</td>
                        <td style="text-align:right; color:#fff;">${qtd}</td>
                    </tr>`;
                }
            });
        });
    }

    const html = `
        <div class="pedido-confirmacao-card" style="width:100%; max-width:600px; margin:2rem auto; border:1px solid var(--border-gold); animation: slideDown 0.4s ease;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem; margin-bottom:1rem;">
                <div>
                    <span style="display:block; font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">PEDIDO</span>
                    <span style="font-size:1rem; font-weight:700; color:var(--gold-solid);">#${pedido.numPedido}</span>
                </div>
                ${statusBadge}
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:1.5rem; font-size:0.9rem;">
                <div>
                    <span style="color:var(--text-muted); font-size:0.8rem;">LÍDER</span><br>
                    <span style="color:#fff;">${escapeHTML(pedido.nome)}</span>
                </div>
                <div>
                    <span style="color:var(--text-muted); font-size:0.8rem;">LOCAL</span><br>
                    <span style="color:#fff;">${escapeHTML(pedido.local)} / ${escapeHTML(pedido.setor)}</span>
                </div>
            </div>

            <div style="background:rgba(255,255,255,0.02); border-radius:8px; padding:10px;">
                <table style="width:100%; font-size:0.85rem; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid var(--border-subtle);">
                            <th style="text-align:left; padding:5px; color:var(--text-muted);">Item</th>
                            <th style="text-align:center; padding:5px; color:var(--text-muted);">Tam</th>
                            <th style="text-align:right; padding:5px; color:var(--text-muted);">Qtd</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${listaItens}
                    </tbody>
                </table>
            </div>
            
            ${obsHtml}

            <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-subtle); display:flex; justify-content:space-between; align-items:center;">
                <span style="color:var(--text-muted);">TOTAL</span>
                <span style="font-size:1.4rem; font-weight:700; color:#fff;">${formatarMoeda(total * PRECO_CAMISETA)}</span>
            </div>
            
            <div style="margin-top:1.5rem; display:flex; gap:10px;">
                 <button onclick='window.gerarPdfPedidoIndividual(${JSON.stringify(pedido).replace(/'/g, "&#39;")})' class="btn-primary" style="flex:1; padding:10px 0; font-size:0.8rem; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);">
                    <i class="fas fa-file-pdf" style="margin-right:8px;"></i> BAIXAR PDF
                </button>
                <button onclick='window.prepararEdicaoViaBusca(${JSON.stringify(pedido).replace(/'/g, "&#39;")})' class="btn-primary" style="flex:1; padding:10px 0; font-size:0.8rem;">
                    <i class="fas fa-edit" style="margin-right:8px;"></i> EDITAR
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
};

window.recuperarIdsPorEmail = async function(e) {
    e.preventDefault(); const email = document.getElementById('emailRecuperacao').value.toLowerCase().trim(); window.mostrarCarregamento(true);
    try { const q = query(pedidosCollection, where("email", "==", email)); const snapshot = await getDocs(q); const container = document.getElementById('listaIdsRecuperados');
        if (snapshot.empty) { container.innerHTML = `<p style="color:var(--danger-color)">NENHUM PEDIDO ENCONTRADO</p>`; } else { let html = ''; snapshot.forEach(doc => { const d = doc.data(); html += `<div style="background:rgba(255,255,255,0.05); padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:4px;"><span>#${d.numPedido}</span><button onclick="window.copiarNumeroPedido('${d.numPedido}')" style="cursor:pointer; background:none; border:none; color:var(--gold-solid); font-size:0.8rem; font-weight:600;">COPIAR</button></div>`; }); container.innerHTML = html; }
    } catch (error) { console.error(error); } finally { window.mostrarCarregamento(false); }
};

window.verificarPedidoPorSetor = async function(setor) {
    try { const q = query(pedidosCollection, where("setor", "==", normalizeString(setor))); const snapshot = await getDocs(q); if (!snapshot.empty) return { docId: snapshot.docs[0].id, ...snapshot.docs[0].data() }; return null; } catch (error) { return null; }
};

window.verificarPedidoPorNumero = async function(numPedido) {
    try { const docRef = doc(db, "pedidos", numPedido.trim()); const docSnap = await getDoc(docRef); if (docSnap.exists()) { return { docId: docSnap.id, numPedido: docSnap.data().numPedido || docSnap.id, ...docSnap.data() }; } const q = query(pedidosCollection, where("numPedido", "==", numPedido.trim())); const qs = await getDocs(q); if (!qs.empty) return { docId: qs.docs[0].id, ...qs.docs[0].data() }; return null; } catch (error) { return null; }
};

window.updateSetorCidadeInput = function(val = '') {
    const container = document.getElementById('setorCidadeContainer'); const radioCapital = document.getElementById('radioCapital');
    if (!container || !radioCapital) return;
    const isCapital = radioCapital.checked;
    if (isCapital) { const setores = ['A', 'B', 'C1', 'C2', 'D', 'E', 'F', 'G', 'H', 'I', 'M', 'N']; container.innerHTML = `<select id="setor" name="setor" required><option value="" disabled selected>SELECIONE</option>${setores.map(s => `<option value="SETOR ${s}">SETOR ${s}</option>`).join('')}</select>`; const sel = document.getElementById('setor'); if (val && Array.from(sel.options).some(o => o.value === normalizeString(val))) sel.value = normalizeString(val); } else { container.innerHTML = `<input type="text" id="setor" name="setor" placeholder="CIDADE" required value="${val}">`; }
};

window.setupNovoPedido = function() {
    currentPedidoParaEdicao = null;
    document.getElementById('pedidoDocId').value = '';
    document.getElementById('formPedido').reset();
    document.getElementById('submitButtonText').textContent = 'Confirmar e Enviar';
    const radioCapital = document.querySelector(`input[name="local"][value="Capital"]`);
    if (radioCapital) radioCapital.checked = true;
    window.updateSetorCidadeInput();
};

window.setupEdicaoPedido = function() {
    if (!SISTEMA_ABERTO) { document.getElementById('modalPedidosFechados').classList.add('active'); return; }
    const pedido = currentPedidoParaEdicao; if (!pedido) return;
    
    document.getElementById('pedidoDocId').value = pedido.docId;
    document.getElementById('nome').value = pedido.nome;
    const radioLocal = document.querySelector(`input[name="local"][value="${pedido.local}"]`); if (radioLocal) radioLocal.checked = true;
    window.updateSetorCidadeInput(pedido.setor);
    document.getElementById('email').value = pedido.email;
    document.getElementById('contato').value = pedido.contato || '';
    
    // PREECHER CAMPO DE OBSERVAÇÃO
    const obsField = document.getElementById('observacao');
    if (obsField) obsField.value = pedido.observacao || '';
    
    // PREECHER TAMANHOS (Suporta Legado e Novo)
    const preencher = (obj, prefix) => {
        for (const [t, q] of Object.entries(obj || {})) {
            const input = document.getElementById(`${prefix}_${t}`);
            if (input) input.value = q;
        }
    };

    // Se tem estrutura nova, usa ela
    if (pedido.verdeOliva || pedido.terracota) {
        if (pedido.verdeOliva) {
            preencher(pedido.verdeOliva.infantil, 'verde_infantil');
            preencher(pedido.verdeOliva.babylook, 'verde_babylook');
            preencher(pedido.verdeOliva.unissex, 'verde_unissex');
        }
        if (pedido.terracota) {
            preencher(pedido.terracota.infantil, 'terracota_infantil');
            preencher(pedido.terracota.babylook, 'terracota_babylook');
            preencher(pedido.terracota.unissex, 'terracota_unissex');
        }
    } else {
        // Não usar alert. Usar console.warn ou modal se for crítico.
        console.warn("Atenção: Este pedido é antigo (sem cor definida). Por favor, redistribua as quantidades nas cores Verde e Terracota.");
    }
    
    document.getElementById('submitButtonText').textContent = 'Atualizar Pedido';
    window.redirecionarComAnimacao('pedido');
};

// NOVA FUNÇÃO PARA EXIBIR MODAL COM DETALHES COMPLETOS
window.exibirModalDetalhesPedido = function(pedido) {
    // REGRA: Download automático removido.
    // O PDF só será gerado ao clicar em "BAIXAR PEDIDO".

    currentPedidoParaEdicao = pedido; // Necessário para setupEdicaoPedido
    pedidoDoModal = pedido; // Armazena o pedido completo na variável global
    const container = document.getElementById('conteudoDetalhesPedido');
    const total = calcularTotalPedido(pedido);
    
    // HTML da Observação se existir
    let obsHtml = '';
    if (pedido.observacao && pedido.observacao.trim() !== '') {
        obsHtml = `
            <div style="grid-column:1/-1; margin-top:1rem; background:rgba(255,215,0,0.05); padding:1rem; border-left:3px solid var(--warning-color); border-radius:4px;">
                <p style="color:var(--warning-color); font-weight:700; font-size:0.8rem; margin-bottom:5px;">OBSERVAÇÕES</p>
                <p style="color:#eee; font-style:italic; white-space: pre-wrap;">${escapeHTML(pedido.observacao)}</p>
            </div>
        `;
    }

    let html = `
        <div style="margin-bottom:1.5rem;">
            <div style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:var(--radius-md); border:1px solid var(--border-subtle);">
                <p style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase;">ID do Pedido</p>
                <p style="font-size:1.5rem; color:var(--gold-solid); font-weight:700; word-break:break-all;">#${pedido.numPedido}</p>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.5rem; font-size:0.9rem;">
            <div><p style="color:var(--text-muted);">Nome</p><p style="color:#fff;">${pedido.nome}</p></div>
            <div><p style="color:var(--text-muted);">Contato</p><p style="color:#fff;">${pedido.contato || '-'}</p></div>
            <div><p style="color:var(--text-muted);">Local</p><p style="color:#fff;">${pedido.local}</p></div>
            <div><p style="color:var(--text-muted);">Setor/Cidade</p><p style="color:#fff;">${pedido.setor}</p></div>
            <div style="grid-column:1/-1;"><p style="color:var(--text-muted);">E-mail</p><p style="color:#fff;">${pedido.email}</p></div>
            ${obsHtml}
        </div>
    `;

    const generateTable = (title, color, dataObj) => {
        let rows = '';
        const add = (cat, items) => {
            Object.entries(items || {}).forEach(([tam, qtd]) => {
                if(qtd > 0) rows += `<tr><td style="padding:8px; color:#ddd;">${cat}</td><td style="padding:8px; color:#fff; font-weight:bold;">${tam}</td><td style="padding:8px; text-align:right; color:#ddd;">${qtd}</td></tr>`;
            });
        };
        
        if (dataObj) {
            add('Infantil', dataObj.infantil);
            add('Babylook', dataObj.babylook);
            add('Unissex', dataObj.unissex);
        } else {
                // Legacy support if passed directly
                add('Infantil', pedido.infantil);
                add('Babylook', pedido.babylook);
                add('Unissex', pedido.unissex);
        }

        if(rows) {
            return `
                <div style="margin-bottom:1rem;">
                    <p style="color:${color}; font-weight:bold; margin-bottom:0.5rem; font-size:0.9rem; text-transform:uppercase;">${title}</p>
                    <table style="width:100%; font-size:0.85rem; border-collapse:collapse; background:rgba(0,0,0,0.2); border-radius:4px;">
                        <tr style="background:rgba(255,255,255,0.05);"><th style="text-align:left; padding:8px; color:var(--text-muted);">Tipo</th><th style="text-align:left; padding:8px; color:var(--text-muted);">Tam</th><th style="text-align:right; padding:8px; color:var(--text-muted);">Qtd</th></tr>
                        ${rows}
                    </table>
                </div>
            `;
        }
        return '';
    };

    if(pedido.verdeOliva || pedido.terracota) {
        if(pedido.verdeOliva) html += generateTable('Verde Oliva', 'var(--shirt-verde)', pedido.verdeOliva);
        if(pedido.terracota) html += generateTable('Terracota', 'var(--shirt-terracota)', pedido.terracota);
    } else {
        html += generateTable('Itens (Legado)', '#fff', null);
    }

    html += `
        <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-subtle); text-align:right;">
            <p style="font-size:0.9rem; color:var(--text-muted);">Total de Peças: <span style="color:#fff; font-weight:bold;">${total}</span></p>
            <p style="font-size:1.2rem; color:var(--gold-solid); font-weight:700;">${formatarMoeda(total * PRECO_CAMISETA)}</p>
        </div>
    `;

    container.innerHTML = html;
    
    // Configura o botão de edição
    const btnEdit = document.getElementById('btnEditarNoModal');
    if(btnEdit) {
        btnEdit.onclick = function() {
            if (!SISTEMA_ABERTO) { 
                document.getElementById('modalDetalhesPedido').classList.remove('active');
                document.getElementById('modalPedidosFechados').classList.add('active'); 
                return; 
            }
            document.getElementById('modalDetalhesPedido').classList.remove('active');
            window.setupEdicaoPedido();
        };
    }

    // CORREÇÃO: Configura o novo botão de baixar chamando a nova função auxiliar
    const btnBaixar = document.getElementById('btnBaixarNoModal');
    btnBaixar.setAttribute('onclick', `window.baixarPedidoDoModal()`);


    document.getElementById('modalDetalhesPedido').classList.add('active');
};

/**
 * AGGREGATED COUNTERS (CONTADORES AGREGADOS)
 * Helper para extrair o mapa de quantidades (SKUs) de um pedido ou formulário.
 * Retorna objeto com chaves planas ex: 'verde_infantil_4': 2
 */
function getSkuMap(source, isForm = false) {
    const map = {};
    const cores = ['verde', 'terracota'];
    const tipos = ['infantil', 'babylook', 'unissex'];
    const tamanhosInf = ['1','2','4','6','8','10','12','14'];
    const tamanhosAdulto = ['PP','P','M','G','GG','XGG'];

    cores.forEach(cor => {
        tipos.forEach(tipo => {
            const tams = tipo === 'infantil' ? tamanhosInf : tamanhosAdulto;
            tams.forEach(tam => {
                // Chave padrão: cor_tipo_tamanho (ex: verde_infantil_4)
                const key = `${cor}_${tipo}_${tam}`;
                let val = 0;
                
                if (isForm) {
                    // Lendo do HTML (IDs dos inputs seguem o padrão da chave)
                    const el = document.getElementById(key);
                    val = el ? (parseInt(el.value) || 0) : 0;
                } else {
                    // Lendo do objeto Pedido do Firestore
                    // Firestore structure: pedido.verdeOliva.infantil['4']
                    const colorKey = cor === 'verde' ? 'verdeOliva' : 'terracota';
                    if (source && source[colorKey] && source[colorKey][tipo]) {
                        val = parseInt(source[colorKey][tipo][tam]) || 0;
                    }
                }
                
                if (val > 0) map[key] = val;
            });
        });
    });
    return map;
}

// ===============================================
// LÓGICA REFORMULADA: FIRESTORE TRANSACTION (COM AGREGAÇÃO)
// ===============================================
window.handleFormSubmission = async function(e) {
    e.preventDefault();
    if (!SISTEMA_ABERTO) { document.getElementById('modalPedidosFechados').classList.add('active'); return; }

    const docId = document.getElementById('pedidoDocId').value;
    const isEditing = !!docId;

    const formData = new FormData(document.getElementById('formPedido'));
    const email = formData.get('email').toLowerCase().trim();
    const setor = normalizeString(formData.get('setor'));
    const local = formData.get('local'); // Capital ou Interior
    
    if (!isValidEmail(email)) { window.exibirMensagem('mensagemPedido', 'erro', 'E-MAIL INVÁLIDO'); return; }

    const contatoInput = formData.get('contato');
    const contatoNumeros = contatoInput ? contatoInput.replace(/\D/g, '') : '';
    if (!contatoNumeros || contatoNumeros.length < 11) {
        window.exibirMensagem('mensagemPedido', 'erro', 'O CELULAR É OBRIGATÓRIO (COM DDD)');
        document.getElementById('contato').focus();
        return;
    }

    // Duplicidade Checks (simplificados para leitura)
    // LÓGICA DE VALIDAÇÃO AJUSTADA: PERMITE SALVAR SE FOR O PRÓPRIO PEDIDO
    const dupEmail = await window.verificarPedidoPorEmail(email);
    if (dupEmail && (!isEditing || dupEmail.docId !== docId)) {
        window.exibirMensagem('mensagemPedido', 'erro', 'ESTE E-MAIL JÁ POSSUI UM PEDIDO REGISTRADO.');
        return; 
    }
    
    if (local === 'Capital') {
        const dupSetor = await window.verificarPedidoPorSetor(setor);
        if (dupSetor && (!isEditing || dupSetor.docId !== docId)) {
            window.exibirMensagem('mensagemPedido', 'erro', `O ${setor} JÁ POSSUI UM PEDIDO REGISTRADO (CAPITAL).`);
            return;
        }
    }

    // Calcular Totais do Formulário
    const getQtd = (prefix) => getQuantidadesFromForm(formData, prefix);
    const vInf = getQtd('verde_infantil'); const vBaby = getQtd('verde_babylook'); const vUni = getQtd('verde_unissex');
    const tInf = getQtd('terracota_infantil'); const tBaby = getQtd('terracota_babylook'); const tUni = getQtd('terracota_unissex');
    
    const sumObj = (obj) => Object.values(obj || {}).reduce((a, b) => a + b, 0);
    const qtdInf = sumObj(vInf) + sumObj(tInf);
    const qtdBaby = sumObj(vBaby) + sumObj(tBaby);
    const qtdUni = sumObj(vUni) + sumObj(tUni);
    const totalPecas = qtdInf + qtdBaby + qtdUni;
    const valorTotal = totalPecas * PRECO_CAMISETA;

    if (totalPecas === 0) { window.exibirMensagem('mensagemPedido', 'erro', 'ADICIONE PELO MENOS 1 CAMISETA'); return; }
    
    window.mostrarCarregamento(true, "SALVANDO (TRANSAÇÃO)...");

    try {
        await runTransaction(db, async (transaction) => {
            // 1. Referência Estatísticas
            const estatisticasRef = doc(db, "configuracoes", "estatisticas");
            const statsSnap = await transaction.get(estatisticasRef);
            
            if (!statsSnap.exists()) {
                throw "Estatísticas não inicializadas!";
            }
            const stats = statsSnap.data();

            // 2. Preparar Dados do Pedido
            const dadosPedido = {
                nome: formData.get('nome'),
                local: local,
                setor: setor,
                email: email,
                contato: formData.get('contato'),
                observacao: formData.get('observacao'), 
                verdeOliva: { infantil: vInf, babylook: vBaby, unissex: vUni },
                terracota: { infantil: tInf, babylook: tBaby, unissex: tUni },
                ...(isEditing ? {} : { data: new Date().toISOString(), statusPagamento: 'Pendente' }) 
            };
            // Limpa undefined
            Object.keys(dadosPedido).forEach(key => dadosPedido[key] === undefined && delete dadosPedido[key]);

            // Mapas de SKU e Locais para o cálculo de Delta
            const novoMapaSku = getSkuMap(null, true); // Lê do DOM (inputs atuais)
            const novaChaveLocal = `local_${local}_${setor}`; // Ex: local_Capital_SetorA

            // Objeto de updates para o documento de estatísticas
            const updatesStats = {};

            if (isEditing) {
                // --- EDIÇÃO ATÔMICA ---
                const pedidoRef = doc(db, "pedidos", docId);
                const pedidoSnap = await transaction.get(pedidoRef);
                if (!pedidoSnap.exists()) throw "Pedido original não encontrado.";
                
                const pAntigo = pedidoSnap.data();
                
                // Totais Financeiros Antigos
                let oldInf = 0, oldBaby = 0, oldUni = 0;
                const sum = (obj) => Object.values(obj || {}).reduce((a, b) => a + b, 0);
                if (pAntigo.verdeOliva || pAntigo.terracota) {
                    if(pAntigo.verdeOliva) { oldInf += sum(pAntigo.verdeOliva.infantil); oldBaby += sum(pAntigo.verdeOliva.babylook); oldUni += sum(pAntigo.verdeOliva.unissex); }
                    if(pAntigo.terracota) { oldInf += sum(pAntigo.terracota.infantil); oldBaby += sum(pAntigo.terracota.babylook); oldUni += sum(pAntigo.terracota.unissex); }
                } else {
                    oldInf += sum(pAntigo.infantil); oldBaby += sum(pAntigo.babylook); oldUni += sum(pAntigo.unissex);
                }
                const oldTotalPecas = oldInf + oldBaby + oldUni;
                const oldValorTotal = oldTotalPecas * PRECO_CAMISETA;

                // --- CÁLCULO DE DELTA (ESTOQUE / SKUS) ---
                const antigoMapaSku = getSkuMap(pAntigo, false);
                const todasAsChaves = new Set([...Object.keys(novoMapaSku), ...Object.keys(antigoMapaSku)]);
                
                todasAsChaves.forEach(key => {
                    const qtdNova = novoMapaSku[key] || 0;
                    const qtdAntiga = antigoMapaSku[key] || 0;
                    const delta = qtdNova - qtdAntiga;
                    if (delta !== 0) {
                        updatesStats[key] = increment(delta);
                    }
                });

                // --- CÁLCULO DE DELTA (LOCALIDADES) ---
                // Verifica se mudou de local/setor
                const antigaChaveLocal = `local_${pAntigo.local}_${pAntigo.setor}`;
                if (antigaChaveLocal !== novaChaveLocal) {
                    // Remove do antigo (todos os itens antigos)
                    updatesStats[antigaChaveLocal] = increment(-oldTotalPecas); // Remove qtd antiga do bucket antigo
                    updatesStats[novaChaveLocal] = increment(totalPecas);       // Adiciona qtd nova no bucket novo
                } else {
                    // Mesmo local, apenas ajusta a diferença de quantidade
                    const deltaQtd = totalPecas - oldTotalPecas;
                    if (deltaQtd !== 0) {
                        updatesStats[novaChaveLocal] = increment(deltaQtd);
                    }
                }

                // --- CÁLCULO GERAL (FINANCEIRO E CATEGORIAS) ---
                updatesStats['qtd_camisetas'] = increment(totalPecas - oldTotalPecas);
                updatesStats['valor_total'] = increment(valorTotal - oldValorTotal);
                updatesStats['qtd_infantil'] = increment(qtdInf - oldInf);
                updatesStats['qtd_babylook'] = increment(qtdBaby - oldBaby);
                updatesStats['qtd_unissex'] = increment(qtdUni - oldUni);

                // Executa Updates
                transaction.update(pedidoRef, dadosPedido);
                transaction.update(estatisticasRef, updatesStats);
                
                setTimeout(() => window.exibirConfirmacaoPedido({ numPedido: pAntigo.numPedido, ...dadosPedido }), 100);

            } else {
                // --- CRIAÇÃO ATÔMICA ---
                const newPedidoRef = doc(collection(db, "pedidos"));
                dadosPedido.numPedido = newPedidoRef.id;
                
                // SKUs
                Object.keys(novoMapaSku).forEach(key => {
                    updatesStats[key] = increment(novoMapaSku[key]);
                });

                // Localidade
                updatesStats[novaChaveLocal] = increment(totalPecas);

                // Geral
                updatesStats['qtd_pedidos'] = increment(1);
                updatesStats['qtd_camisetas'] = increment(totalPecas);
                updatesStats['valor_total'] = increment(valorTotal);
                updatesStats['qtd_infantil'] = increment(qtdInf);
                updatesStats['qtd_babylook'] = increment(qtdBaby);
                updatesStats['qtd_unissex'] = increment(qtdUni);

                transaction.set(newPedidoRef, dadosPedido);
                transaction.update(estatisticasRef, updatesStats);
                
                setTimeout(() => window.exibirConfirmacaoPedido(dadosPedido), 100);
            }
        });

        document.getElementById('formPedido').reset();
        window.carregarDashboard();
        
        if(isEditing) {
            currentPedidoParaEdicao = null;
            document.getElementById('pedidoDocId').value = '';
            document.getElementById('submitButtonText').textContent = 'Confirmar e Enviar';
        }

    } catch (err) { 
        window.exibirMensagem('mensagemPedido', 'erro', 'ERRO AO SALVAR: ' + err); 
        console.error(err); 
    } finally { 
        window.mostrarCarregamento(false); 
    }
};

window.handleAdminLogin = async function(e) {
    e.preventDefault(); 
    const email = document.getElementById('emailAdmin').value.trim(); 
    const senha = document.getElementById('senhaAdmin').value;
    
    window.mostrarCarregamento(true, "AUTENTICANDO...");
    console.log("LOG: Tentativa de Login Admin iniciada para:", email); // LOG DE DEBUG

    try { 
        await signInWithEmailAndPassword(auth, email, senha); 
        
        console.log("LOG: Login Firebase BEM-SUCEDIDO."); // LOG DE DEBUG
        
        document.getElementById('loginAdmin').style.display = 'none'; 
        document.getElementById('painelAdmin').style.display = 'block'; 
        
        console.log("LOG: Painel Admin exibido após login manual."); // LOG DE DEBUG

        window.carregarDashboard();
        window.adminAcessouPainel = true;

    } catch (error) { 
        console.error("LOG: Erro no login Firebase:", error.code, error.message); // LOG DE DEBUG
        document.getElementById('modalErroLogin').classList.add('active'); 
    } finally { 
        window.mostrarCarregamento(false); 
    }
};

// Altera a função para sempre buscar novos dados, se o cache estiver vazio
window.carregarTodosPedidos = async function(force = false) { 
    if (!force && window.pedidosCache && window.pedidosCache.length > 0) {
        return window.pedidosCache;
    }
    const s = await getDocs(pedidosCollection); 
    window.pedidosCache = s.docs.map(d => ({ docId: d.id, ...d.data() }));
    return window.pedidosCache;
};

// DASHBOARD REFORMULADO: LEITURA DIRETA DO DOC ESTATÍSTICAS
window.carregarDashboard = async function() {
    try {
        const statsRef = doc(db, "configuracoes", "estatisticas");
        const docSnap = await getDoc(statsRef);
        
        let stats = {
            qtd_pedidos: 0,
            qtd_camisetas: 0,
            qtd_infantil: 0,
            qtd_babylook: 0,
            qtd_unissex: 0,
            valor_total: 0,
            total_recebido_real: 0
        };

        if (docSnap.exists()) {
            stats = docSnap.data();
        } else {
            console.warn("Stats missing, displaying zero.");
        }

        // Atualiza a UI diretamente com os valores lidos (sem loop)
        window.atualizarElemento('totalPedidos', stats.qtd_pedidos || 0);
        window.atualizarElemento('totalCamisetas', stats.qtd_camisetas || 0);
        window.atualizarElemento('totalArrecadado', formatarMoeda(stats.valor_total || 0));
        window.atualizarElemento('totalRecebidoReal', formatarMoeda(stats.total_recebido_real || 0));
        
        window.atualizarElemento('totalInfantis', stats.qtd_infantil || 0);
        window.atualizarElemento('totalBabylook', stats.qtd_babylook || 0);
        window.atualizarElemento('totalUnissex', stats.qtd_unissex || 0);

    } catch (e) {
        console.error("Erro ao carregar dashboard:", e);
    }
};

window.togglePedidoDetails = function(docId) {
    const detailsDiv = document.getElementById(`details-${docId}`); const icon = document.getElementById(`icon-${docId}`);
    if (detailsDiv.style.display === 'none') { detailsDiv.style.display = 'block'; icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-down'); }
    else { detailsDiv.style.display = 'none'; icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-right'); }
};

// FUNÇÃO QUE ABRE O MODAL DE CONFIRMAÇÃO DE EXCLUSÃO
window.abrirModalExcluirPedido = function(docId) {
    pedidoParaExcluir = docId;
    document.getElementById('excluirPedidoDocId').value = docId;
    document.getElementById('modalExcluirPedido').classList.add('active');
};

// FUNÇÃO PARA EXCLUIR O PEDIDO NO FIREBASE (AGORA COM TRANSACTION E AGGREGATED COUNTERS)
window.excluirPedido = async function() {
    const docId = document.getElementById('excluirPedidoDocId').value;
    if (!docId) return;

    document.getElementById('modalExcluirPedido').classList.remove('active');
    window.mostrarCarregamento(true, "EXCLUINDO (TRANSAÇÃO)...");

    try {
        await runTransaction(db, async (transaction) => {
            const pedidoRef = doc(db, "pedidos", docId);
            const estatisticasRef = doc(db, "configuracoes", "estatisticas");

            const [pedidoSnap, statsSnap] = await Promise.all([
                transaction.get(pedidoRef),
                transaction.get(estatisticasRef)
            ]);

            if (!pedidoSnap.exists()) throw "Pedido não encontrado.";
            if (!statsSnap.exists()) throw "Estatísticas não encontradas.";
            
            const p = pedidoSnap.data();
            const stats = statsSnap.data();
            
            // Calcula totais a remover
            const sum = (obj) => Object.values(obj || {}).reduce((a, b) => a + b, 0);
            let qInf = 0, qBaby = 0, qUni = 0;
            
            if (p.verdeOliva || p.terracota) {
                if(p.verdeOliva) { qInf += sum(p.verdeOliva.infantil); qBaby += sum(p.verdeOliva.babylook); qUni += sum(p.verdeOliva.unissex); }
                if(p.terracota) { qInf += sum(p.terracota.infantil); qBaby += sum(p.terracota.babylook); qUni += sum(p.terracota.unissex); }
            } else {
                qInf += sum(p.infantil); qBaby += sum(p.babylook); qUni += sum(p.unissex);
            }
            
            const totalPecas = qInf + qBaby + qUni;
            const valorTotal = totalPecas * PRECO_CAMISETA;

            // Updates Object
            const updatesStats = {
                qtd_pedidos: increment(-1),
                qtd_camisetas: increment(-totalPecas),
                valor_total: increment(-valorTotal),
                qtd_infantil: increment(-qInf),
                qtd_babylook: increment(-qBaby),
                qtd_unissex: increment(-qUni)
            };

            // Remover do Estoque (Aggregated Keys)
            const mapaSku = getSkuMap(p, false);
            Object.keys(mapaSku).forEach(key => {
                updatesStats[key] = increment(-mapaSku[key]); // Decrementa a qtd
            });

            // Remover do Local (Aggregated Key)
            const chaveLocal = `local_${p.local}_${p.setor}`;
            updatesStats[chaveLocal] = increment(-totalPecas);

            // Executa exclusão e atualização
            transaction.delete(pedidoRef);
            transaction.update(estatisticasRef, updatesStats);
        });

        // Atualiza a interface
        window.pedidosCache = []; 
        await window.carregarPedidos();
        await window.carregarDashboard(); 
        
        window.exibirMensagem('mensagemLogin', 'sucesso', `Pedido removido e estatísticas atualizadas.`);
        
    } catch (error) {
        console.error("Erro ao excluir documento: ", error);
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao excluir o pedido. Tente novamente.";
        document.getElementById('modalErroPDF').classList.add('active');
    } finally {
        window.mostrarCarregamento(false);
        pedidoParaExcluir = null;
    }
};


// FILTRO E BUSCA ATUALIZADOS
// FILTRO E BUSCA ATUALIZADOS (COM SEGURANÇA APLICADA)
// FUNÇÃO DE CARREGAMENTO PAGINADO (10 POR VEZ)
// FUNÇÃO DE CARREGAMENTO COM BUSCA OTIMIZADA (ITEM C) E PAGINAÇÃO (ITEM A)
window.carregarPedidos = async function(modoExpandir = false) {
    const btnExpandirExistente = document.getElementById('btnCarregarMais');
    if (modoExpandir) {
        window.mostrarCarregamento(true, 'CARREGANDO MAIS...');
    } else {
        // Se for busca inicial (oninput ou refresh), não mostra loader intrusivo para digitar fluido, apenas se necessário.
        const isSearch = document.getElementById('buscaInput').value.trim().length > 0;
        if(!isSearch) window.mostrarCarregamento(true, 'BUSCANDO...');
        
        // Se não for expansão, limpa tudo para começar do zero
        document.getElementById('listaPedidos').innerHTML = '';
        ultimoDocumentoCarregado = null;
        window.pedidosCache = [];
        if(btnExpandirExistente) btnExpandirExistente.remove();
    }

    const lista = document.getElementById('listaPedidos');
    
    // Captura os valores de busca
    const inputBusca = document.getElementById('buscaInput');
    const termoBusca = inputBusca.value.trim(); // Mantém Maiúsculas/Minúsculas para ID
    const termoBuscaLower = termoBusca.toLowerCase();
    const filtroLocal = document.querySelector('input[name="filtroLocal"]:checked').value;

    try {
        let pedidosProcessados = [];
        // Aumentamos o limite para garantir que, após o filtro local (client-side), sobrem itens.
        const qtdPorPagina = 50;

        // ============================================================
        // TAREFA 1: BUSCA UNIVERSAL INDEXADA (Refatorado)
        // ============================================================
        if (termoBusca) {
            // Executa 3 estratégias de busca em paralelo
            const p1 = getDocs(query(pedidosCollection, where('numPedido', '==', termoBusca))); // ID Exato
            const p2 = getDocs(query(pedidosCollection, where('email', '==', termoBuscaLower))); // Email Exato
            // Nome Prefixo: Encontra 'Maria' -> 'Maria Silva', 'Mariana', etc.
            const p3 = getDocs(query(pedidosCollection, orderBy('nome'), startAt(termoBusca), endAt(termoBusca + '\uf8ff'), limit(20)));
            // Estratégia 4: Busca Geral nos Últimos 100 para encontrar Telefone, Setor, Local (Super Busca)
            const p4 = getDocs(query(pedidosCollection, orderBy('data', 'desc'), limit(100)));

            const [snapId, snapEmail, snapNome, snapGeral] = await Promise.all([p1, p2, p3, p4]);

            // Combinação e Deduplicação usando Map
            const mapResultados = new Map();
            
            const processarSnap = (snap) => {
                snap.forEach(doc => {
                    if (!mapResultados.has(doc.id)) {
                        mapResultados.set(doc.id, { docId: doc.id, ...doc.data() });
                    }
                });
            };

            processarSnap(snapId);
            processarSnap(snapEmail);
            processarSnap(snapNome);
            processarSnap(snapGeral);

            pedidosProcessados = Array.from(mapResultados.values());

            // FILTRAGEM CLIENT-SIDE AVANÇADA (SUPER BUSCA)
            // Garante que o termo digitado exista em algum dos campos principais
            pedidosProcessados = pedidosProcessados.filter(p => {
                const term = termoBuscaLower;
                // Normaliza e verifica campos
                const matchNome = p.nome && p.nome.toLowerCase().includes(term);
                const matchEmail = p.email && p.email.toLowerCase().includes(term);
                const matchId = p.numPedido && p.numPedido.toLowerCase().includes(term);
                const matchContato = p.contato && p.contato.toLowerCase().includes(term); // Verifica telefone com caracteres simples
                const matchSetor = p.setor && p.setor.toLowerCase().includes(term);     // Verifica Setor/Cidade
                const matchLocal = p.local && p.local.toLowerCase().includes(term);     // Verifica Capital/Interior
                const matchObs = p.observacao && p.observacao.toLowerCase().includes(term); // Bônus: Obs

                return matchNome || matchEmail || matchId || matchContato || matchSetor || matchLocal || matchObs;
            });

            // Ordenação manual pois as queries paralelas não garantem ordem cronológica
            pedidosProcessados.sort((a, b) => {
                const dA = a.data || '';
                const dB = b.data || '';
                return dB.localeCompare(dA); // Decrescente
            });

            // TAREFA 3 (Correção): Aplica o filtro de Local nos resultados da busca
            // Isso garante que se o user buscar 'João' e filtrar 'Interior', só veja Joões do Interior.
            if (filtroLocal !== 'todos') {
                pedidosProcessados = pedidosProcessados.filter(p => p.local === filtroLocal);
            }

        } else {
            // --- LISTAGEM PADRÃO PAGINADA (AGORA COM FILTRO SERVER-SIDE) ---
            
            let constraints = [];

            // TAREFA 1: Aplicar filtro de Local direto no banco
            if (filtroLocal !== 'todos') {
                constraints.push(where('local', '==', filtroLocal));
            }

            constraints.push(orderBy('data', 'desc'));

            if (modoExpandir && ultimoDocumentoCarregado) {
                constraints.push(startAfter(ultimoDocumentoCarregado));
            }

            // Buscamos itens (agora filtrados corretamente pelo banco)
            constraints.push(limit(qtdPorPagina));
            
            const q = query(pedidosCollection, ...constraints);
            const snapshot = await getDocs(q);
            
            // Atualiza o cursor para a próxima página
            if (!snapshot.empty) {
                ultimoDocumentoCarregado = snapshot.docs[snapshot.docs.length - 1];
            }

            pedidosProcessados = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));
        }

        // Renderização
        if (pedidosProcessados.length === 0 && !modoExpandir) {
            // Mensagem amigável explicando como buscar
            const msg = termoBusca 
                ? `Nenhum pedido encontrado para "<strong>${escapeHTML(termoBusca)}</strong>" nos registros recentes.` 
                : `Nenhum pedido registrado ou encontrado com o filtro atual.`;
            
            lista.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding:2rem;">${msg}</p>`;
        } else {
            pedidosProcessados.forEach(x => {
                const t = calcularTotalPedido(x);
                
                let tabelaHTML = `<table class="tabela-detalhe-pedido"><thead><tr><th>Categoria</th><th>Tamanho</th><th>Qtd</th></tr></thead><tbody>`;
                const addRows = (cat, obj) => { let rows = ''; Object.entries(obj || {}).forEach(([tam, qtd]) => { if(qtd > 0) rows += `<tr><td>${cat}</td><td>${tam}</td><td>${qtd}</td></tr>`; }); return rows; };
                
                if(!x.verdeOliva && !x.terracota) {
                    tabelaHTML += addRows('Infantil', x.infantil); tabelaHTML += addRows('Babylook', x.babylook); tabelaHTML += addRows('Unissex', x.unissex);
                } else {
                    if(x.verdeOliva) {
                        tabelaHTML += addRows('Verde - Inf', x.verdeOliva.infantil);
                        tabelaHTML += addRows('Verde - Baby', x.verdeOliva.babylook);
                        tabelaHTML += addRows('Verde - Uni', x.verdeOliva.unissex);
                    }
                    if(x.terracota) {
                        tabelaHTML += addRows('Terra - Inf', x.terracota.infantil);
                        tabelaHTML += addRows('Terra - Baby', x.terracota.babylook);
                        tabelaHTML += addRows('Terra - Uni', x.terracota.unissex);
                    }
                }
                tabelaHTML += `</tbody></table>`;

                // Verifica se tem observação para exibir indicador
                const hasObs = x.observacao && x.observacao.trim() !== '';
                const obsIcon = hasObs ? '<i class="fas fa-sticky-note" style="color:var(--warning-color); margin-left:5px;" title="Possui Observação"></i>' : '';
                const obsHtml = hasObs ? `<div style="margin-top:10px; background:rgba(255,215,0,0.1); padding:10px; border-radius:4px; border-left:3px solid var(--warning-color);"><strong style="color:var(--warning-color); font-size:0.75rem;">OBSERVAÇÃO:</strong><br><span style="color:#ddd; font-style:italic; font-size:0.85rem;">${escapeHTML(x.observacao)}</span></div>` : '';

                // Lógica do WhatsApp (NOVA IMPLEMENTAÇÃO)
                const rawPhone = (x.contato || '').replace(/\D/g, '');
                let waLink = '';
                if(rawPhone.length >= 10) {
                    const msgWa = encodeURIComponent("Prezado, Lider! Segue sua ultima lista para conferência. \nFicamos no aguardo do seu ok para mandar para produção.");
                    waLink = `<a href="https://wa.me/55${rawPhone}?text=${msgWa}" target="_blank" onclick="event.stopPropagation()" style="margin-left:10px; color:#25D366; font-size:1.1rem; text-decoration:none;" title="Conversar no WhatsApp"><i class="fab fa-whatsapp"></i></a>`;
                }

                const htmlItem = `
                    <div class="pedido-item pedido-card-expandable" style="margin-bottom:1rem; animation: slideDown 0.3s ease-out;">
                        <div onclick="window.togglePedidoDetails('${x.docId}')" style="cursor:pointer;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="color:var(--gold-solid); font-weight:700; font-size:1.1rem;">#${escapeHTML(x.numPedido)} ${obsIcon}</span>
                                <i id="icon-${x.docId}" class="fas fa-chevron-right" style="font-size:0.8rem; color:var(--text-muted); transition:0.3s;"></i>
                            </div>
                            <div style="margin-bottom:5px; font-size:1rem; font-weight:600; color:#fff;">
                                ${t} PÇS - <span style="color:var(--gold-solid);">${formatarMoeda(t * PRECO_CAMISETA)}</span>
                            </div>
                            <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:2px;">
                                <strong style="color:#fff">${escapeHTML(x.nome)}</strong> | ${escapeHTML(x.local)} - ${escapeHTML(x.setor)}
                            </div>
                            <div style="font-size:0.85rem; color:var(--text-muted); display:flex; align-items:center;">
                                <i class="fas fa-phone-alt" style="font-size:0.7rem; margin-right:4px;"></i>${escapeHTML(x.contato || 'S/ Contato')}
                                ${waLink}
                            </div>
                        </div>
                        <div id="details-${x.docId}" class="pedido-details-content" style="display:none;">
                            <h5 style="color:var(--text-muted); margin-bottom:10px; text-transform:uppercase; font-size:0.75rem; letter-spacing:1px;">Detalhamento do Pedido</h5>
                            ${tabelaHTML}
                            ${obsHtml}
                            <div style="margin-top:15px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                                    <button onclick="window.abrirModalExcluirPedido('${x.docId}')" class="btn-primary" style="background:var(--danger-color); color:#fff; padding: 8px 16px; font-size: 0.75rem; display:inline-flex; align-items:center; gap:8px;">
                                    <i class="fas fa-trash-alt"></i> EXCLUIR
                                </button>
                                <button onclick="window.gerarPdfPedidoIndividual({
                                    numPedido: '${escapeHTML(x.numPedido)}',
                                    nome: '${escapeHTML(x.nome)}',
                                    local: '${escapeHTML(x.local)}',
                                    setor: '${escapeHTML(x.setor)}',
                                    email: '${escapeHTML(x.email)}',
                                    contato: '${escapeHTML(x.contato || '')}',
                                    data: '${x.data}',
                                    observacao: ${JSON.stringify(x.observacao || '').replace(/"/g, "&quot;")},
                                    verdeOliva: ${JSON.stringify(x.verdeOliva || null).replace(/"/g, "&quot;")},
                                    terracota: ${JSON.stringify(x.terracota || null).replace(/"/g, "&quot;")},
                                    infantil: ${JSON.stringify(x.infantil || null).replace(/"/g, "&quot;")},
                                    babylook: ${JSON.stringify(x.babylook || null).replace(/"/g, "&quot;")},
                                    unissex: ${JSON.stringify(x.unissex || null).replace(/"/g, "&quot;")}
                                })" class="btn-primary" style="padding: 8px 16px; font-size: 0.75rem; display:inline-flex; align-items:center; gap:8px; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);">
                                    <i class="fas fa-file-pdf"></i> Gerar PDF
                                </button>
                            </div>
                        </div>
                    </div>`;
                lista.insertAdjacentHTML('beforeend', htmlItem);
            });
        }

        // Gerenciamento do Botão "Expandir"
        // Só mostra se NÃO tiver busca e se a quantidade carregada for relevante (evita mostrar quando filtra tudo)
        // Nota: Como filtramos client-side, o tamanho do array pode ser pequeno, mas se o snapshot for cheio, tem mais.
        if (btnExpandirExistente) btnExpandirExistente.remove();
        
        // Se a busca estiver vazia e não for o fim da lista (assumindo que se veio menos que o limite, acabou)
        // O limite agora é 50. Se veio 50, provavelmente tem mais.
        if (!termoBusca && pedidosProcessados.length > 0) { // Mostra botão se tiver itens, ou se tiver chance de ter mais
             // Simple logic: if we have items, allow expand. 
             // Ideally check snapshot.size === qtdPorPagina
             const btnHtml = `
                <div id="containerBtnExpandir" style="text-align:center; margin-top:2rem; margin-bottom:4rem;">
                    <button id="btnCarregarMais" onclick="window.carregarPedidos(true)" class="btn-primary" style="background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid); width:100%;">
                        <i class="fas fa-chevron-down"></i> EXPANDIR LISTA
                    </button>
                </div>`;
            lista.insertAdjacentHTML('beforeend', btnHtml);
        } else if (!termoBusca && pedidosProcessados.length > 0) {
            lista.insertAdjacentHTML('beforeend', `<div style="text-align:center; color:var(--text-muted); margin-top:2rem; font-size:0.8rem;">--- Fim da Lista ---</div>`);
        }

    } catch (error) {
        console.error(error);
        lista.innerHTML = `<p style="color:var(--danger-color); text-align:center;">Erro ao carregar lista. Tente novamente.</p>`;
    } finally {
        window.mostrarCarregamento(false);
    }
};

window.recarregarDashboardComFeedback = async function() {
    window.pedidosCache = []; // Force refresh
    await window.carregarDashboard();
    document.getElementById('modalFeedbackSucesso').classList.add('active');
};

window.recarregarPedidosComFeedback = async function() {
    window.pedidosCache = []; // Force refresh
    await window.carregarPedidos();
    document.getElementById('modalFeedbackSucesso').classList.add('active');
};

window.recarregarDetalhesEventoComFeedback = async function() {
    window.pedidosCache = []; // Force refresh
    await window.carregarDetalhesEvento();
    document.getElementById('modalFeedbackSucesso').classList.add('active');
};

window.recarregarPagamentosComFeedback = async function() {
    window.pedidosCache = []; // Force refresh
    await window.carregarPagamentos();
    document.getElementById('modalFeedbackSucesso').classList.add('active');
};

// --- EVENT DETAILS (MATRIZ & RESUMO) ---
// REFATORADO: AGORA LÊ APENAS 1 DOC (estatisticas) E NÃO BAIXA MAIS TODOS OS PEDIDOS
window.carregarDetalhesEvento = async function() {
    window.mostrarCarregamento(true, "LENDO ESTATÍSTICAS...");
    try {
        // Lógica Otimizada: Lê o doc de estatísticas onde os contadores estão agregados
        const statsRef = doc(db, "configuracoes", "estatisticas");
        const docSnap = await getDoc(statsRef);
        const stats = docSnap.exists() ? docSnap.data() : {};

        // 1. Matrix Construction from Aggregated Keys
        const sizes = ['1','2','4','6','8','10','12','14','PP','P','M','G','GG','XGG'];
        const matrix = {
            verde: { infantil: {}, babylook: {}, unissex: {} },
            terracota: { infantil: {}, babylook: {}, unissex: {} }
        };
        
        // Helper to reconstruct matrix from flat keys (ex: verde_infantil_4)
        Object.keys(stats).forEach(key => {
            const parts = key.split('_');
            // Chave esperada: cor_tipo_tamanho (3 partes)
            // Filtra chaves que não sejam de estoque
            if (parts.length === 3 && (parts[0] === 'verde' || parts[0] === 'terracota')) {
                const [cor, tipo, tam] = parts;
                if (matrix[cor] && matrix[cor][tipo]) {
                    matrix[cor][tipo][tam] = stats[key];
                }
            }
        });

        // 2. Resumo Localidade from Aggregated Keys (ex: local_Capital_SetorA)
        const locais = {};
        
        Object.keys(stats).forEach(key => {
            if (key.startsWith('local_')) {
                // Remove o prefixo 'local_' para exibição
                const nomeLocal = key.substring(6).replace(/_/g, ' - '); // Capital_SetorA -> Capital - SetorA
                const qtd = stats[key] || 0;
                if (qtd > 0) {
                    locais[nomeLocal] = { qtd: qtd, valor: qtd * PRECO_CAMISETA };
                }
            }
        });

        // Helper to render row (Mantido IDÊNTICO para compatibilidade visual)
        const renderRow = (tbodyId, typeLabel, dataObj, sizeKeys) => {
            const tbody = document.getElementById(tbodyId);
            if(!tbody) return;
            let row = `<tr><td style="padding:10px; color:#fff;">${typeLabel}</td>`;
            sizeKeys.forEach(k => {
                row += `<td style="text-align:center;">${dataObj[k] || 0}</td>`;
            });
            row += `</tr>`;
            tbody.innerHTML = row;
        };

        renderRow('adultoVerdeBody', 'Unissex', matrix.verde.unissex, ['PP','P','M','G','GG','XGG']);
        renderRow('adultoTerraBody', 'Unissex', matrix.terracota.unissex, ['PP','P','M','G','GG','XGG']);
        
        renderRow('babyVerdeBody', 'Babylook', matrix.verde.babylook, ['PP','P','M','G','GG','XGG']);
        renderRow('babyTerraBody', 'Babylook', matrix.terracota.babylook, ['PP','P','M','G','GG','XGG']);
        
        renderRow('infantilVerdeBody', 'Infantil', matrix.verde.infantil, ['1','2','4','6','8','10','12','14']);
        renderRow('infantilTerraBody', 'Infantil', matrix.terracota.infantil, ['1','2','4','6','8','10','12','14']);

        // Renderização da Tabela de Locais
        let htmlLocais = `<table style="width:100%; border-collapse:collapse; font-size:0.9rem;"><thead><tr style="border-bottom:1px solid var(--border-subtle);"><th style="text-align:left; padding:8px; color:var(--text-muted);">Local/Setor</th><th style="padding:8px; color:var(--text-muted);">Qtd</th><th style="text-align:right; padding:8px; color:var(--text-muted);">Total</th></tr></thead><tbody>`;
        
        // Ordena chaves alfabeticamente
        Object.keys(locais).sort().forEach(k => {
            const v = locais[k];
            htmlLocais += `<tr><td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.05);">${k}</td><td style="padding:8px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.05);">${v.qtd}</td><td style="padding:8px; text-align:right; border-bottom:1px solid rgba(255,255,255,0.05);">${formatarMoeda(v.valor)}</td></tr>`;
        });
        htmlLocais += `</tbody></table>`;
        document.getElementById('resumoEventoLocais').innerHTML = htmlLocais;

    } catch(e) {
        console.error("Erro detalhes:", e);
    } finally {
        window.mostrarCarregamento(false);
    }
};

// --- PAYMENTS ---

// Função auxiliar para formatar moeda automaticamente no input
window.formatarMoedaInput = function(i) {
    var v = i.value.replace(/\D/g,'');
    v = (v/100).toFixed(2) + '';
    v = v.replace(".", ",");
    v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    i.value = 'R$ ' + v;
};

// NOVA FUNÇÃO PARA EXPANDIR/COLAPSAR CARD DE PAGAMENTO
window.togglePagamentoCard = function(docId) {
    const detailEl = document.getElementById('pay-details-' + docId);
    const summaryEl = document.getElementById('pay-summary-' + docId); // Elemento de resumo (valores fechados)
    const icon = document.getElementById('pay-icon-' + docId);

    if (detailEl.style.display === 'none') {
        // ABRIR
        detailEl.style.display = 'block';
        detailEl.style.animation = 'slideDown 0.3s ease-out';
        if(summaryEl) summaryEl.style.display = 'none'; // Esconde o resumo financeiro simplificado
        if(icon) { icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-down'); }
    } else {
        // FECHAR
        detailEl.style.display = 'none';
        if(summaryEl) summaryEl.style.display = 'flex'; // Mostra o resumo financeiro simplificado novamente
        if(icon) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-right'); }
    }
};

// VERSÃO ATUALIZADA: CARDS EXPANSÍVEIS E NOVAS REGRAS DE STATUS
// REFATORAÇÃO DE PAGINAÇÃO NO SERVIDOR (20 ITENS)
// LÓGICA DE FILTRAGEM CORRIGIDA PARA CLIENT-SIDE NA PÁGINA (EVITAR ERRO DE INDEX)
// IMPLEMENTAÇÃO DE BUSCA ON-INPUT
window.carregarPagamentos = async function(modoExpandir = false) {
    const btnExpandirExistente = document.getElementById('btnCarregarMaisPagamentos');
    if (modoExpandir) {
        window.mostrarCarregamento(true, "CARREGANDO MAIS PAGAMENTOS...");
    } else {
        // Se for busca inicial (oninput ou refresh), não mostra loader intrusivo para digitar fluido, apenas se necessário.
        const isSearch = document.getElementById('buscaPagamentosInput').value.trim().length > 0;
        if(!isSearch) window.mostrarCarregamento(true, "BUSCANDO PAGAMENTOS...");
        
        // Se não for expansão, limpa tudo para começar do zero
        document.getElementById('listaPagamentos').innerHTML = '';
        ultimoDocPagamentos = null;
        if(btnExpandirExistente) btnExpandirExistente.remove();
    }

    const lista = document.getElementById('listaPagamentos');
    const buscaInput = document.getElementById('buscaPagamentosInput').value.trim();
    const filtroStatus = document.querySelector('input[name="filtroStatusPagamento"]:checked').value;

    try {
        let q;
        // Aumentamos o limite para garantir que, após o filtro de status (client-side), sobrem itens.
        // Isso evita o erro de "Index Missing" do Firestore ao usar 'where' com 'orderBy'.
        const qtdPorPagina = 50; 

        // LÓGICA DE CONSTRUÇÃO DA QUERY FIRESTORE
        if (buscaInput) {
            // --- BUSCA HÍBRIDA GLOBAL (FUZZY SIMULADO) ---
            if (buscaInput.includes('@')) {
                // Email: Busca exata
                q = query(pedidosCollection, where('email', '==', buscaInput.toLowerCase()), limit(20));
            } else if (buscaInput.length < 10 && /^[A-Z0-9]+$/.test(buscaInput) && !buscaInput.match(/^\d+$/)) {
                // ID curto alfanumérico (Provável ID de pedido, ex: 3Xy9) - Prioriza busca exata por ID
                q = query(pedidosCollection, where('numPedido', '==', buscaInput), limit(20));
            } else {
                // Busca Global (Nome, Telefone, Cidade) - Busca "Smart"
                // Como Firestore não tem "LIKE", baixamos os últimos 100 registros para filtrar no cliente.
                // Isso permite achar "Maria", "Cuiabá", "9999" dentro dos pedidos ativos recentes.
                q = query(pedidosCollection, orderBy('data', 'desc'), limit(100));
            }
        } else {
            // --- LISTAGEM PADRÃO COM PAGINAÇÃO E FILTRO SERVER-SIDE ---
            let constraints = [];

            // TAREFA 2: Mapear filtro visual para campo do banco
            if (filtroStatus === 'quitado') {
                constraints.push(where('statusPagamento', '==', 'Pago'));
            } else if (filtroStatus === 'parcialmente') {
                constraints.push(where('statusPagamento', '==', 'Parcial'));
            }
            // Se 'todos', não adiciona cláusula where

            constraints.push(orderBy('data', 'desc'));

            // 2. Paginação (StartAfter)
            if (modoExpandir && ultimoDocPagamentos) {
                constraints.push(startAfter(ultimoDocPagamentos));
            }

            // 3. Limite
            constraints.push(limit(qtdPorPagina));

            q = query(pedidosCollection, ...constraints);
        }

        // EXECUÇÃO DA QUERY
        const snapshot = await getDocs(q);

        // Atualiza o cursor para a próxima página (apenas se não for busca global filtrada)
        if (!snapshot.empty) {
            ultimoDocPagamentos = snapshot.docs[snapshot.docs.length - 1];
        }

        let pedidosProcessados = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));

        // Se for busca global, aplicamos o filtro na memória agora
        if (buscaInput && !buscaInput.includes('@') && !(buscaInput.length < 10 && /^[A-Z0-9]+$/.test(buscaInput) && !buscaInput.match(/^\d+$/))) {
             const termoBuscaLower = buscaInput.toLowerCase();
             pedidosProcessados = pedidosProcessados.filter(p => {
                 // Lógica "Super Busca" unificada para Pagamentos
                 const matchNome = p.nome && p.nome.toLowerCase().includes(termoBuscaLower);
                 const matchContato = p.contato && p.contato.toLowerCase().includes(termoBuscaLower);
                 const matchSetor = p.setor && p.setor.toLowerCase().includes(termoBuscaLower);
                 const matchLocal = p.local && p.local.toLowerCase().includes(termoBuscaLower);
                 const matchId = p.numPedido && p.numPedido.toLowerCase().includes(termoBuscaLower);
                 const matchEmail = p.email && p.email.toLowerCase().includes(termoBuscaLower);
                 
                 return matchNome || matchContato || matchSetor || matchLocal || matchId || matchEmail;
             });
        }

        // Se for a primeira carga, cria o container grid
        let containerGrid = lista.querySelector('.pagamentos-grid-container');
        if (!containerGrid) {
            containerGrid = document.createElement('div');
            containerGrid.className = 'pagamentos-grid-container';
            containerGrid.style.cssText = "display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;";
            lista.appendChild(containerGrid);
        }

        let itensRenderizadosCount = 0;
        let htmlBuffer = '';
        
        pedidosProcessados.forEach(p => {
            const total = calcularTotalPedido(p) * PRECO_CAMISETA;
            let pago = p.valorPago || 0;
            // Fallback para cálculo legado se valorPago não estiver setado mas existir histórico
            if (!p.valorPago && p.historicoPagamentos) {
                pago = p.historicoPagamentos.reduce((acc, h) => acc + (parseFloat(h.valor)||0), 0);
            }
            const restante = Math.max(0, total - pago);

            // --- CÁLCULO RIGOROSO DO STATUS ---
            let statusCalculado = 'PENDENTE'; // Default
            if (pago >= total && total > 0) {
                statusCalculado = 'PAGO';
            } else if (pago > 0 && pago < total) {
                statusCalculado = 'PARCIAL';
            }

            itensRenderizadosCount++;

            // --- DEFINIÇÃO DE CORES (UI) ---
            let statusColor = '#ff6b6b'; // Vermelho (Padrão/Pendente)
            let statusBg = 'rgba(255, 107, 107, 0.1)';

            if (statusCalculado === 'PAGO') {
                statusColor = 'var(--success-color)'; // Verde
                statusBg = 'rgba(100, 255, 218, 0.1)';
            } else if (statusCalculado === 'PARCIAL') {
                statusColor = 'var(--warning-color)'; // Amarelo
                statusBg = 'rgba(255, 215, 0, 0.1)';
            }

            let identificacaoLocal = p.setor || 'Local não definido';

            htmlBuffer += `
            <div class="pedido-item" onclick="window.togglePagamentoCard('${p.docId}')" style="margin-bottom:0; cursor:pointer; padding: 1.5rem !important; transition: background 0.2s; position:relative; animation: slideDown 0.3s ease-out;">
                
                <!-- CABEÇALHO (SEMPRE VISÍVEL) -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.8rem;">
                     <span style="color:#fff; font-weight:700; font-size:1.1rem; letter-spacing:0.5px; text-transform:uppercase;">
                        <i class="fas fa-map-marker-alt" style="color:var(--gold-solid); margin-right:6px; font-size:0.9rem;"></i>
                        ${escapeHTML(identificacaoLocal)}
                     </span>
                     <span style="color:${statusColor}; background:${statusBg}; font-weight:800; font-size:0.75rem; letter-spacing:1px; padding:4px 10px; border-radius:4px; text-transform:uppercase; border:1px solid ${statusColor};">
                        ${statusCalculado}
                     </span>
                </div>

                <!-- RESUMO FINANCEIRO (VISÍVEL APENAS QUANDO FECHADO) -->
                <div id="pay-summary-${p.docId}" style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.03); padding:10px; border-radius:6px;">
                    <div style="text-align:left;">
                        <p style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:2px;">Total</p>
                        <p style="color:#fff; font-weight:600; font-size:0.9rem;">${formatarMoeda(total)}</p>
                    </div>
                    <div style="text-align:center;">
                        <p style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:2px;">Pago</p>
                        <p style="color:${statusColor}; font-weight:600; font-size:0.9rem;">${formatarMoeda(pago)}</p>
                    </div>
                    <div style="text-align:right;">
                        <p style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:2px;">Restante</p>
                        <p style="color:#ddd; font-weight:600; font-size:0.9rem;">${formatarMoeda(restante)}</p>
                    </div>
                </div>
                
                <!-- CONTEÚDO EXPANDIDO -->
                <div id="pay-details-${p.docId}" style="display:none; margin-top:1.5rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1rem;">
                    <div style="margin-bottom:1.5rem;">
                        <p style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:0.3rem;">Líder Responsável</p>
                        <p style="font-size:1.2rem; color:#fff; font-weight:500;">${escapeHTML(p.nome)}</p>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:8px; margin-bottom:1.5rem;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
                            <span style="color:var(--text-muted); font-size:0.9rem;">TOTAL</span>
                            <span style="color:#fff; font-weight:700;">${formatarMoeda(total)}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
                            <span style="color:var(--text-muted); font-size:0.9rem;">TOTAL PAGO</span>
                            <span style="color:${statusColor}; font-weight:700;">${formatarMoeda(pago)}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:var(--text-muted); font-size:0.9rem;">TOTAL RECEBIDO</span>
                            <span style="color:#fff; font-weight:700;">${formatarMoeda(pago)}</span> 
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); window.abrirModalLiquidacao('${p.docId}')" class="btn-primary" style="width:100%; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid); box-shadow:none; font-size:0.8rem; padding: 12px;">
                        <i class="fas fa-wallet" style="margin-right:8px;"></i> GERENCIAR
                    </button>
                </div>
                <div style="position:absolute; bottom:5px; left:50%; transform:translateX(-50%); opacity:0.3;">
                    <i id="pay-icon-${p.docId}" class="fas fa-chevron-right" style="font-size:0.8rem; color:#fff;"></i>
                </div>
            </div>
            `;
        });

        containerGrid.insertAdjacentHTML('beforeend', htmlBuffer);

        // Feedback se a filtragem removeu tudo
        if (itensRenderizadosCount === 0 && !modoExpandir) {
             const msg = buscaInput 
                ? `Nenhum pagamento encontrado para "<strong>${escapeHTML(buscaInput)}</strong>" nos registros recentes.` 
                : `Nenhum registro com status "<strong>${filtroStatus.toUpperCase()}</strong>" encontrado nesta página.`;
            lista.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding:2rem;">${msg}</p>`;
        }

        // GERENCIAMENTO DO BOTÃO "CARREGAR MAIS"
        if (btnExpandirExistente) btnExpandirExistente.remove(); 

        // Se trouxemos o número máximo de itens (50) e não é uma busca específica, mostramos o botão
        if (snapshot.docs.length === qtdPorPagina && !buscaInput) {
            const btnHtml = `
                <div id="btnCarregarMaisPagamentos" style="text-align:center; margin-top:2rem; margin-bottom:4rem; width: 100%;">
                    <button onclick="window.carregarPagamentos(true)" class="btn-primary" style="background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid); width:100%;">
                        <i class="fas fa-chevron-down"></i> CARREGAR MAIS PAGAMENTOS (+50)
                    </button>
                </div>`;
            lista.insertAdjacentHTML('beforeend', btnHtml);
        } else if (!buscaInput && pedidosProcessados.length > 0) {
            lista.insertAdjacentHTML('beforeend', `<div style="text-align:center; color:var(--text-muted); margin-top:2rem; font-size:0.8rem;">--- Fim dos registros ---</div>`);
        }

    } catch(e) {
        console.error(e);
        window.exibirMensagem('listaPagamentos', 'erro', 'Erro ao carregar pagamentos.');
    } finally {
        window.mostrarCarregamento(false);
    }
};

window.abrirModalLiquidacao = async function(docId) {
    window.mostrarCarregamento(true);
    try {
        const docRef = doc(db, "pedidos", docId);
        const snap = await getDoc(docRef);
        if(!snap.exists()) return;
        
        const data = snap.data();
        document.getElementById('liquidacaoDocId').value = docId;
        
        // Reset fields
        document.getElementById('valorLiquidacao').value = '';
        document.getElementById('dataLiquidacao').value = new Date().toLocaleDateString('pt-BR');
        
        // Show history if exists
        const histContainer = document.getElementById('historicoLiquidacoesContainer');
        const histList = document.getElementById('listaHistoricoLiquidacoes');
        
        const history = data.historicoPagamentos || [];
        
        if(history.length > 0) {
            histContainer.style.display = 'block';
            let rows = '';
            history.forEach(h => {
                rows += `<tr><td>${h.data}</td><td>${formatarMoeda(parseFloat(h.valor))}</td></tr>`;
            });
            histList.innerHTML = rows;
        } else {
            histContainer.style.display = 'none';
        }

        document.getElementById('modalLiquidacao').classList.add('active');
        
        // Setup Confirm Button with context
        const btnConfirm = document.getElementById('btnConfirmarLiquidacao');
        // Agora passando o valor como string para a função de parser
        btnConfirm.onclick = () => window.realizarLiquidacao(docId, document.getElementById('valorLiquidacao').value, document.getElementById('dataLiquidacao').value);

    } finally {
        window.mostrarCarregamento(false);
    }
};

window.realizarLiquidacao = async function(docId, valorRaw, dataStr) {
    if(!valorRaw) { alert("Valor inválido"); return; }
    
    // Parser para "R$ 1.200,50" -> 1200.50
    let valorStr = valorRaw.replace("R$", "").trim(); // Remove simbolo
    valorStr = valorStr.replace(/\./g, ""); // Remove pontos de milhar
    valorStr = valorStr.replace(",", "."); // Troca vírgula decimal por ponto
    
    const valor = parseFloat(valorStr);

    if(isNaN(valor)) { alert("Valor inválido"); return; }

    window.mostrarCarregamento(true, "REGISTRANDO...");
    
    try {
        // DIAGNÓSTICO: Correção da atualização do "Total Recebido (Real)"
        // Usamos batch para garantir que o pedido E as estatísticas globais sejam atualizados juntos.
        
        const batch = writeBatch(db);
        const pedidoRef = doc(db, "pedidos", docId);
        const estatisticasRef = doc(db, "configuracoes", "estatisticas");
        
        const snap = await getDoc(pedidoRef);
        const current = snap.data();
        const hist = current.historicoPagamentos || [];
        
        // Adiciona novo pagamento
        hist.push({ valor: valor, data: dataStr, timestamp: new Date().toISOString() });
        
        const totalPecas = calcularTotalPedido(current);
        const totalDevido = totalPecas * PRECO_CAMISETA;
        const totalPago = hist.reduce((acc, h) => acc + (parseFloat(h.valor)||0), 0);
        
        let novoStatus = 'Parcial';
        if(totalPago >= totalDevido - 0.1) novoStatus = 'Pago'; 
        
        // Atualiza o Pedido
        batch.update(pedidoRef, {
            historicoPagamentos: hist,
            valorPago: totalPago,
            statusPagamento: novoStatus
        });
        
        // Atualiza a Estatística Global (Correção do Diagnóstico)
        batch.update(estatisticasRef, {
            total_recebido_real: increment(valor)
        });
        
        await batch.commit();

        // CORREÇÃO: Limpar cache e atualizar UI imediatamente
        window.pedidosCache = [];
        await window.carregarPagamentos();

        // REQUISITO SOLICITADO: ATUALIZAR ESTATÍSTICAS IMEDIATAMENTE (FORÇAR RECALCULO)
        await window.carregarDashboard();
        
        document.getElementById('modalLiquidacao').classList.remove('active');
        document.getElementById('modalSucessoLiquidacao').classList.add('active');
        
    } catch(e) {
        console.error(e);
        alert("Erro ao liquidar.");
    } finally {
        window.mostrarCarregamento(false);
    }
};

window.cancelarUltimaLiquidacao = async function() {
    const docId = document.getElementById('liquidacaoDocId').value;
    if(!docId) return;
    
    if(!confirm("Tem certeza que deseja remover o último pagamento?")) return;
    
    window.mostrarCarregamento(true);
    try {
        const batch = writeBatch(db);
        const ref = doc(db, "pedidos", docId);
        const estatisticasRef = doc(db, "configuracoes", "estatisticas");

        const snap = await getDoc(ref);
        if (!snap.exists()) { // Verificação de segurança para garantir que o documento existe
            throw new Error(`Pedido com ID ${docId} não foi encontrado.`);
        }
        
        const current = snap.data();
        let hist = current.historicoPagamentos || [];
        
        if(hist.length === 0) {
            alert("Não há pagamentos para cancelar.");
            return; // Sai da função, o 'finally' cuidará do loader.
        }
        
        const itemRemovido = hist.pop(); // Remove o último pagamento
        const valorRemovido = parseFloat(itemRemovido.valor) || 0;
        
        const totalPecas = calcularTotalPedido(current);
        const totalDevido = totalPecas * PRECO_CAMISETA;
        const totalPago = hist.reduce((acc, h) => acc + (parseFloat(h.valor)||0), 0);
        
        // Recalcula o status do pagamento
        let novoStatus = 'Pendente';
        if (totalPago > 0) novoStatus = 'Parcial';
        if (totalPago >= totalDevido - 0.1) novoStatus = 'Pago';
        
        // Atualiza o pedido com a lista de pagamentos e o novo total pago
        batch.update(ref, {
            historicoPagamentos: hist,
            valorPago: totalPago,
            statusPagamento: novoStatus
        });
        
        // Decrementa o valor removido do total geral arrecadado
        batch.update(estatisticasRef, {
            total_recebido_real: increment(-valorRemovido)
        });
        
        await batch.commit();

        // Limpa o cache e recarrega os pagamentos para refletir a mudança na interface
        window.pedidosCache = [];
        await window.carregarPagamentos();

        // REQUISITO SOLICITADO: ATUALIZAR ESTATÍSTICAS IMEDIATAMENTE (FORÇAR RECALCULO)
        await window.carregarDashboard();
        
        document.getElementById('modalLiquidacao').classList.remove('active');
        document.getElementById('modalSucessoCancelamento').classList.add('active');
        
    } catch(e) {
        // Log de erro detalhado para diagnóstico
        console.error("LOG DE ERRO: Falha ao cancelar a última liquidação.", { docId: docId, erro: e });
        alert("Erro ao cancelar o pagamento. Verifique o console de desenvolvedor (F12) para detalhes.");
    } finally {
        window.mostrarCarregamento(false);
    }
};

// --- CONFIG ACTIONS ---

window.abrirModalSenhaValor = function() {
    document.getElementById('modalSenhaValor').classList.add('active');
};

window.confirmarAlteracaoValorComSenha = function() {
    // REMOVIDO: if(senha === 'admin123'...) 
    // MOTIVO: A segurança real é feita pelas Regras do Firebase (isAdmin)
    
    // Apenas pegamos o valor e enviamos. Se não for admin, o Firebase dará erro.
    const novoValor = document.getElementById('valorCamisetaInput').value;
    window.recalcularValores(novoValor);
    document.getElementById('modalSenhaValor').classList.remove('active');
    
    // Limpa o campo de senha (que agora é opcional/visual)
    document.getElementById('senhaAlterarValor').value = '';
};

window.confirmarFechamentoPedidos = async function() {
    // REMOVIDO: if(senha === 'admin123'...)
    // MOTIVO: A segurança real é feita pelas Regras do Firebase
    
    try {
        await setDoc(configSistemaRef, { aberto: false });
        document.getElementById('modalFecharPedidos').classList.remove('active');
        alert("Pedidos fechados com sucesso.");
    } catch (error) {
        console.error(error);
        alert("Erro: Você não tem permissão de Administrador.");
    }
};

window.confirmarReaberturaPedidos = async function() {
    await setDoc(configSistemaRef, { aberto: true });
    document.getElementById('modalReabrirPedidos').classList.remove('active');
    alert("Pedidos reabertos.");
};

// --- FUNÇÃO DE ENCERRAMENTO TOTAL DO EVENTO ---
// Implementa a lógica solicitada para limpar o banco de dados e zerar estatísticas
window.acaoEncerrarEvento = async function() {
    // Fechar modal
    document.getElementById('modalEncerrarEvento').classList.remove('active');
    
    // Verificação de segurança adicional
    const confirmacao = prompt("Para confirmar o encerramento do evento e a EXCLUSÃO DE TODOS OS PEDIDOS, digite 'ENCERRAR' abaixo:");
    
    if (confirmacao !== 'ENCERRAR') {
        alert("Ação cancelada. A frase de confirmação estava incorreta.");
        return;
    }

    window.mostrarCarregamento(true, "LIMPANDO BANCO DE DADOS...");
    
    try {
        // 1. Resetar Estatísticas
        await setDoc(doc(db, "configuracoes", "estatisticas"), {
            qtd_pedidos: 0,
            qtd_camisetas: 0,
            qtd_infantil: 0,
            qtd_babylook: 0,
            qtd_unissex: 0,
            valor_total: 0,
            total_recebido_real: 0
        });
        
        // 2. Excluir Pedidos em Lote (Batch)
        // O Firestore limita batches a 500 operações. Vamos processar em chunks.
        const snapshot = await getDocs(collection(db, "pedidos"));
        const totalDocs = snapshot.size;
        
        if (totalDocs === 0) {
            alert("Evento encerrado. Não havia pedidos para excluir.");
            window.carregarDashboard();
            window.mostrarCarregamento(false);
            return;
        }

        let batch = writeBatch(db);
        let count = 0;
        let promises = [];

        snapshot.forEach((doc) => {
            batch.delete(doc.ref);
            count++;

            if (count >= 400) {
                promises.push(batch.commit());
                batch = writeBatch(db);
                count = 0;
            }
        });

        if (count > 0) {
            promises.push(batch.commit());
        }

        await Promise.all(promises);
        
        window.pedidosCache = [];
        window.carregarDashboard();
        
        alert("EVENTO ENCERRADO COM SUCESSO!\nTodos os pedidos foram removidos e as métricas zeradas.");

    } catch (error) {
        console.error("Erro fatal ao encerrar evento:", error);
        alert("Ocorreu um erro ao tentar encerrar o evento. Verifique o console.");
    } finally {
        window.mostrarCarregamento(false);
    }
};

window.mascaraTelefone = function(input) {
    let v = input.value.replace(/\D/g, "");
    v = v.substring(0, 11);
    if (v.length > 10) {
        v = v.replace(/^(\d\d)(\d{5})(\d{4})/, "($1) $2-$3");
    } else if (v.length > 5) {
        v = v.replace(/^(\d\d)(\d{4})(\d{0,4})/, "($1) $2-$3");
    } else if (v.length > 2) {
        v = v.replace(/^(\d\d)(\d{0,5})/, "($1) $2");
    } else {
        v = v.replace(/^(\d*)/, "($1");
    }
    input.value = v;
};

// ============================================
// LÓGICA DE CONFIRMAÇÃO DE PAGAMENTO (Botão)
// ============================================

// Associa o botão de confirmar pagamento ao evento (uma vez que não tinha onclick no HTML)
window.setupLiquidacaoListener = function() {
    // This is now handled by onclick inside abrirModalLiquidacao
};

// Inicialização
window.addEventListener('load', () => {
    // Garante que a tela de splash seja verificada
    if (window.checkAndShowSplash) window.checkAndShowSplash();
    // Garante que a seção home seja exibida se a splash não for necessária
    if(window.innerWidth >= 768 && window.mostrarSecao) window.mostrarSecao('home');
    
    window.setupLiquidacaoListener();
});
</script>
</body>
</html>
