<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMADEMATS | Premium Access</title>
  <link rel="icon" href="data:,">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* =========================================
       ESTÉTICA "AUDAX NAVY & GOLD"
       ========================================= */

    :root {
      /* GRADIENTE DOURADO METÁLICO (GOLD FOIL) */
      --gold-metallic: linear-gradient(135deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5f7 75%, #aa771c 100%);
      --gold-solid: #d4af37;
      
      /* NOVAS CORES DE CAMISETAS */
      --shirt-verde: #556B2F;   /* Verde Oliva */
      --shirt-terracota: #c05838; /* Terracota */

      /* FUNDOS - NOVA PALETA AZUL MARINHO */
      --bg-body: #020c1b;         /* Azul Quase Preto */
      --bg-surface: #0a192f;      /* Azul Marinho Profundo */
      --bg-card: rgba(10, 25, 47, 0.7); /* Glass Azulado */
      
      /* BORDAS & DETALHES */
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-gold: rgba(212, 175, 55, 0.3);
      
      /* TEXTO */
      --text-main: #e6f1ff;       /* Branco levemente azulado para conforto */
      --text-muted: #8892b0;      /* Cinza azulado */
      
      /* VARIÁVEIS DE COMPATIBILIDADE JS */
      --primary-color: #d4af37;
      --primary-dark: #b38728;
      --success-color: #64ffda; /* Verde Neon Suave */
      --warning-color: #ffd700;
      --danger-color: #ff6b6b;
      
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 16px;
      
      --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Manrope', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* =========================================
       BACKGROUND LUXUOSO (BEAMS)
       ========================================= */
    #beams-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; overflow: hidden; background-color: var(--bg-body); pointer-events: none;
    }
    #beams-canvas {
        position: absolute; inset: 0; width: 100%; height: 100%; filter: blur(15px);
    }
    .beams-overlay {
        position: absolute; inset: 0; background-color: rgba(2, 12, 27, 0.05);
        z-index: 1; backdrop-filter: blur(50px); animation: pulseOverlay 10s ease-in-out infinite;
    }
    @keyframes pulseOverlay {
        0% { opacity: 0.05; } 15% { opacity: 0.15; } 50% { opacity: 0.05; } 100% { opacity: 0.05; }
    }

    /* TIPOGRAFIA */
    h1, h2, h3, h4, .home-title, .logo-text h1 { font-weight: 700; color: #fff; letter-spacing: -0.02em; }
    .text-gold, .home-title span, .logo-text h1 {
      background: var(--gold-metallic); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; background-size: 200% auto; animation: shine 5s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    /* SPA LOGIC */
    .section { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    /* HEADER */
    .header {
      position: fixed; top: 0; left: 0; width: 100%;
      background: rgba(2, 12, 27, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-subtle); z-index: 1000; padding: 1rem 0;
    }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; gap: 1rem; }
    .logo-icon {
      width: 50px; height: 50px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-solid); font-weight: 800; font-size: 1.5rem; background: transparent; overflow: hidden;
    }
    .logo-icon img { width: 100%; height: 100%; object-fit: contain; }
    .logo-text { display: flex; flex-direction: column; }
    .logo-text h1 { font-size: 1.4rem; line-height: 1; margin: 0; text-transform: uppercase; }
    .logo-text span { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }

    /* LAYOUT */
    .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
    .main { min-height: 100vh; padding: 6rem 0 4rem 0; }

    /* BOTÕES */
    .btn-primary, .form-actions button {
      font-family: 'Manrope', sans-serif; font-weight: 700; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;
      border: none; cursor: pointer; transition: var(--transition); border-radius: 50px; position: relative; overflow: hidden; z-index: 1;
      background: var(--gold-metallic); color: #020c1b; padding: 1rem 2.5rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(212, 175, 55, 0.2); filter: brightness(1.1); }
    .back-button {
      background: transparent; color: var(--text-muted); border: 1px solid var(--border-subtle); padding: 0.6rem 1.2rem;
      display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem; border-radius: 50px;
      font-size: 0.8rem; font-weight: 600; transition: var(--transition);
    }
    .back-button:hover { border-color: var(--gold-solid); color: var(--gold-solid); background: rgba(212, 175, 55, 0.05); }

    /* MENU BUTTONS */
    .menu-container { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 450px; margin: 0 auto; }
    .menu-button {
      display: flex; justify-content: space-between; align-items: center; width: 100%;
      background: var(--bg-card); border: 1px solid var(--border-subtle); color: #fff;
      padding: 1.5rem 2rem; border-radius: var(--radius-lg); transition: var(--transition);
      font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); font-size: 1.1rem;
    }
    .menu-button i { color: var(--gold-solid); font-size: 1.2rem; transition: var(--transition); }
    .menu-button:hover { border-color: var(--gold-solid); background: linear-gradient(90deg, rgba(212, 175, 55, 0.05) 0%, transparent 100%); transform: translateX(5px); }

    /* CARDS & FORMS */
    .modern-form, .pedido-item, .card, .admin-panel, .pedido-confirmacao-card {
      background: var(--bg-card); border: 1px solid var(--border-subtle); padding: 2.5rem;
      border-radius: var(--radius-lg); backdrop-filter: blur(20px); box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .pedido-item { border-top: 2px solid var(--gold-solid); }

    /* INPUTS */
    .form-group { margin-bottom: 2rem; position: relative; }
    .form-group label { display: block; color: var(--text-muted); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.8rem; }
    #formPedido label { color: #FFFFFF !important; }
    input, select, textarea {
      width: 100%; background: rgba(17, 34, 64, 0.5) !important; border: 1px solid var(--border-subtle) !important;
      border-radius: var(--radius-md) !important; color: #fff !important; padding: 1rem 1.2rem !important;
      font-family: 'Manrope', sans-serif; font-size: 1rem; transition: var(--transition);
    }
    #formPedido input::placeholder { color: rgba(255, 255, 255, 0.7) !important; opacity: 1; }
    input:focus, select:focus { border-color: var(--gold-solid) !important; outline: none; background: rgba(17, 34, 64, 0.8) !important; box-shadow: 0 0 0 1px var(--gold-solid); }

    /* GRID */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    @media(min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }

    /* RADIO BUTTONS */
    .radio-group { display: flex; gap: 1.5rem; }
    .radio-label {
        display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #fff;
        background: rgba(17, 34, 64, 0.5); padding: 0.8rem 1.5rem; border-radius: 50px;
        border: 1px solid var(--border-subtle); transition: var(--transition);
    }
    .radio-label:hover { background: rgba(17, 34, 64, 0.8); }
    .radio-label input { 
        width: auto !important; 
        margin: 0; 
        accent-color: var(--gold-solid); 
        /* Ajuste do tamanho padrão para o desktop/layout geral */
        width: 16px; 
        height: 16px;
    }

    /* ESTILOS DE FILTRO E BUSCA */
    .search-container { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
    .filter-container { display: flex; gap: 1.0rem; align-items: center; flex-wrap: wrap; }
    .filter-radio { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; }
    .filter-radio input { 
        width: auto !important; 
        margin: 0; 
        accent-color: var(--gold-solid); 
        /* Ajuste do tamanho padrão para o desktop/layout geral */
        width: 16px; 
        height: 16px;
    }
    .filter-radio input:checked + span { color: var(--gold-solid); font-weight: 600; }
    
    /* TAMANHOS E CORES (NOVO) */
    .tipo-camiseta {
        background: rgba(2, 12, 27, 0.5); border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg); padding: 2rem; margin-bottom: 2rem;
    }
    .tipo-camiseta h4 {
        color: var(--gold-solid); margin-bottom: 1.5rem; font-size: 1.1rem;
        text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 1rem;
    }
    .tamanhos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1rem; }
    .tamanho-item { display: flex; flex-direction: column; align-items: center; }
    .tamanho-item label { margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.8rem; }
    #formPedido .tamanho-item label { color: #FFFFFF !important; }
    .tamanho-item input { text-align: center; padding: 0.8rem !important; font-weight: 700; }

    /* HEADER DAS CORES */
    .cor-header {
        display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;
        padding: 1rem; background: rgba(255,255,255,0.03); border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
    }
    .cor-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); }

    /* DASHBOARD */
    .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
    .card-content h4 { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
    #admin-dashboard .card-content h4, #admin-dashboard .dashboard-details h4, #admin-dashboard .detail-item span { color: #FFFFFF !important; }
    
    /* AJUSTE 1: Diminui fonte dos valores para caber no desktop e mobile sem quebrar */
    .card-value { font-size: clamp(1.3rem, 2vw, 1.7rem); font-weight: 200; color: #fff; white-space: nowrap; } 
    
    .pedido-card-expandable { cursor: pointer; transition: background 0.3s ease; }
    .pedido-card-expandable:hover { background: rgba(255, 255, 255, 0.05); }
    .pedido-details-content { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .tabela-detalhe-pedido { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 1rem; color: #ddd; }
    .tabela-detalhe-pedido th, .tabela-detalhe-pedido td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: left; }
    .tabela-detalhe-pedido th { color: var(--gold-solid); font-weight: 600; text-transform: uppercase; }

    /* MODAIS */
    .pedido-confirmacao-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 12, 27, 0.9); backdrop-filter: blur(15px); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .pedido-confirmacao-overlay.active { opacity: 1; visibility: visible; }
    .pedido-confirmacao-card { width: 95%; max-width: 550px; border: 1px solid var(--gold-solid); max-height: 90vh; overflow-y: auto; }
    
    #pedidoConfirmacaoNumero {
        word-break: break-all; overflow-wrap: break-word; white-space: normal;
        font-size: clamp(1.2rem, 4vw, 2rem) !important; line-height: 1.2; padding: 0 10px;
    }

    /* IA BUTTON */
    .btn-ai-magic {
        background: transparent !important; border: 1px solid var(--border-subtle) !important; color: #fff !important;
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
        border-radius: var(--radius-md); transition: var(--transition);
    }
    .btn-ai-magic:hover {
        border-color: var(--gold-solid) !important; background: rgba(212, 175, 55, 0.05) !important;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.1);
    }
    .btn-ai-magic i { color: var(--gold-solid); }

    /* LOADER */
    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-body); z-index: 3000;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .loading-overlay.active { opacity: 1; visibility: visible; }
    .spinner-gold {
        width: 50px; height: 50px; border-radius: 50%;
        border: 2px solid rgba(212, 175, 55, 0.1); border-top-color: var(--gold-solid);
        animation: spin 1s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ADMIN MENU */
    .admin-menu { display: flex; gap: 2rem; border-bottom: 1px solid var(--border-subtle); margin-bottom: 2rem; overflow-x: auto; }
    .admin-menu-btn {
        background: transparent; border: none; color: var(--text-muted);
        padding: 1rem 0; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        transition: var(--transition); border-bottom: 2px solid transparent; white-space: nowrap;
    }
    .admin-menu-btn:hover { color: #fff; }
    .admin-menu-btn.active { color: var(--gold-solid); border-bottom-color: var(--gold-solid); }

    /* ESTILO PARA TABELA DE LIQUIDAÇÕES */
    .hist-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.85rem; }
    .hist-table th, .hist-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
    .hist-table th { color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; }
    .hist-table td { color: #fff; }

    /* ESTILOS ESPECÍFICOS PARA OS BOTÕES DO MODAL DE DETALHES (Regra 4) */
    #modalDetalhesPedido .modal-actions {
        display: flex; gap: 1rem; margin-top: 2rem; 
        /* Envolve os botões para garantir que fiquem lado a lado */
    }
    #modalDetalhesPedido .modal-actions button {
        flex: 1; /* Distribui o espaço igualmente */
        padding: 0.7rem 1.2rem; /* Reduz o padding */
        font-size: 0.75rem; /* Reduz o tamanho da fonte */
        letter-spacing: 0.5px; /* Ajusta o espaçamento entre letras */
        border-radius: 50px;
    }
    /* Estilo específico para o botão de fechar para manter a consistência */
    #modalDetalhesPedido button:not(.btn-primary) {
        background: transparent; 
        border: 1px solid var(--border-subtle); 
        color: var(--text-muted); 
        cursor: pointer;
        transition: var(--transition);
    }
    #modalDetalhesPedido button:not(.btn-primary):hover {
        border-color: var(--gold-solid); 
        color: var(--gold-solid); 
    }
    
    /* =========================================
       TELA INICIAL MOBILE (SPLASH SCREEN)
       ========================================= */
    #mobileSplashScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-body);
        z-index: 4000; 
        justify-content: center;
        align-items: center;
        flex-direction: column;
        overflow: hidden;
        
        /* Controle de visibilidade via classe JS */
        display: none; 
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }
    
    #mobileSplashScreen.active {
        opacity: 1;
        visibility: visible;
        display: flex; 
    }

    #splashVideo {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translate(-50%, -50%);
        z-index: 1;
        object-fit: cover; 
        filter: brightness(0.5); 
    }

    /* Reposicionamento e centralização do conteúdo (botão/loader) */
    #splashContent {
        position: fixed; 
        bottom: 60px; /* SUBINDO BOTÃO PARA 60PX DO FUNDO */
        left: 0;
        right: 0;
        z-index: 2;
        text-align: center;
        width: 100%;
        padding: 0 20px; /* Adiciona padding lateral para os textos */
    }

    /* Estilos para o bloco de texto (NOVO LAYOUT) */
    #splashTextContainer {
        position: fixed;
        bottom: 140px; /* SUBINDO TEXTO PARA 140PX DO FUNDO */
        left: 0;
        right: 0;
        z-index: 2;
        text-align: left; /* Alinhamento conforme imagem */
        padding: 0 40px; /* Espaçamento lateral */
        color: #fff;
    }
    #splashTitle {
        font-family: 'Manrope', sans-serif;
        font-size: 2.2rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 0.5rem;
    }
    #splashSubtitle {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.4;
    }


    /* =========================================
       NOVOS ESTILOS DO BOTÃO E LOADER
       ========================================= */

    /* ESTILO NOVO DO BOTÃO (Dourado Metálico) */
    .button {
        width: 250px; 
        height: 50px; 
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        
        /* CORREÇÃO AQUI: USANDO GRADIENTE DOURADO */
        background: var(--gold-metallic); 
        
        border-radius: 30px;
        color: #020c1b; /* Texto na cor do fundo para contraste */
        font-weight: 700;
        border: none;
        position: relative;
        cursor: pointer;
        transition-duration: .2s;
        box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
        padding: 0 16px; 
        transition-duration: .5s;
        margin: 0 auto; /* Centraliza o botão */
    }
    .button .text {
        font-family: 'Manrope', sans-serif; 
        font-size: 0.95rem; 
        letter-spacing: 1px;
    }
    .svgIcon {
        height: 25px;
        transition-duration: 1.5s;
        display: none; 
    }
    .bell path {
        fill: rgb(19, 19, 19);
    }
    .button:hover {
        background-color: var(--gold-solid); /* Dourado sólido no hover */
        transition-duration: .5s;
        transform: translateY(-2px); /* Efeito do btn-primary */
        box-shadow: 0 7px 15px rgba(212, 175, 55, 0.4);
    }
    .button:active {
        transform: scale(0.97);
        transition-duration: .2s;
    }
    .button:hover .svgIcon {
        transform: rotate(250deg);
        transition-duration: 1.5s;
    }

    /* ESTILO NOVO DO LOADER (EXATO DO USUÁRIO) - AJUSTADO PARA SER RELATIVO AO splashContent */
    .loader {
      position: absolute; 
      top: 5px; 
      left: 50%;
      transform: translateX(-50%);
      animation: speeder 0.4s linear infinite;
      display: none; 
      width: 150px; 
      height: 50px;
      margin: 0; 
    }
    .loader.active {
      display: block;
    }
    /* Ajustando as posições internas para centralizar o loader */
    .loader > span {
      height: 5px;
      width: 35px;
      background: #fff; /* Alterado para branco para contraste */
      position: absolute;
      top: 15px; 
      left: 50%;
      margin-left: -50px;
      border-radius: 2px 10px 1px 0;
    }
    .base {
        position: relative; 
    }
    .base span {
      position: absolute;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-right: 100px solid #fff; 
      border-bottom: 6px solid transparent;
      left: -50px;
      top: 25px;
    }
    .base span:before {
      content: "";
      height: 22px;
      width: 22px;
      border-radius: 50%;
      background: #fff; 
      position: absolute;
      right: -110px;
      top: -16px;
    }
    .base span:after {
      content: "";
      position: absolute;
      width: 0;
      height: 0;
      border-top: 0 solid transparent;
      border-right: 55px solid #fff; 
      border-bottom: 16px solid transparent;
      top: -16px;
      right: -98px;
    }
    .face {
      position: absolute;
      height: 12px;
      width: 20px;
      background: #fff; 
      border-radius: 20px 20px 0 0;
      transform: rotate(-40deg);
      right: -125px;
      top: -15px;
    }
    .face:after {
      content: "";
      height: 12px;
      width: 12px;
      background: #fff; 
      right: 4px;
      top: 7px;
      position: absolute;
      transform: rotate(40deg);
      transform-origin: 50% 50%;
      border-radius: 0 0 0 2px;
    }
    .loader > span > span:nth-child(1),.loader > span > span:nth-child(2),.loader > span > span:nth-child(3),.loader > span > span:nth-child(4) {
      width: 30px;
      height: 1px;
      background: #fff; 
      position: absolute;
      animation: fazer1 0.2s linear infinite;
    }
    .loader > span > span:nth-child(2) {
      top: 3px;
      animation: fazer2 0.4s linear infinite;
    }
    .loader > span > span:nth-child(3) {
      top: 1px;
      animation: fazer3 0.4s linear infinite;
      animation-delay: -1s;
    }
    .loader > span > span:nth-child(4) {
      top: 4px;
      animation: fazer4 1s linear infinite;
      animation-delay: -1s;
    }
    @keyframes fazer1 {
      0% { left: 0; }
      100% { left: -80px; opacity: 0; }
    }
    @keyframes fazer2 {
      0% { left: 0; }
      100% { left: -100px; opacity: 0; }
    }
    @keyframes fazer3 {
      0% { left: 0; }
      100% { left: -50px; opacity: 0; }
    }
    @keyframes fazer4 {
      0% { left: 0; }
      100% { left: -150px; opacity: 0; }
    }
    @keyframes speeder {
      0% { transform: translate(2px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -3px) rotate(-1deg); }
      20% { transform: translate(-2px, 0px) rotate(1deg); }
      30% { transform: translate(1px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 3px) rotate(-1deg); }
      60% { transform: translate(-1px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-2px, -1px) rotate(1deg); }
      90% { transform: translate(2px, 1px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .longfazers {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    .longfazers span {
      position: absolute;
      height: 2px;
      width: 20%;
      background: #fff; 
    }
    .longfazers span:nth-child(1) {
      top: 20%;
      animation: lf 0.6s linear infinite;
      animation-delay: -5s;
    }
    .longfazers span:nth-child(2) {
      top: 40%;
      animation: lf2 0.8s linear infinite;
      animation-delay: -1s;
    }
    .longfazers span:nth-child(3) {
      top: 60%;
      animation: lf3 0.6s linear infinite;
    }
    .longfazers span:nth-child(4) {
      top: 80%;
      animation: lf4 0.5s linear infinite;
      animation-delay: -3s;
    }
    @keyframes lf {
      0% { left: 200%; }
      100% { left: -200%; opacity: 0; }
    }
    @keyframes lf2 {
      0% { left: 200%; }
      100% { left: -200%; opacity: 0; }
    }
    @keyframes lf3 {
      0% { left: 200%; }
      100% { left: -100%; opacity: 0; }
    }
    @keyframes lf4 {
      0% { left: 200%; }
      100% { left: -100%; opacity: 0; }
    }

    /* =========================================
       MOBILE RESPONSIVENESS
       ========================================= */
    @media (max-width: 767px) {
        /* Garante que o splash screen esteja escondido no desktop */
        #mobileSplashScreen:not(.active) {
            display: none !important;
        }
    }
    
    @media (max-width: 480px) {
        /* *** AJUSTES PARA MELHORAR O FILTRO EM TELAS PEQUENAS (SOLICITAÇÃO DO USUÁRIO) *** */
        
        /* Reduz o espaçamento e garante que caiba em uma linha */
        .filter-container { 
            display: flex; /* Garante que os itens fiquem lado a lado */
            justify-content: flex-start; 
            gap: 0.2rem; /* Reduz o gap entre os elementos */
            flex-wrap: nowrap; 
            overflow-x: auto; 
            padding-bottom: 5px; 
            padding-right: 5px;
        }

        /* Reduz o tamanho do rádio e o padding do rótulo para economizar espaço */
        .filter-radio {
             /* Reduz o padding para diminuir a largura total do elemento */
             padding: 0.2rem 0.4rem; /* Redução mais agressiva no padding */
             font-size: 0.75rem; 
             white-space: nowrap; 
        }
        
        /* Reduz o tamanho da bolinha do radio button para o mobile */
        .filter-radio input { 
            width: 12px !important; /* Tamanho final ajustado (12px) */
            height: 12px !important; 
            margin-right: 0.1rem; /* Redução máxima na margem interna do rádio */
        }

        .filter-container > span {
             white-space: nowrap; 
             margin-right: 0.1rem; 
             font-size: 0.75rem; 
        }
        
        /* Layout Geral (mantido e ajustado) */
        .container { padding: 0 16px; }
        .main { padding: 5rem 0 2rem 0; }
        .logo-text h1 { font-size: 1.1rem; }
        .logo-text span { font-size: 0.6rem; }
        .logo-icon { width: 40px; height: 40px; }
        .home-title { font-size: 2.2rem; margin-bottom: 1rem; }
        .menu-button { padding: 1rem; }
        .modern-form, .card, .admin-panel { padding: 1.5rem; }
        .form-grid { gap: 1rem; }
        .radio-group { flex-direction: column; gap: 0.5rem; }
        .radio-label { width: 100%; justify-content: flex-start; }
        .tamanhos-grid { grid-template-columns: repeat(3, 1fr); gap: 0.8rem; }
        .dashboard-cards { grid-template-columns: 1fr; gap: 1rem; }
        .admin-menu { gap: 1rem; padding-bottom: 5px; }
        /* AJUSTE 2: Reduz a fonte e padding do menu do ADMIN no mobile */
        .admin-menu-btn { font-size: 1rem; padding: 0.6rem 0; } 
        .tamanhos-table-container { overflow-x: auto; display: block; width: 100%; margin-bottom: 1rem; }
        .tamanhos-table th, .tamanhos-table td { padding: 0.8rem 0.5rem; font-size: 0.8rem; }
        .pedido-header-minimized { flex-wrap: wrap; gap: 0.5rem; }
        .pedido-resumo-info { width: 100%; justify-content: space-between; }
        .admin-actions { flex-direction: column; gap: 0.5rem; }
        .admin-actions button { width: 100%; }
        .financeiro-item-row { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        .financeiro-actions { width: 100%; justify-content: space-between; }
        .pedido-confirmacao-card { width: 95%; margin: 10px; max-height: 90vh; overflow-y: auto; }
        
        /* Garantir que os botões do modalDetalhesPedido fiquem em coluna no mobile */
        #modalDetalhesPedido .modal-actions {
            flex-direction: column;
        }
        #modalDetalhesPedido .modal-actions button {
            padding: 0.8rem 1.2rem; /* Aumenta um pouco para ser melhor de tocar */
            font-size: 0.85rem;
        }
    }
    @media (min-width: 481px) { .home-title { font-size: clamp(3rem, 6vw, 4.5rem); } }
  </style>
</head>
<body>

  <!-- TELA INICIAL EXCLUSIVA PARA MOBILE -->
  <div id="mobileSplashScreen">
    <video id="splashVideo" autoplay loop muted playsinline>
        <source src="https://raw.githubusercontent.com/mblarson/sistema-pedidos-camisetas/main/aberturasite.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
    </video>
    
    <!-- NOVO BLOCO DE TEXTO -->
    <div id="splashTextContainer">
        <h1 id="splashTitle">PEDIDOS DE CAMISETA</h1>
        <p id="splashSubtitle">Registre aqui os pedidos de camisetas para o Jubileu de Ouro da UMADEMATS</p>
    </div>
    
    <div id="splashContent">
        <!-- BOTÃO ACESSAR SISTEMA (NOVO ESTILO) -->
        <button id="btnAcessarSistema" class="button">
          <!-- Oculta o ícone SVG e centraliza o texto -->
          <span class="text">ACESSAR O SISTEMA</span>
        </button>

        <!-- LOADER OCULTO -->
        <div id="splashLoader" class="loader">
            <span>
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </span>
            <div class="base">
              <span></span>
              <div class="face"></div>
            </div>
            <div class="longfazers">
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </div>
        </div>
    </div>
  </div>
  <!-- FIM TELA INICIAL MOBILE -->

  <div id="beams-container"><canvas id="beams-canvas"></canvas><div class="beams-overlay"></div></div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-gold"></div>
    <div id="loadingText" style="margin-top:1.5rem; font-size:0.9rem; letter-spacing:2px; color:var(--text-muted);">CARREGANDO</div>
  </div>
  
  <!-- MODAL DE EXCLUSÃO DE PEDIDO -->
  <div id="modalExcluirPedido" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-trash-alt"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Excluir Pedido?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Tem certeza que deseja excluir este pedido? Essa ação não poderá ser desfeita.</p>
          <input type="hidden" id="excluirPedidoDocId">
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalExcluirPedido').classList.remove('active')" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarExclusao" class="btn-primary" style="flex:1; background:var(--danger-color); color:#fff;">Excluir Pedido</button>
          </div>
      </div>
  </div>

  <!-- MODAL DE ENCERRAMENTO DE EVENTO -->
  <div id="modalEncerrarEvento" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:500px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-exclamation-triangle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Encerrar Evento?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1.5rem; font-weight:700;">NÃO SE ESQUEÇA DE GERAR OS RELATÓRIOS ANTES DE ENCERRAR.</p>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Tem certeza que deseja ENCERRAR o evento? Todos os pedidos serão removidos do sistema.</p>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalEncerrarEvento').classList.remove('active')" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarEncerrarEvento" class="btn-primary" style="flex:1; background:var(--danger-color); color:#fff;">Encerrar Evento</button>
          </div>
      </div>
  </div>

  <div id="modalLiquidacao" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width: 500px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.4rem; margin:0;">Liquidar Pagamento</h2>
              <button onclick="document.getElementById('modalLiquidacao').classList.remove('active')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;"><i class="fas fa-times"></i></button>
          </div>
          
          <input type="hidden" id="liquidacaoDocId">
          
          <div class="form-group">
              <label>Valor Pago</label>
              <input type="text" id="valorLiquidacao" placeholder="R$ 0,00" inputmode="numeric">
          </div>
          
          <div class="form-group">
              <label>Data do Recebimento</label>
              <input type="text" id="dataLiquidacao" placeholder="DD/MM/AAAA" maxlength="10">
          </div>

          <button id="btnConfirmarLiquidacao" class="btn-primary" style="width:100%; margin-bottom:1rem;">CONFIRMAR PAGAMENTO</button>
          
          <div id="historicoLiquidacoesContainer" style="display:none; margin-top:2rem; padding-top:1rem; border-top:1px solid var(--border-subtle);">
              <h3 style="color:var(--text-muted); font-size:0.9rem; text-transform:uppercase; margin-bottom:1rem;">Histórico de Pagamentos</h3>
              <table class="hist-table">
                  <thead><tr><th>Data</th><th>Valor</th></tr></thead>
                  <tbody id="listaHistoricoLiquidacoes"></tbody>
              </table>
              <div style="margin-top:1.5rem; text-align:right;">
                   <button id="btnCancelarLiquidacao" onclick="window.cancelarUltimaLiquidacao()" style="background:transparent; border:1px solid var(--danger-color); color:var(--danger-color); padding:8px 16px; border-radius:50px; font-size:0.8rem; cursor:pointer;">CANCELAR ÚLTIMA LIQUIDAÇÃO</button>
              </div>
          </div>
      </div>
  </div>
  
  <!-- NOVO MODAL DE FEEDBACK DE ATUALIZAÇÃO (Regra 2) -->
  <div id="modalFeedbackSucesso" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">TELA ATUALIZADA</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">As métricas foram recarregadas com sucesso.</p>
          <button onclick="document.getElementById('modalFeedbackSucesso').classList.remove('active')" class="btn-primary" style="width:100%;">OK</button>
      </div>
  </div>

  <!-- MODAL DE SUCESSO PARA LIQUIDAÇÃO (Mantido do passo anterior) -->
  <div id="modalSucessoLiquidacao" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Pagamento Registrado!</h2>
          <!-- Chamada para carregarPagamentos() ao clicar em OK (Regra 2) -->
          <p id="msgSucessoLiquidacao" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">O valor foi salvo e a lista será atualizada.</p>
          <button onclick="document.getElementById('modalSucessoLiquidacao').classList.remove('active'); window.carregarPagamentos();" class="btn-primary" style="width:100%;">OK</button>
      </div>
  </div>
  
  <!-- NOVO MODAL DE CANCELAMENTO DE LIQUIDAÇÃO (Regra 1) -->
  <div id="modalSucessoCancelamento" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-undo-alt"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Cancelamento Concluído</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">A quitação foi cancelada com sucesso. A lista será atualizada.</p>
          <!-- CORREÇÃO: Atualização imediata ao clicar em OK -->
          <button onclick="document.getElementById('modalSucessoCancelamento').classList.remove('active'); window.carregarPagamentos();" class="btn-primary" style="width:100%;">OK</button>
      </div>
  </div>


  <div id="modalDetalhesPedido" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.4rem; margin:0;">Detalhes do Pedido</h2>
              <button onclick="document.getElementById('modalDetalhesPedido').classList.remove('active')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.2rem;"><i class="fas fa-times"></i></button>
          </div>
          <div id="conteudoDetalhesPedido">
              </div>
          
          <!-- Botões ajustados para caberem lado a lado (Regra 2, 4) -->
          <div class="modal-actions">
              <button onclick="document.getElementById('modalDetalhesPedido').classList.remove('active')" style="flex:1;">Fechar</button>
              <button id="btnBaixarNoModal" class="btn-primary" type="button" style="flex:1; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);"><i class="fas fa-download"></i> BAIXAR PEDIDO</button>
              <button id="btnEditarNoModal" class="btn-primary" style="flex:1;"><i class="fas fa-edit"></i> EDITAR PEDIDO</button>
          </div>
      </div>
  </div>

  <!-- NOVO MODAL DE ERRO DE PDF -->
  <div id="modalErroPDF" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center; border:1px solid var(--danger-color);">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-exclamation-triangle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Erro na Geração</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Não foi possível gerar o PDF. Tente novamente.</p>
          <button onclick="document.getElementById('modalErroPDF').classList.remove('active')" class="btn-primary" style="width:100%;">Entendido</button>
      </div>
  </div>

  <div id="pedidoConfirmacaoOverlay" class="pedido-confirmacao-overlay">
    <div class="pedido-confirmacao-card">
      <div style="text-align:center; margin-bottom:2rem;">
        <div style="font-size:3rem; color:var(--gold-solid); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
        <h2 style="font-size:1.8rem;">Pedido Confirmado</h2>
        <p style="color:var(--text-muted); font-size:0.9rem;">Seu pedido foi registrado com sucesso.</p>
      </div>
      <div style="background:rgba(255,255,255,0.03); border-radius:var(--radius-md); padding:1.5rem; margin-bottom:2rem; text-align:center; border:1px solid var(--border-subtle);">
          <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.5rem;">ID DO PEDIDO</p>
          <div id="pedidoConfirmacaoNumero" style="color:#fff; font-weight:300; margin-bottom:1rem;"></div>
          <button onclick="const num = document.getElementById('pedidoConfirmacaoNumero').innerText.replace('#',''); window.copiarNumeroPedido(num)" style="background:transparent; border:1px solid var(--border-subtle); color:var(--gold-solid); padding:8px 16px; border-radius:50px; font-size:0.75rem; font-weight:600; cursor:pointer; transition:0.3s;">COPIAR CÓDIGO</button>
      </div>
      <div id="pedidoConfirmacaoInfo" style="font-size:0.9rem; color:var(--text-muted); text-align:center; margin-bottom:1rem;"></div>
      <div id="pedidoConfirmacaoTamanhos" style="font-size:0.85rem; color:#888; text-align:center; display:none;"></div>
      <button class="btn-primary" id="voltarInicio" style="width:100%;">Retornar ao Início</button>
    </div>
  </div>

  <div id="modalSucessoFinanceiro" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-check-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Valor Atualizado!</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">O preço foi alterado e os totais recalculados.</p>
          <div style="background:rgba(255,255,255,0.03); border-radius:var(--radius-md); padding:1.5rem; margin-bottom:2rem; border:1px solid var(--border-subtle);">
              <div style="margin-bottom:1rem;">
                  <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.3rem;">Novo Valor Unitário</p>
                  <p id="confirmacaoNovoValor" style="font-size:1.5rem; color:var(--gold-solid); font-weight:700;">R$ 0,00</p>
              </div>
              <div>
                  <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:0.3rem;">Novo Total Arrecadado</p>
                  <p id="confirmacaoNovoTotal" style="font-size:1.2rem; color:#fff;">R$ 0,00</p>
              </div>
          </div>
          <button onclick="document.getElementById('modalSucessoFinanceiro').classList.remove('active')" class="btn-primary" style="width:100%;">Fechar</button>
      </div>
  </div>

  <div id="modalErroLogin" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--danger-color); margin-bottom:1rem;"><i class="fas fa-times-circle"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Acesso Negado</h2>
          <p id="msgErroLogin" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">E-mail ou senha incorretos.</p>
          <button onclick="document.getElementById('modalErroLogin').classList.remove('active')" class="btn-primary" style="width:100%; background:transparent; border:1px solid var(--danger-color); color:var(--danger-color);">Tentar Novamente</button>
      </div>
  </div>

  <div id="modalFecharPedidos" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-lock"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Fechar Pedidos?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Tem certeza que deseja FECHAR os pedidos? Insira a senha para confirmar.</p>
          <div class="form-group" style="margin-bottom:1.5rem;">
              <input type="password" id="senhaFecharPedidos" placeholder="Senha de Confirmação" style="text-align:center;">
          </div>
          <div id="msgErroSenhaFechar" style="color:var(--danger-color); font-size:0.8rem; margin-bottom:1rem; display:none;">SENHA INCORRETA</div>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalFecharPedidos').classList.remove('active'); document.getElementById('senhaFecharPedidos').value='';" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button onclick="window.confirmarFechamentoPedidos()" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="modalReabrirPedidos" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--success-color); margin-bottom:1rem;"><i class="fas fa-lock-open"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Reabrir Pedidos?</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Deseja realmente reabrir os pedidos?</p>
          <div style="display:flex; gap:1rem;">
              <button onclick="document.getElementById('modalReabrirPedidos').classList.remove('active')" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button onclick="window.confirmarReaberturaPedidos()" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="modalPedidosFechados" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px; text-align:center;">
          <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-store-slash"></i></div>
          <h2 style="font-size:1.5rem; margin-bottom:0.5rem;">Pedidos Fechados</h2>
          <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:2rem;">Os pedidos estão temporariamente fechados.</p>
          <button onclick="document.getElementById('modalPedidosFechados').classList.remove('active')" class="btn-primary" style="width:100%;">Entendido</button>
      </div>
  </div>

  <div id="modalConfirmarValor" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:400px;">
          <div style="text-align:center; margin-bottom:2rem;">
              <div style="font-size:2.5rem; color:var(--warning-color); margin-bottom:1rem;"><i class="fas fa-exclamation-triangle"></i></div>
              <h2 style="font-size:1.5rem;">Alterar Preço?</h2>
              <p style="color:var(--text-muted); font-size:0.9rem;">Isso recalculará todos os relatórios em todos os dispositivos.</p>
          </div>
          <div style="display:flex; gap:1rem;">
              <button id="btnCancelarAlteracao" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:var(--text-muted); padding:1rem; border-radius:50px; cursor:pointer;">Cancelar</button>
              <button id="btnConfirmarAlteracao" class="btn-primary" style="flex:1;">Confirmar</button>
          </div>
      </div>
  </div>

  <div id="esqueceuIdOverlay" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card">
          <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;">
              <h2 style="font-size:1.5rem; margin:0;">Recuperar Acesso</h2>
              <button id="fecharEsqueceuId" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <form id="formEsqueceuId">
              <div class="form-group">
                  <label>E-mail Cadastrado</label>
                  <input type="email" id="emailRecuperacao" required placeholder="exemplo@email.com">
              </div>
              <button type="submit" class="btn-primary" style="width:100%;">Localizar Pedidos</button>
          </form>
          <div id="listaIdsRecuperados" style="margin-top:2rem;"></div>
      </div>
  </div>

  <div id="analiseIAOverlay" class="pedido-confirmacao-overlay">
      <div class="pedido-confirmacao-card" style="max-width:700px;">
          <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">
              <h2 style="font-size:1.3rem; margin:0; display:flex; align-items:center; gap:10px;"><i class="fas fa-brain" style="color:var(--gold-solid);"></i> Inteligência Artificial</h2>
              <button id="fecharAnaliseIA" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <div id="resultadoAnaliseIA" style="font-size:0.95rem; color:#ddd; max-height:60vh; overflow-y:auto; line-height:1.8;"></div>
      </div>
  </div>

  <header class="header">
    <div class="container header-content">
      <div class="logo">
        <div class="logo-icon"><img src="https://raw.githubusercontent.com/mblarson/sistema-pedidos-camisetas/main/50ANOS8080.png" alt="Logo" onerror="this.style.display='none'"></div>
        <div class="logo-text"><h1>UMADEMATS</h1><span>IGREJA EVANGÉLICA ASSEMBLEIA DE DEUS MS</span></div>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="container">
      
      <section id="home" class="section active">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:75vh; text-align:center;">
            <h1 class="home-title" style="line-height:1.1; margin-bottom:1.5rem;">Pedidos de Camisetas <br><span class="text-gold">Jubileu de Ouro</span></h1>
            <div class="menu-container">
                <button class="menu-button" id="btnNovoPedido"><span><i class="fas fa-plus-circle" style="margin-right:10px; color:var(--gold-solid);"></i> Realizar Novo Pedido</span> <i class="fas fa-chevron-right"></i></button>
                <button class="menu-button" id="btnConsultarPedido"><span><i class="fas fa-search" style="margin-right:10px; color:var(--gold-solid);"></i> Consultar Pedido</span> <i class="fas fa-chevron-right" style="color:var(--gold-solid);"></i></button>
                <button class="menu-button" id="btnAdministrador"><span><i class="fas fa-shield-alt" style="margin-right:10px; color:var(--gold-solid);"></i> Área Administrativa</span> <i class="fas fa-lock" style="font-size:0.9rem; color:var(--gold-solid);"></i></button>
            </div>
        </div>
      </section>

      <section id="consultar" class="section">
        <button class="back-button" id="voltarHomeConsulta"><i class="fas fa-arrow-left"></i> Voltar</button>
        <div class="modern-form" style="max-width:600px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:2.5rem;">
                <h2 style="margin-bottom:0.5rem;">Localizar Pedido</h2>
                <p style="color:var(--text-muted);">Informe seus dados para acessar o status.</p>
            </div>
            <form id="formConsultarNumero">
                <div class="form-group">
                    <label>Código do Pedido (ID)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="numPedidoConsultaInput" placeholder="Ex: 3Xy9..." required>
                        <button type="submit" class="btn-primary" style="padding:0 1.5rem; border-radius:var(--radius-md);"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </form>
            <div style="display:flex; align-items:center; margin:2rem 0; gap:1rem;">
                <div style="height:1px; background:var(--border-subtle); flex:1;"></div>
                <span style="color:var(--text-muted); font-size:0.8rem;">OU</span>
                <div style="height:1px; background:var(--border-subtle); flex:1;"></div>
            </div>
            <form id="formConsultarEmail">
                <div class="form-group">
                    <label>Buscar por E-mail</label>
                    <div style="display:flex; gap:10px;">
                        <input type="email" id="emailConsultaInput" placeholder="seu@email.com" required>
                        <button type="submit" class="btn-primary" style="padding:0 1.5rem; border-radius:var(--radius-md);"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>
            <div style="text-align:center; margin-top:2rem;">
                <a id="btnEsqueceuId" style="color:var(--gold-solid); cursor:pointer; font-size:0.85rem; font-weight:600;">Esqueci meu código</a>
            </div>
        </div>
        <div id="resultadoConsulta" style="margin-top:2rem;"></div>
        <div id="mensagemConsulta"></div>
      </section>

      <section id="pedido" class="section">
        <button class="back-button" id="voltarHome1"><i class="fas fa-arrow-left"></i> Voltar</button>
        
        <div style="max-width:900px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:2rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1.5rem;">
                <div><h2 id="pedidoTitulo" style="margin-bottom:0.5rem;">Novo Pedido</h2><p id="pedidoSubtitulo" style="color:var(--text-muted);">Preencha os dados do coordenador responsável.</p></div>
                <div style="color:var(--gold-solid); font-weight:700;">2025 Collection</div>
            </div>

            <form id="formPedido">
                <input type="hidden" id="pedidoDocId" name="docId" value="">
                
                <div class="form-grid">
                    <div class="form-group"><label for="nome">Nome Completo</label><input type="text" id="nome" name="nome" required placeholder="Nome do Líder"></div>
                    <div class="form-group"><label>Localização</label><div class="radio-group"><label class="radio-label"><input type="radio" name="local" value="Capital" required id="radioCapital"> Capital</label><label class="radio-label"><input type="radio" name="local" value="Interior" required id="radioInterior"> Interior</label></div></div>
                    <div class="form-group"><label id="setorCidadeLabel">Setor / Cidade</label><div id="setorCidadeContainer"><input type="text" id="setor" name="setor" required></div></div>
                    <div class="form-group"><label for="email">E-mail (Obrigatório)</label><input type="email" id="email" name="email" required placeholder="Para receber confirmação"></div>
                    <div class="form-group"><label for="contato">Número para Contato</label><input type="text" id="contato" name="contato" required placeholder="(XX) 9XXXX-XXXX"></div>
                </div>

                <div style="margin-top:4rem;">
                    <h3 style="text-align:center; color:var(--gold-solid); margin-bottom:2.5rem; text-transform:uppercase; font-size:1.1rem; letter-spacing:2px;">Seleção de Tamanhos</h3>
                    
                    <div class="cor-header">
                        <div class="cor-dot" style="background-color: var(--shirt-verde);"></div>
                        <h4 style="margin:0; color:#fff;">Cor: <span style="color: var(--shirt-verde);">Verde-Oliva</span></h4>
                    </div>

                    <div class="form-grid">
                        <div class="tipo-camiseta">
                            <h4>Infantil (Verde)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>1</label><input type="number" id="verde_infantil_1" name="verde_infantil_1" min="0" value="0"></div>
                                <div class="tamanho-item"><label>2</label><input type="number" id="verde_infantil_2" name="verde_infantil_2" min="0" value="0"></div>
                                <div class="tamanho-item"><label>4</label><input type="number" id="verde_infantil_4" name="verde_infantil_4" min="0" value="0"></div>
                                <div class="tamanho-item"><label>6</label><input type="number" id="verde_infantil_6" name="verde_infantil_6" min="0" value="0"></div>
                                <div class="tamanho-item"><label>8</label><input type="number" id="verde_infantil_8" name="verde_infantil_8" min="0" value="0"></div>
                                <div class="tamanho-item"><label>10</label><input type="number" id="verde_infantil_10" name="verde_infantil_10" min="0" value="0"></div>
                                <div class="tamanho-item"><label>12</label><input type="number" id="verde_infantil_12" name="verde_infantil_12" min="0" value="0"></div>
                                <div class="tamanho-item"><label>14</label><input type="number" id="verde_infantil_14" name="verde_infantil_14" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta">
                            <h4>Babylook (Verde)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="verde_babylook_PP" name="verde_babylook_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="verde_babylook_P" name="verde_babylook_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="verde_babylook_M" name="verde_babylook_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="verde_babylook_G" name="verde_babylook_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="verde_babylook_GG" name="verde_babylook_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="verde_babylook_XGG" name="verde_babylook_XGG" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta" style="grid-column: 1 / -1;">
                            <h4>Unissex (Verde)</h4>
                            <div class="tamanhos-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="verde_unissex_PP" name="verde_unissex_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="verde_unissex_P" name="verde_unissex_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="verde_unissex_M" name="verde_unissex_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="verde_unissex_G" name="verde_unissex_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="verde_unissex_GG" name="verde_unissex_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="verde_unissex_XGG" name="verde_unissex_XGG" min="0" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="cor-header" style="margin-top: 3rem;">
                        <div class="cor-dot" style="background-color: var(--shirt-terracota);"></div>
                        <h4 style="margin:0; color:#fff;">Cor: <span style="color: var(--shirt-terracota);">Terracota</span></h4>
                    </div>

                    <div class="form-grid">
                        <div class="tipo-camiseta">
                            <h4>Infantil (Terracota)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>1</label><input type="number" id="terracota_infantil_1" name="terracota_infantil_1" min="0" value="0"></div>
                                <div class="tamanho-item"><label>2</label><input type="number" id="terracota_infantil_2" name="terracota_infantil_2" min="0" value="0"></div>
                                <div class="tamanho-item"><label>4</label><input type="number" id="terracota_infantil_4" name="terracota_infantil_4" min="0" value="0"></div>
                                <div class="tamanho-item"><label>6</label><input type="number" id="terracota_infantil_6" name="terracota_infantil_6" min="0" value="0"></div>
                                <div class="tamanho-item"><label>8</label><input type="number" id="terracota_infantil_8" name="terracota_infantil_8" min="0" value="0"></div>
                                <div class="tamanho-item"><label>10</label><input type="number" id="terracota_infantil_10" name="terracota_infantil_10" min="0" value="0"></div>
                                <div class="tamanho-item"><label>12</label><input type="number" id="terracota_infantil_12" name="terracota_infantil_12" min="0" value="0"></div>
                                <div class="tamanho-item"><label>14</label><input type="number" id="terracota_infantil_14" name="terracota_infantil_14" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta">
                            <h4>Babylook (Terracota)</h4>
                            <div class="tamanhos-grid">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="terracota_babylook_PP" name="terracota_babylook_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="terracota_babylook_P" name="terracota_babylook_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="terracota_babylook_M" name="terracota_babylook_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="terracota_babylook_G" name="terracota_babylook_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="terracota_babylook_GG" name="terracota_babylook_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="terracota_babylook_XGG" name="terracota_babylook_XGG" min="0" value="0"></div>
                            </div>
                        </div>

                        <div class="tipo-camiseta" style="grid-column: 1 / -1;">
                            <h4>Unissex (Terracota)</h4>
                            <div class="tamanhos-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                                <div class="tamanho-item"><label>PP</label><input type="number" id="terracota_unissex_PP" name="terracota_unissex_PP" min="0" value="0"></div>
                                <div class="tamanho-item"><label>P</label><input type="number" id="terracota_unissex_P" name="terracota_unissex_P" min="0" value="0"></div>
                                <div class="tamanho-item"><label>M</label><input type="number" id="terracota_unissex_M" name="terracota_unissex_M" min="0" value="0"></div>
                                <div class="tamanho-item"><label>G</label><input type="number" id="terracota_unissex_G" name="terracota_unissex_G" min="0" value="0"></div>
                                <div class="tamanho-item"><label>GG</label><input type="number" id="terracota_unissex_GG" name="terracota_unissex_GG" min="0" value="0"></div>
                                <div class="tamanho-item"><label>XGG</label><input type="number" id="terracota_unissex_XGG" name="terracota_unissex_XGG" min="0" value="0"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:3rem; text-align:center;">
                    <button type="submit" class="btn-primary" style="min-width:250px;"><span id="submitButtonText">Confirmar e Enviar</span></button>
                </div>
            </form>
            <div id="mensagemPedido"></div>
        </div>
      </section>

      <section id="admin" class="section">
        <button class="back-button" id="voltarHome3"><i class="fas fa-arrow-left"></i> Voltar</button>
        <div id="loginAdmin" class="modern-form" style="max-width:450px; margin:3rem auto;">
            <div style="text-align:center; margin-bottom:2rem;"><h2 style="margin-bottom:0.5rem;">Acesso Restrito</h2><p style="color:var(--text-muted);">Apenas pessoal autorizado</p></div>
            <form id="formLoginAdmin" style="text-align:center;">
                <div class="form-group"><label>E-mail Administrativo</label><input type="email" id="emailAdmin" required placeholder="admin@umademats.com.br"></div>
                <div class="form-group"><label>Senha de Administrador</label><div style="position:relative;"><input type="password" id="senhaAdmin" required style="padding-right:40px !important;"><button type="button" onclick="window.togglePasswordVisibility('senhaAdmin', this.querySelector('i'))" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-eye"></i></button></div></div>
                <button type="submit" class="btn-primary" style="width:100%; margin-top:1rem;">Entrar no Sistema</button>
            </form>
            <div id="mensagemLogin"></div>
        </div>

        <div id="painelAdmin" class="admin-panel" style="display:none; border:none; background:transparent; padding:0; box-shadow:none;">
            <div class="admin-menu">
                <button class="admin-menu-btn active" id="btnDashboard" onclick="window.mostrarAdminSecao('dashboard')">Dashboard</button>
                <button class="admin-menu-btn" id="btnPedidos" onclick="window.mostrarAdminSecao('pedidos')">Pedidos</button>
                <button class="admin-menu-btn" id="btnEvento" onclick="window.mostrarAdminSecao('evento')">Evento</button>
                <button class="admin-menu-btn" id="btnPagamentos" onclick="window.mostrarAdminSecao('pagamentos')">Pagamentos</button>
            </div>

            <div id="admin-dashboard" class="admin-section active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h2>Visão Geral</h2>
                    <button id="atualizarDashboard" onclick="window.recarregarDashboardComFeedback()" style="background:transparent; border:1px solid var(--border-subtle); color:var(--text-main); padding:0.5rem 1rem; border-radius:50px; cursor:pointer; display:flex; align-items:center; gap:8px;"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>
                <button class="btn-ai-magic" id="btnAnaliseIA" style="margin-bottom:2rem; padding:1.2rem;"><i class="fas fa-sparkles"></i> Gerar Análise Inteligente de Vendas</button>
                <div class="dashboard-cards">
                    <div class="card"><div class="card-content"><h4>Pedidos Totais</h4><p class="card-value" id="totalPedidos">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Camisetas</h4><p class="card-value" id="totalCamisetas">0</p></div></div>
                    <div class="card"><div class="card-content"><h4>Receita Prevista</h4><p class="card-value text-gold" id="totalArrecadado">R$ 0,00</p></div></div>
                    <div class="card"><div class="card-content"><h4>Total Recebido (Real)</h4><p class="card-value text-gold" id="totalRecebidoReal">R$ 0,00</p></div></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="margin-bottom:1.5rem; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem;">Métricas por Categoria</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:2rem; text-align:center;">
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Infantil</span><strong style="font-size:1.8rem;" id="totalInfantis">0</strong></div>
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Babylook</span><strong style="font-size:1.8rem;" id="totalBabylook">0</strong></div>
                        <div class="detail-item"><span style="color:var(--text-muted); font-size:0.85rem; display:block; margin-bottom:5px;">Unissex</span><strong style="font-size:1.8rem;" id="totalUnissex">0</strong></div>
                    </div>
                </div>
                <button class="btn-primary" id="btnVerDetalhes" style="width:100%; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);">Relatório Detalhado de Tamanhos</button>
            </div>

            <div id="admin-detalhes-tamanhos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:2rem; align-items:center;"><h2>Matriz de Tamanhos</h2><button id="voltarDashboard" style="background:none; border:none; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; gap:5px;"><i class="fas fa-arrow-left"></i> Voltar</button></div>
                
                <!-- ADULTO -->
                <h3 style="color:#fff; margin-bottom:1rem; border-bottom:1px solid var(--gold-solid); padding-bottom:0.5rem;">ADULTO</h3>
                <div class="card" style="margin-bottom:1rem;">
                    <h4 style="color:var(--shirt-verde); margin-bottom:1rem;">Verde-Oliva</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaAdultoVerde" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="adultoVerdeBody"></tbody></table></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--shirt-terracota); margin-bottom:1rem;">Terracota</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaAdultoTerra" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="adultoTerraBody"></tbody></table></div>
                </div>

                <!-- BABYLOOK -->
                <h3 style="color:#fff; margin-bottom:1rem; border-bottom:1px solid var(--gold-solid); padding-bottom:0.5rem;">BABYLOOK</h3>
                <div class="card" style="margin-bottom:1rem;">
                    <h4 style="color:var(--shirt-verde); margin-bottom:1rem;">Verde-Oliva</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaBabyVerde" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="babyVerdeBody"></tbody></table></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--shirt-terracota); margin-bottom:1rem;">Terracota</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaBabyTerra" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>PP</th><th>P</th><th>M</th><th>G</th><th>GG</th><th>XGG</th></tr></thead><tbody id="babyTerraBody"></tbody></table></div>
                </div>

                <!-- INFANTIL -->
                <h3 style="color:#fff; margin-bottom:1rem; border-bottom:1px solid var(--gold-solid); padding-bottom:0.5rem;">INFANTIL</h3>
                <div class="card" style="margin-bottom:1rem;">
                    <h4 style="color:var(--shirt-verde); margin-bottom:1rem;">Verde-Oliva</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaInfantilVerde" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>1</th><th>2</th><th>4</th><th>6</th><th>8</th><th>10</th><th>12</th><th>14</th></tr></thead><tbody id="infantilVerdeBody"></tbody></table></div>
                </div>
                <div class="card" style="margin-bottom:2rem;">
                    <h4 style="color:var(--shirt-terracota); margin-bottom:1rem;">Terracota</h4>
                    <div class="tamanhos-table-container"><table class="tamanhos-table" id="tabelaInfantilTerra" style="width:100%; border-collapse:collapse;"><thead><tr style="border-bottom:1px solid var(--border-subtle); text-align:left;"><th style="padding:10px; color:var(--text-muted);">TIPO</th><th>1</th><th>2</th><th>4</th><th>6</th><th>8</th><th>10</th><th>12</th><th>14</th></tr></thead><tbody id="infantilTerraBody"></tbody></table></div>
                </div>
                
                <div style="display:flex; gap:1rem;"><button id="btnGerarPdf" class="btn-primary" style="flex:1;">Baixar PDF</button><button id="atualizarDetalhesTamanho" style="flex:1; background:transparent; border:1px solid var(--border-subtle); color:#fff; border-radius:50px; cursor:pointer;">Atualizar Dados</button></div>
            </div>

            <div id="admin-evento" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;"><h3>Configuração do Evento</h3> <button id="atualizarEvento" onclick="window.recarregarDetalhesEventoComFeedback()" style="background:none; border:none; color:var(--gold-solid); font-size:1.0rem; cursor:pointer;"><i class="fas fa-sync-alt"></i> Atualizar</button></div>
                <div class="card" style="margin-bottom:2rem;">
                    <div style="display:flex; align-items:center; gap:1rem; margin-bottom: 1.5rem;">
                        <label style="color:var(--text-muted); margin:0;">Valor Unitário (R$)</label>
                        <input type="number" id="valorCamisetaInput" step="0.01" style="width:120px;">
                        <button id="btnSalvarValor" class="btn-primary" type="button" style="padding:0.8rem 1.5rem; font-size:0.8rem; display:flex; justify-content:center; align-items:center;">SALVAR</button>
                    </div>
                    <!-- BOTÃO ENCERRAR EVENTO ADICIONADO AQUI -->
                    <button id="btnEncerrarEventoAction" class="btn-primary" type="button" style="width:100%; background:var(--danger-color); color:#fff; margin-top: 1rem;">ENCERRAR EVENTO</button>
                </div>
                <div class="card"><h4 style="margin-bottom:1.5rem;">Por Setor / Localidade</h4><div id="resumoEventoLocais"></div></div>
            </div>

            <div id="admin-pedidos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h3>Todos os Pedidos</h3>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btnFecharPedidosAction" style="background:rgba(212, 175, 55, 0.1); border:1px solid var(--gold-solid); color:var(--gold-solid); font-size:0.75rem; cursor:pointer; padding:6px 12px; border-radius:50px; font-weight:700; text-transform:uppercase;"><i class="fas fa-ban"></i> Fechar Pedidos</button>
                        <button id="btnReabrirPedidosAction" style="background:rgba(100, 255, 218, 0.1); border:1px solid var(--success-color); color:var(--success-color); font-size:0.75rem; cursor:pointer; padding:6px 12px; border-radius:50px; font-weight:700; text-transform:uppercase; display:none;"><i class="fas fa-check"></i> Reabrir Pedidos</button>
                        <button id="atualizarPedidos" onclick="window.recarregarPedidosComFeedback()" style="background:none; border:none; color:var(--gold-solid); font-size:1.2rem; cursor:pointer;"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                
                <div id="filtrosPedidos" class="search-container">
                    <div class="form-group" style="margin-bottom:0.5rem;">
                        <input type="text" id="buscaInput" placeholder="🔍 Buscar por nome, ID, setor, cidade, telefone..." style="background:rgba(255,255,255,0.05)!important; border-color:var(--border-subtle)!important;">
                    </div>
                    <div class="filter-container">
                        <span style="color:var(--text-muted); text-transform:uppercase;">LOCAL:</span>
                        <label class="filter-radio"><input type="radio" name="filtroLocal" value="todos" checked> <span>Todos</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroLocal" value="Capital"> <span>Capital</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroLocal" value="Interior"> <span>Interior</span></label>
                    </div>
                </div>

                <div id="listaPedidos" style="margin-top:1.5rem;"></div>
            </div>

            <div id="admin-pagamentos" class="admin-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h3>Pagamentos</h3>
                    <button id="atualizarPagamentos" onclick="window.recarregarPagamentosComFeedback()" style="background:none; border:none; color:var(--gold-solid); font-size:1rem; cursor:pointer;"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>
                
                <!-- INÍCIO: NOVOS FILTROS E BUSCA -->
                <div id="filtrosPagamentos" class="search-container">
                    <div class="form-group" style="margin-bottom:0.5rem;">
                        <input type="text" id="buscaPagamentosInput" placeholder="🔍 Buscar por nome, ID, setor, cidade, telefone..." style="background:rgba(255,255,255,0.05)!important; border-color:var(--border-subtle)!important;">
                    </div>
                    <div class="filter-container">
                        <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase;">Status:</span>
                        <label class="filter-radio"><input type="radio" name="filtroStatusPagamento" value="todos" checked> <span>Todos</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroStatusPagamento" value="parcialmente"> <span>PARCIAL</span></label>
                        <label class="filter-radio"><input type="radio" name="filtroStatusPagamento" value="quitado"> <span>Quitado</span></label>
                    </div>
                </div>
                <!-- FIM: NOVOS FILTROS E BUSCA -->
                
                <div id="listaPagamentos">
                    </div>
            </div>

        </div>
      </section>

    </div>
  </main>

  <footer style="text-align:center; padding:3rem 0; border-top:1px solid var(--border-subtle); margin-top:4rem; color:var(--text-muted); font-size:0.8rem;">
    <p>&copy; 2025 UMADEMATS</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
   const firebaseConfig = {
      apiKey: "AIzaSyDmYkZZ35rc--NPXdhSI0Bo7GzVvtLVFkE",
      authDomain: "pedidosumademats.firebaseapp.com",
      projectId: "pedidosumademats",
      storageBucket: "pedidosumademats.firebasestorage.app",
      messagingSenderId: "604273766416",
      appId: "1:604273766416:web:4813a2365db9ea0e9e1a95"
    };
    
    window.pedidosCache = [];
    let PRECO_CAMISETA = 30.00; 
    let SISTEMA_ABERTO = true; 
    let pedidoDoModal = null; // Variável global para armazenar o pedido exibido no modal
    let pedidoParaExcluir = null; // Variável global para exclusão
    let ultimoDocumentoCarregado = null; // Controle para o botão Expandir
    
    // --- COLE AQUI O CÓDIGO ABAIXO ---
    function escapeHTML(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    // ---------------------------------
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc, getDoc, onSnapshot, serverTimestamp, deleteDoc, limit, orderBy, startAfter } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const pedidosCollection = collection(db, "pedidos");
    
    // REGRA DE RENOMEAÇÃO: configDocRef agora aponta para "evento"
    const configDocRef = doc(db, "configuracoes", "evento"); 
    
    const configSistemaRef = doc(db, "configuracoes", "sistema");

    let currentPedidoParaEdicao = null;
    window.adminAcessouPainel = false;

    // ===============================================
    // FUNÇÕES DA TELA INICIAL MÓVEL
    // ===============================================

    window.handleAccessAndLoading = function() {
        const btn = document.getElementById('btnAcessarSistema');
        const loader = document.getElementById('splashLoader');

        // LOG: Início do processo de acesso e loading.
        console.log("LOG: Splash Screen - Início do processo de loading.");

        // 1. Esconder botão, exibir loader
        btn.style.display = 'none';
        loader.style.display = 'block'; // Garante que o loader apareça
        loader.classList.add('active'); 

        // 2. Aguardar 2 segundos e sumir com o splash
        setTimeout(() => {
            const splashScreen = document.getElementById('mobileSplashScreen');
            const header = document.querySelector('header');
            const main = document.querySelector('main');
            const footer = document.querySelector('footer');

            // LOG: 2 segundos passados. Removendo splash e exibindo sistema.
            console.log("LOG: Splash Screen - Loading concluído. Exibindo sistema principal.");


            splashScreen.classList.remove('active');
            
            // 3. Remover a ocultação do conteúdo principal
            header.style.display = '';
            main.style.display = '';
            footer.style.display = '';

            // Oculta o loader e exibe o botão para próxima vez (se houver)
            loader.classList.remove('active');
            loader.style.display = 'none'; // Esconde o loader
            btn.style.display = 'flex'; 

        }, 2000); // 2 segundos de loading
    };

    const checkAndShowSplash = () => {
        const splashScreen = document.getElementById('mobileSplashScreen');
        const video = document.getElementById('splashVideo');
        const header = document.querySelector('header');
        const main = document.querySelector('main');
        const footer = document.querySelector('footer');

        // A tela inicial deve aparecer apenas em mobile (largura < 768px)
        if (window.innerWidth >= 768) {
            splashScreen.style.display = 'none'; // Garante que esteja oculto no desktop
            // LOG: Desktop detectado. Splash oculto. Sistema visível.
            console.log("LOG: Splash Screen - Desktop detectado. Exibição direta.");
            return;
        }

        // Se for Mobile, exibir o splash e ocultar o conteúdo principal.
        splashScreen.classList.add('active'); // Para ativar a transição e o display: flex
        
        // Oculta o conteúdo principal para mostrar apenas o splash
        header.style.display = 'none';
        main.style.display = 'none';
        footer.style.display = 'none';
        
        // LOG: Mobile detectado. Exibindo Splash e ocultando sistema principal.
        console.log("LOG: Splash Screen - Mobile detectado. Exibindo tela inicial.");

        // Tenta garantir que o vídeo comece a tocar em mobile
        if (video) {
            video.play().catch(e => console.log('Video auto-play blocked:', e));
        }
    };


    // ===============================================
    // FUNÇÕES DE AUTENTICAÇÃO E INICIALIZAÇÃO
    // ===============================================

    (function initBeamsBackground() {
        const canvas = document.getElementById('beams-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        const MINIMUM_BEAMS = 20; const intensity = "strong";
        const opacityMap = { subtle: 0.7, medium: 0.85, strong: 1 };
        let beams = []; let animationFrameId = 0;
        function createBeam(width, height) {
            const angle = -35 + Math.random() * 10;
            return { x: Math.random() * width * 1.5 - width * 0.25, y: Math.random() * height * 1.5 - height * 0.25, width: 30 + Math.random() * 60, length: height * 2.5, angle: angle, speed: 0.6 + Math.random() * 1.2, opacity: 0.12 + Math.random() * 0.16, hue: 190 + Math.random() * 70, pulse: Math.random() * Math.PI * 2, pulseSpeed: 0.02 + Math.random() * 0.03 };
        }
        function resetBeam(beam, index, totalBeams) {
            if (!canvas) return beam;
            const column = index % 3; const spacing = canvas.width / 3;
            beam.y = canvas.height + 100; beam.x = column * spacing + spacing / 2 + (Math.random() - 0.5) * spacing * 0.5; beam.width = 100 + Math.random() * 100; beam.speed = 0.5 + Math.random() * 0.4; beam.hue = 190 + (index * 70) / totalBeams; beam.opacity = 0.2 + Math.random() * 0.1; return beam;
        }
        function drawBeam(ctx, beam) {
            ctx.save(); ctx.translate(beam.x, beam.y); ctx.rotate((beam.angle * Math.PI) / 180);
            const pulsingOpacity = beam.opacity * (0.8 + Math.sin(beam.pulse) * 0.2) * opacityMap[intensity];
            const gradient = ctx.createLinearGradient(0, 0, 0, beam.length);
            gradient.addColorStop(0, `hsla(${beam.hue}, 85%, 65%, 0)`); gradient.addColorStop(0.1, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`); gradient.addColorStop(0.4, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`); gradient.addColorStop(0.6, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`); gradient.addColorStop(0.9, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`); gradient.addColorStop(1, `hsla(${beam.hue}, 85%, 65%, 0)`);
            ctx.fillStyle = gradient; ctx.fillRect(-beam.width / 2, 0, beam.width, beam.length); ctx.restore();
        }
        function animate() {
            if (!canvas || !ctx) return; ctx.clearRect(0, 0, canvas.width, canvas.height); const totalBeams = beams.length;
            beams.forEach((beam, index) => { beam.y -= beam.speed; beam.pulse += beam.pulseSpeed; if (beam.y + beam.length < -100) { resetBeam(beam, index, totalBeams); } drawBeam(ctx, beam); }); animationFrameId = requestAnimationFrame(animate);
        }
        function updateCanvasSize() {
            const dpr = window.devicePixelRatio || 1; canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr; ctx.scale(dpr, dpr);
            const totalBeams = MINIMUM_BEAMS * 1.5; beams = Array.from({ length: totalBeams }, () => createBeam(canvas.width / dpr, canvas.height / dpr));
        }
        updateCanvasSize(); window.addEventListener("resize", updateCanvasSize); animate();
    })();

    const initAuth = async () => {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (!user.isAnonymous) {
                    // Usuário logado. Apenas inicia monitores.
                    iniciarMonitoramentoPreco();
                    iniciarMonitoramentoSistema();
                } else {
                    // Usuário Anônimo. Garante que os monitores estejam rodando.
                    const painelDiv = document.getElementById('painelAdmin');
                    if (painelDiv) { painelDiv.style.display = 'none'; }
                    iniciarMonitoramentoPreco();
                    iniciarMonitoramentoSistema();
                }
            } else { signInAnonymously(auth).catch(console.error); }
        });
    };
    
    const formatarMoeda = (valor) => { return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
    
    // Função auxiliar para data
    const formatarDataPTBR = (dataStr) => {
        if(!dataStr) return "-";
        // Se for string DDMMAAAA (legado/input)
        if(dataStr.length === 8 && !dataStr.includes('-') && !dataStr.includes('/')) {
             return `${dataStr.substr(0,2)}/${dataStr.substr(2,2)}/${dataStr.substr(4,4)}`;
        }
        // Se ja tiver barra, retorna igual
        if(dataStr.includes('/')) return dataStr;

        // Se for ISO ou data JS
        const dateObj = new Date(dataStr);
        // Garante que é uma data válida antes de formatar
        if(isNaN(dateObj)) return dataStr; 
        return dateObj.toLocaleDateString('pt-BR');
    };

    let unsubscribePreco = null; let unsubscribeSistema = null;

    function iniciarMonitoramentoPreco() {
        if (unsubscribePreco) return; 
        unsubscribePreco = onSnapshot(configDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const novoPreco = parseFloat(docSnap.data().valor_camiseta) || 30.00;
                if (PRECO_CAMISETA !== novoPreco) {
                    PRECO_CAMISETA = novoPreco;
                    const valInput = document.getElementById('valorCamisetaInput');
                    if (valInput && document.activeElement !== valInput) { valInput.value = PRECO_CAMISETA.toFixed(2); }
                    // Verifica se o painel está visível antes de carregar o dashboard
                    if (document.getElementById('painelAdmin').style.display === 'block') { window.carregarDashboard(); window.carregarDetalhesEvento(); }
                } else {
                    const valInput = document.getElementById('valorCamisetaInput');
                    if(valInput && valInput.value === "") valInput.value = PRECO_CAMISETA.toFixed(2);
                }
            } else { setDoc(configDocRef, { valor_camiseta: 30.00 }).catch(console.error); PRECO_CAMISETA = 30.00; }
        }, (error) => { console.error("Erro no monitoramento de preço:", error); });
    }

    function iniciarMonitoramentoSistema() {
        if (unsubscribeSistema) return;
        unsubscribeSistema = onSnapshot(configSistemaRef, (docSnap) => {
            if (docSnap.exists()) { const data = docSnap.data(); SISTEMA_ABERTO = data.aberto !== false; } else { SISTEMA_ABERTO = true; setDoc(configSistemaRef, { aberto: true }).catch(console.error); }
            const btnFechar = document.getElementById('btnFecharPedidosAction'); const btnReabrir = document.getElementById('btnReabrirPedidosAction');
            if (btnFechar && btnReabrir) {
                if (SISTEMA_ABERTO) { btnFechar.style.display = 'inline-block'; btnReabrir.style.display = 'none'; } else { btnFechar.style.display = 'none'; btnReabrir.style.display = 'inline-block'; }
            }
        });
    }

    initAuth();

    async function callGemini(promptText) { return "Simulated Gemini Response"; }

    window.handleAnaliseIA = async function() {
       document.getElementById('resultadoAnaliseIA').innerHTML = `<p style="color:#8892b0">A análise requer chave de API válida.</p>`;
    };

    function getQuantidadesFromForm(formData, prefix) {
        const quantidades = {};
        for (const [key, value] of formData.entries()) {
            if (key.startsWith(prefix + '_')) {
                // remove prefixo "verde_infantil_" -> "1"
                const cleanKey = key.replace(prefix + '_', '');
                quantidades[cleanKey] = parseInt(value) || 0;
            }
        }
        return quantidades;
    }

    window.togglePasswordVisibility = function(inputId, iconElement) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; iconElement.classList.remove('fa-eye'); iconElement.classList.add('fa-eye-slash'); } else { input.type = "password"; iconElement.classList.remove('fa-eye-slash'); iconElement.classList.add('fa-eye'); }
    };

    function isValidEmail(value) { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return emailRegex.test(value); }
    function normalizeString(str) { if (typeof str !== 'string') return ''; return str.toUpperCase().trim(); }

    window.mostrarSecao = function(secao) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const secaoElement = document.getElementById(secao);
        if (secaoElement) { secaoElement.classList.add('active'); secaoElement.style.opacity = ""; secaoElement.style.transform = ""; }
    };

    window.mostrarAdminSecao = function(secao) {
        document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.admin-menu-btn').forEach(b => { b.classList.remove('active'); });
        
        let secaoId = `admin-${secao}`;
        let btnId = `btn${secao.charAt(0).toUpperCase() + secao.slice(1)}`;
        
        const secaoElement = document.getElementById(secaoId); 
        if (secaoElement) secaoElement.style.display = 'block';
        
        const btn = document.getElementById(btnId); 
        if (btn) btn.classList.add('active');
        
        // CORREÇÃO: Força o recarregamento ao entrar na seção (Regra 2 e 3)
        // Isso é mantido, pois o recarregamento deve ocorrer ao navegar pelas abas
        if (secao === 'dashboard') window.carregarDashboard();
        else if (secao === 'pedidos') window.carregarPedidos();
        else if (secao === 'evento') window.carregarDetalhesEvento();
        else if (secao === 'pagamentos') window.carregarPagamentos();
    };

    window.redirecionarComAnimacao = function(secao, callback) {
        const elementoAtual = document.querySelector('.section.active');
        const proximoElemento = document.getElementById(secao);
        if (!elementoAtual || !proximoElemento || elementoAtual === proximoElemento) { window.mostrarSecao(secao); if (callback) callback(); return; }
        elementoAtual.style.opacity = '0'; elementoAtual.style.transform = 'translateY(20px)';
        setTimeout(() => { window.mostrarSecao(secao); if (callback) callback(); proximoElemento.style.opacity = '0'; proximoElemento.style.transform = 'translateY(20px)'; setTimeout(() => { proximoElemento.style.opacity = '1'; proximoElemento.style.transform = 'translateY(0)'; }, 50); }, 400);
    };

    window.exibirMensagem = function(elementoId, tipo, mensagem) {
        const elemento = document.getElementById(elementoId); if (!elemento) return;
        const color = tipo === 'sucesso' ? 'var(--success-color)' : 'var(--danger-color)';
        elemento.innerHTML = `<div style="padding:1rem; margin-top:1rem; border-radius:var(--radius-md); background:rgba(255,255,255,0.05); border-left:4px solid ${color}; color:#fff; font-size:0.9rem; box-shadow:0 5px 15px rgba(0,0,0,0.2);"><i class="fas fa-${tipo === 'sucesso' ? 'check-circle' : 'exclamation-circle'}" style="color:${color}; margin-right:8px;"></i> ${mensagem}</div>`;
        setTimeout(() => { elemento.innerHTML = ''; }, 5000);
    };

    window.mostrarCarregamento = function(mostrar = true, texto = 'PROCESSANDO...') {
        const loadingOverlay = document.getElementById('loadingOverlay'); const loadingText = document.getElementById('loadingText'); loadingText.textContent = texto; if (mostrar) loadingOverlay.classList.add('active'); else loadingOverlay.classList.remove('active');
    };

    window.atualizarElemento = function(elementId, valor) { const elemento = document.getElementById(elementId); if (elemento) elemento.textContent = valor; };
    window.fecharConfirmacaoPedido = function() { document.getElementById('pedidoConfirmacaoOverlay').classList.remove('active'); window.mostrarSecao('home'); };

    window.copiarNumeroPedido = function(numPedido) {
        const fallbackCopy = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if (successful) alert('CÓDIGO COPIADO!'); else alert('Erro ao copiar.'); } catch (err) { alert('Erro ao copiar.'); } document.body.removeChild(textArea); };
        if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(numPedido).then(() => { alert('CÓDIGO COPIADO!'); }).catch(err => { console.warn("Clipboard API failed, trying fallback...", err); fallbackCopy(numPedido); }); } else { fallbackCopy(numPedido); }
    };

    window.exibirConfirmacaoPedido = function(pedido) {
        const overlay = document.getElementById('pedidoConfirmacaoOverlay');
        document.getElementById('pedidoConfirmacaoNumero').innerHTML = `#${pedido.numPedido}`;
        document.getElementById('pedidoConfirmacaoInfo').innerHTML = `<p><strong>NOME:</strong> ${pedido.nome}</p><p><strong>LOCAL:</strong> ${pedido.local} / ${pedido.setor}</p>`;
        
        let resumo = "";
        const listaTamanhos = (obj) => Object.entries(obj || {}).filter(([k, v]) => v > 0).map(([k, v]) => `${k}: ${v}`).join(', ');
        
        if (pedido.verdeOliva) {
            const vInf = listaTamanhos(pedido.verdeOliva.infantil);
            const vBaby = listaTamanhos(pedido.verdeOliva.babylook);
            const vUni = listaTamanhos(pedido.verdeOliva.unissex);
            if(vInf || vBaby || vUni) {
                resumo += `<p style="margin-top:10px; color:var(--shirt-verde); font-weight:bold;">VERDE-OLIVA</p>`;
                if(vInf) resumo += `<p>Inf: ${vInf}</p>`;
                if(vBaby) resumo += `<p>Baby: ${vBaby}</p>`;
                if(vUni) resumo += `<p>Uni: ${vUni}</p>`;
            }
        }
        if (pedido.terracota) {
            const tInf = listaTamanhos(pedido.terracota.infantil);
            const tBaby = listaTamanhos(pedido.terracota.babylook);
            const tUni = listaTamanhos(pedido.terracota.unissex);
            if(tInf || tBaby || tUni) {
                resumo += `<p style="margin-top:10px; color:var(--shirt-terracota); font-weight:bold;">TERRACOTA</p>`;
                if(tInf) resumo += `<p>Inf: ${tInf}</p>`;
                if(tBaby) resumo += `<p>Baby: ${tBaby}</p>`;
                if(tUni) resumo += `<p>Uni: ${tUni}</p>`;
            }
        }
        // Legado
        if (!pedido.verdeOliva && !pedido.terracota) {
             const lInf = listaTamanhos(pedido.infantil);
             const lBaby = listaTamanhos(pedido.babylook);
             const lUni = listaTamanhos(pedido.unissex);
             if(lInf) resumo += `<p>INFANTIL: ${lInf}</p>`;
             if(lBaby) resumo += `<p>BABYLOOK: ${lBaby}</p>`;
             if(lUni) resumo += `<p>UNISSEX: ${lUni}</p>`;
        }
        
        document.getElementById('pedidoConfirmacaoTamanhos').innerHTML = resumo;
        document.getElementById('pedidoConfirmacaoTamanhos').style.display = 'block';
        overlay.classList.add('active');
    };

    window.recalcularValores = async function(novoValorString) {
        const novoValor = parseFloat(novoValorString);
        if (isNaN(novoValor) || novoValor <= 0) { /* Não usar alert, mas manter a validação */ console.error("Valor inválido para recalcular."); return; }
        window.mostrarCarregamento(true, "SALVANDO CONFIG...");
        try {
            await setDoc(configDocRef, { valor_camiseta: novoValor }, { merge: true });
            window.mostrarCarregamento(false);
            const pedidos = await window.carregarTodosPedidos();
            let totalItens = 0;
            pedidos.forEach(p => { totalItens += calcularTotalPedido(p); });
            const novoTotal = totalItens * novoValor;
            document.getElementById('confirmacaoNovoValor').innerText = formatarMoeda(novoValor);
            document.getElementById('confirmacaoNovoTotal').innerText = formatarMoeda(novoTotal);
            document.getElementById('modalSucessoFinanceiro').classList.add('active');
        } catch (error) { window.mostrarCarregamento(false); console.error("Erro fatal ao salvar preço:", error); document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao salvar preço no banco de dados. Tente novamente."; document.getElementById('modalErroPDF').classList.add('active'); }
    };

    // HELPER CENTRAL PARA CONTAR ITENS (SUPORTA LEGADO E NOVO)
    function calcularTotalPedido(p) {
        const sumObj = (obj) => Object.values(obj || {}).reduce((a, b) => a + b, 0);
        let total = 0;
        // Legado
        total += sumObj(p.infantil);
        total += sumObj(p.babylook);
        total += sumObj(p.unissex);
        // Novo: Verde
        if(p.verdeOliva) {
            total += sumObj(p.verdeOliva.infantil);
            total += sumObj(p.verdeOliva.babylook);
            total += sumObj(p.verdeOliva.unissex);
        }
        // Novo: Terracota
        if(p.terracota) {
            total += sumObj(p.terracota.infantil);
            total += sumObj(p.terracota.babylook);
            total += sumObj(p.terracota.unissex);
        }
        return total;
    }

    window.gerarRelatorioPdf = function() {
        window.mostrarCarregamento(true, 'GERANDO PDF...');
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            
            doc.setFontSize(16); doc.text("RELATÓRIO DE TAMANHOS - UMADEMATS", 148.5, 20, null, null, "center");
            doc.setFontSize(10); doc.text(`Gerado em: ${dataAtual}`, 10, 25);
            
            // Função para capturar dados das tabelas HTML
            const getTableData = (tableId) => {
                const tableElement = document.getElementById(tableId);
                if (!tableElement || tableElement.rows.length <= 1) return { head: [], body: [] };
                const head = Array.from(tableElement.querySelector('thead tr').children).map(th => th.textContent);
                let body = []; 
                Array.from(tableElement.querySelector('tbody').rows).forEach(row => { 
                    body.push(Array.from(row.children).map(td => td.textContent)); 
                });
                return { head: [head], body: body };
            };

            let nextY = 30;

            // Helper para adicionar tabela com estilo
            const addSection = (title, tableId, colorRGB) => {
                const data = getTableData(tableId);
                if (data.body.length === 0) return nextY;

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(title, 14, nextY);
                nextY += 2;

                doc.autoTable({
                    head: data.head,
                    body: data.body,
                    startY: nextY,
                    theme: 'grid',
                    headStyles: { fillColor: colorRGB, textColor: [255, 255, 255], fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 2 },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
                
                nextY = doc.lastAutoTable.finalY + 10;
                // Se não couber na página, adiciona nova página
                if (nextY > 180) { doc.addPage(); nextY = 20; }
                return nextY;
            };

            // Verde RGB: [85, 107, 47]
            // Terracota RGB: [192, 88, 56]

            // ADULTO
            doc.setFontSize(14); doc.text("ADULTO (Unissex)", 14, nextY); nextY += 6;
            nextY = addSection("Verde-Oliva", 'tabelaAdultoVerde', [85, 107, 47]);
            nextY = addSection("Terracota", 'tabelaAdultoTerra', [192, 88, 56]);

            // BABYLOOK
            if (nextY > 160) { doc.addPage(); nextY = 20; }
            doc.setFontSize(14); doc.text("BABYLOOK", 14, nextY); nextY += 6;
            nextY = addSection("Verde-Oliva", 'tabelaBabyVerde', [85, 107, 47]);
            nextY = addSection("Terracota", 'tabelaBabyTerra', [192, 88, 56]);

            // INFANTIL
            if (nextY > 160) { doc.addPage(); nextY = 20; }
            doc.setFontSize(14); doc.text("INFANTIL", 14, nextY); nextY += 6;
            nextY = addSection("Verde-Oliva", 'tabelaInfantilVerde', [85, 107, 47]);
            nextY = addSection("Terracota", 'tabelaInfantilTerra', [192, 88, 56]);

            // TOTALIZADORES NO FINAL
            if (nextY > 150) { doc.addPage(); nextY = 20; }
            
            const tInf = parseInt(document.getElementById('totalInfantis').innerText) || 0;
            const tBaby = parseInt(document.getElementById('totalBabylook').innerText) || 0;
            const tUni = parseInt(document.getElementById('totalUnissex').innerText) || 0;
            const tGeral = tInf + tBaby + tUni;
            
            doc.setDrawColor(212, 175, 55);
            doc.setLineWidth(0.5);
            doc.rect(14, nextY, 180, 40);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("RESUMO GERAL", 20, nextY + 10);
            
            doc.setFontSize(11);
            doc.text(`Total Infantil: ${tInf}`, 20, nextY + 20);
            doc.text(`Total Babylook: ${tBaby}`, 20, nextY + 26);
            doc.text(`Total Unissex: ${tUni}`, 20, nextY + 32);
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL GERAL DE PEÇAS: ${tGeral.toLocaleString('pt-BR')}`, 100, nextY + 25);

            doc.save(`Relatorio_Detalhado_Tamanhos_${dataAtual.replace(/\//g, '-')}.pdf`);
            window.mostrarCarregamento(false);
        } catch (error) {
            window.mostrarCarregamento(false);
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Não foi possível gerar o PDF. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
            console.error("Erro ao gerar PDF do Relatório:", error);
        }
    };
    
    // FUNÇÃO QUE RECUPERA O PEDIDO E CHAMA A GERAÇÃO DE PDF
    window.baixarPedidoDoModal = function() {
        if (pedidoDoModal) {
            window.gerarPdfPedidoIndividual(pedidoDoModal);
        } else {
            console.error('Erro: Pedido não está disponível no modal.');
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao tentar baixar o pedido. Tente reabrir a consulta.";
            document.getElementById('modalErroPDF').classList.add('active');
        }
    }

    // FUNÇÃO AJUSTADA PARA GERAR PDF DO PEDIDO INDIVIDUALMENTE
    window.gerarPdfPedidoIndividual = function(pedido) {
        if (!pedido || !pedido.numPedido) {
            console.error('Erro: Pedido inválido para gerar PDF.');
            // Exibe o modal de erro se o pedido for inválido
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Pedido não encontrado. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
            return;
        }

        // Inicia o loading, pois agora só é chamado via clique explícito
        window.mostrarCarregamento(true, 'GERANDO PDF DO PEDIDO...');
        
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Título e Subtítulo
            doc.setFontSize(18); doc.text("PEDIDO #" + pedido.numPedido, 105, 20, null, null, "center");
            doc.setFontSize(10); doc.text("UMADEMATS - Jubileu de Ouro", 105, 26, null, null, "center");
            
            // Dados do Coordenador
            doc.setFontSize(11);
            doc.text(`Nome: ${pedido.nome}`, 14, 40);
            doc.text(`Local: ${pedido.local} - ${pedido.setor}`, 14, 46);
            doc.text(`Contato: ${pedido.contato || 'Não informado'}`, 14, 52);
            doc.text(`E-mail: ${pedido.email}`, 14, 58);
            doc.text(`Data: ${new Date(pedido.data).toLocaleDateString('pt-BR')}`, 140, 40);

            let bodyData = [];
            let totalQtd = 0;

            const addRows = (categoryName, dataObj) => {
                Object.entries(dataObj || {}).forEach(([tamanho, qtd]) => {
                    if (qtd > 0) { 
                        // Adiciona a Categoria, Tamanho, e Quantidade
                        bodyData.push([categoryName, tamanho, qtd.toString()]); 
                        totalQtd += qtd; 
                    }
                });
            };

            // Adiciona linhas de acordo com a estrutura (Novo vs Legado)
            if (!pedido.verdeOliva && !pedido.terracota) {
                addRows("Infantil (LEGADO)", pedido.infantil);
                addRows("Babylook (LEGADO)", pedido.babylook);
                addRows("Unissex (LEGADO)", pedido.unissex);
            } else {
                if (pedido.verdeOliva) {
                    addRows("Verde - Infantil", pedido.verdeOliva.infantil);
                    addRows("Verde - Babylook", pedido.verdeOliva.babylook);
                    addRows("Verde - Unissex", pedido.verdeOliva.unissex);
                }
                if (pedido.terracota) {
                    addRows("Terra - Infantil", pedido.terracota.infantil);
                    addRows("Terra - Babylook", pedido.terracota.babylook);
                    addRows("Terra - Unissex", pedido.terracota.unissex);
                }
            }

            const valorTotal = totalQtd * PRECO_CAMISETA;

            doc.autoTable({
                head: [['Categoria', 'Tamanho', 'Qtd']],
                body: bodyData,
                startY: 65,
                theme: 'striped',
                headStyles: { fillColor: [212, 175, 55] },
                styles: { fontSize: 10 },
            });

            // Resumo Financeiro e Total
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text(`Total de Peças: ${totalQtd}`, 14, finalY);
            doc.text(`Valor Unitário: ${formatarMoeda(PRECO_CAMISETA)}`, 14, finalY + 6);
            doc.text(`Valor Total: ${formatarMoeda(valorTotal)}`, 14, finalY + 12);

            // Abre o PDF
            doc.save(`Pedido_${pedido.numPedido}.pdf`);

        } catch (error) {
            console.error("Erro ao gerar PDF do Pedido Individual:", error);
            // Exibe o modal de erro (Regra 5)
            document.getElementById('modalErroPDF').querySelector('h2').textContent = "Erro na Geração";
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Não foi possível gerar o PDF. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    window.verificarPedidoPorEmail = async function(email) {
        try { const q = query(pedidosCollection, where("email", "==", email.toLowerCase().trim())); const snapshot = await getDocs(q); if (!snapshot.empty) return { docId: snapshot.docs[0].id, ...snapshot.docs[0].data() }; return null; } catch (error) { return null; }
    };

    window.recuperarIdsPorEmail = async function(e) {
        e.preventDefault(); const email = document.getElementById('emailRecuperacao').value.toLowerCase().trim(); window.mostrarCarregamento(true);
        try { const q = query(pedidosCollection, where("email", "==", email)); const snapshot = await getDocs(q); const container = document.getElementById('listaIdsRecuperados');
            if (snapshot.empty) { container.innerHTML = `<p style="color:var(--danger-color)">NENHUM PEDIDO ENCONTRADO</p>`; } else { let html = ''; snapshot.forEach(doc => { const d = doc.data(); html += `<div style="background:rgba(255,255,255,0.05); padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:4px;"><span>#${d.numPedido}</span><button onclick="window.copiarNumeroPedido('${d.numPedido}')" style="cursor:pointer; background:none; border:none; color:var(--gold-solid); font-size:0.8rem; font-weight:600;">COPIAR</button></div>`; }); container.innerHTML = html; }
        } catch (error) { console.error(error); } finally { window.mostrarCarregamento(false); }
    };

    window.verificarPedidoPorSetor = async function(setor) {
        try { const q = query(pedidosCollection, where("setor", "==", normalizeString(setor))); const snapshot = await getDocs(q); if (!snapshot.empty) return { docId: snapshot.docs[0].id, ...snapshot.docs[0].data() }; return null; } catch (error) { return null; }
    };

    window.verificarPedidoPorNumero = async function(numPedido) {
        try { const docRef = doc(db, "pedidos", numPedido.trim()); const docSnap = await getDoc(docRef); if (docSnap.exists()) { return { docId: docSnap.id, numPedido: docSnap.data().numPedido || docSnap.id, ...docSnap.data() }; } const q = query(pedidosCollection, where("numPedido", "==", numPedido.trim())); const qs = await getDocs(q); if (!qs.empty) return { docId: qs.docs[0].id, ...qs.docs[0].data() }; return null; } catch (error) { return null; }
    };

    window.updateSetorCidadeInput = function(val = '') {
        const container = document.getElementById('setorCidadeContainer'); const radioCapital = document.getElementById('radioCapital');
        if (!container || !radioCapital) return;
        const isCapital = radioCapital.checked;
        if (isCapital) { const setores = ['A', 'B', 'C1', 'C2', 'D', 'E', 'F', 'G', 'H', 'I', 'M', 'N']; container.innerHTML = `<select id="setor" name="setor" required><option value="" disabled selected>SELECIONE</option>${setores.map(s => `<option value="SETOR ${s}">SETOR ${s}</option>`).join('')}</select>`; const sel = document.getElementById('setor'); if (val && Array.from(sel.options).some(o => o.value === normalizeString(val))) sel.value = normalizeString(val); } else { container.innerHTML = `<input type="text" id="setor" name="setor" placeholder="CIDADE" required value="${val}">`; }
    };

    window.setupNovoPedido = function() {
        currentPedidoParaEdicao = null;
        document.getElementById('pedidoDocId').value = '';
        document.getElementById('formPedido').reset();
        document.getElementById('submitButtonText').textContent = 'Confirmar e Enviar';
        const radioCapital = document.querySelector(`input[name="local"][value="Capital"]`);
        if (radioCapital) radioCapital.checked = true;
        window.updateSetorCidadeInput();
    };

    window.setupEdicaoPedido = function() {
        if (!SISTEMA_ABERTO) { document.getElementById('modalPedidosFechados').classList.add('active'); return; }
        const pedido = currentPedidoParaEdicao; if (!pedido) return;
        
        document.getElementById('pedidoDocId').value = pedido.docId;
        document.getElementById('nome').value = pedido.nome;
        const radioLocal = document.querySelector(`input[name="local"][value="${pedido.local}"]`); if (radioLocal) radioLocal.checked = true;
        window.updateSetorCidadeInput(pedido.setor);
        document.getElementById('email').value = pedido.email;
        document.getElementById('contato').value = pedido.contato || '';
        
        // PREECHER TAMANHOS (Suporta Legado e Novo)
        const preencher = (obj, prefix) => {
            for (const [t, q] of Object.entries(obj || {})) {
                const input = document.getElementById(`${prefix}_${t}`);
                if (input) input.value = q;
            }
        };

        // Se tem estrutura nova, usa ela
        if (pedido.verdeOliva || pedido.terracota) {
            if (pedido.verdeOliva) {
                preencher(pedido.verdeOliva.infantil, 'verde_infantil');
                preencher(pedido.verdeOliva.babylook, 'verde_babylook');
                preencher(pedido.verdeOliva.unissex, 'verde_unissex');
            }
            if (pedido.terracota) {
                preencher(pedido.terracota.infantil, 'terracota_infantil');
                preencher(pedido.terracota.babylook, 'terracota_babylook');
                preencher(pedido.terracota.unissex, 'terracota_unissex');
            }
        } else {
            // Não usar alert. Usar console.warn ou modal se for crítico.
            console.warn("Atenção: Este pedido é antigo (sem cor definida). Por favor, redistribua as quantidades nas cores Verde e Terracota.");
        }
        
        document.getElementById('submitButtonText').textContent = 'Atualizar Pedido';
        window.redirecionarComAnimacao('pedido');
    };

    // NOVA FUNÇÃO PARA EXIBIR MODAL COM DETALHES COMPLETOS
    window.exibirModalDetalhesPedido = function(pedido) {
        // REGRA: Download automático removido.
        // O PDF só será gerado ao clicar em "BAIXAR PEDIDO".

        currentPedidoParaEdicao = pedido; // Necessário para setupEdicaoPedido
        pedidoDoModal = pedido; // Armazena o pedido completo na variável global
        const container = document.getElementById('conteudoDetalhesPedido');
        const total = calcularTotalPedido(pedido);
        
        let html = `
            <div style="margin-bottom:1.5rem;">
                <div style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:var(--radius-md); border:1px solid var(--border-subtle);">
                    <p style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase;">ID do Pedido</p>
                    <p style="font-size:1.5rem; color:var(--gold-solid); font-weight:700; word-break:break-all;">#${pedido.numPedido}</p>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.5rem; font-size:0.9rem;">
                <div><p style="color:var(--text-muted);">Nome</p><p style="color:#fff;">${pedido.nome}</p></div>
                <div><p style="color:var(--text-muted);">Contato</p><p style="color:#fff;">${pedido.contato || '-'}</p></div>
                <div><p style="color:var(--text-muted);">Local</p><p style="color:#fff;">${pedido.local}</p></div>
                <div><p style="color:var(--text-muted);">Setor/Cidade</p><p style="color:#fff;">${pedido.setor}</p></div>
                <div style="grid-column:1/-1;"><p style="color:var(--text-muted);">E-mail</p><p style="color:#fff;">${pedido.email}</p></div>
            </div>
        `;

        const generateTable = (title, color, dataObj) => {
            let rows = '';
            const add = (cat, items) => {
                Object.entries(items || {}).forEach(([tam, qtd]) => {
                    if(qtd > 0) rows += `<tr><td style="padding:8px; color:#ddd;">${cat}</td><td style="padding:8px; color:#fff; font-weight:bold;">${tam}</td><td style="padding:8px; text-align:right; color:#ddd;">${qtd}</td></tr>`;
                });
            };
            
            if (dataObj) {
                add('Infantil', dataObj.infantil);
                add('Babylook', dataObj.babylook);
                add('Unissex', dataObj.unissex);
            } else {
                 // Legacy support if passed directly
                 add('Infantil', pedido.infantil);
                 add('Babylook', pedido.babylook);
                 add('Unissex', pedido.unissex);
            }

            if(rows) {
                return `
                    <div style="margin-bottom:1rem;">
                        <p style="color:${color}; font-weight:bold; margin-bottom:0.5rem; font-size:0.9rem; text-transform:uppercase;">${title}</p>
                        <table style="width:100%; font-size:0.85rem; border-collapse:collapse; background:rgba(0,0,0,0.2); border-radius:4px;">
                            <tr style="background:rgba(255,255,255,0.05);"><th style="text-align:left; padding:8px; color:var(--text-muted);">Tipo</th><th style="text-align:left; padding:8px; color:var(--text-muted);">Tam</th><th style="text-align:right; padding:8px; color:var(--text-muted);">Qtd</th></tr>
                            ${rows}
                        </table>
                    </div>
                `;
            }
            return '';
        };

        if(pedido.verdeOliva || pedido.terracota) {
            if(pedido.verdeOliva) html += generateTable('Verde Oliva', 'var(--shirt-verde)', pedido.verdeOliva);
            if(pedido.terracota) html += generateTable('Terracota', 'var(--shirt-terracota)', pedido.terracota);
        } else {
            html += generateTable('Itens (Legado)', '#fff', null);
        }

        html += `
            <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-subtle); text-align:right;">
                <p style="font-size:0.9rem; color:var(--text-muted);">Total de Peças: <span style="color:#fff; font-weight:bold;">${total}</span></p>
                <p style="font-size:1.2rem; color:var(--gold-solid); font-weight:700;">${formatarMoeda(total * PRECO_CAMISETA)}</p>
            </div>
        `;

        container.innerHTML = html;
        
        // Configura o botão de edição
        const btnEdit = document.getElementById('btnEditarNoModal');
        btnEdit.onclick = function() {
            document.getElementById('modalDetalhesPedido').classList.remove('active');
            window.setupEdicaoPedido();
        };

        // CORREÇÃO: Configura o novo botão de baixar chamando a nova função auxiliar
        const btnBaixar = document.getElementById('btnBaixarNoModal');
        btnBaixar.setAttribute('onclick', `window.baixarPedidoDoModal()`);


        document.getElementById('modalDetalhesPedido').classList.add('active');
    };

    window.displayVisualizacaoPedido = function(pedido) {
        currentPedidoParaEdicao = pedido;
        const total = calcularTotalPedido(pedido);
        const html = `<div class="pedido-item">
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border-subtle); padding-bottom:1rem; margin-bottom:1rem; align-items:center;">
                            <span style="color:var(--gold-solid); font-size:1.2rem; font-weight:700;">#${pedido.numPedido}</span>
                        </div>
                        <div style="display:grid; gap:0.5rem; color:var(--text-muted); font-size:0.9rem;">
                            <p>NOME: <span style="color:#fff">${pedido.nome}</span></p>
                            <p>LOCAL: <span style="color:#fff">${pedido.local} - ${pedido.setor}</span></p>
                            <p>TOTAL PEÇAS: <span style="color:#fff">${total}</span></p>
                            <p>VALOR TOTAL: <span style="color:var(--gold-solid); font-weight:700;">${formatarMoeda(total * PRECO_CAMISETA)}</span></p>
                        </div>
                        <button id="btnDetalharOverlay" class="btn-primary" style="width:100%; margin-top:2rem; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid); box-shadow:none;">DETALHAR PEDIDO</button>
                      </div>`;
        document.getElementById('resultadoConsulta').innerHTML = html;
        
        // Listener para abrir o modal de detalhes (e automaticamente gerar PDF)
        const btnDetail = document.getElementById('btnDetalharOverlay');
        if (btnDetail) {
            // Remove o listener anterior e adiciona o novo que chama a função de modal
            btnDetail.removeEventListener('click', () => window.exibirModalDetalhesPedido(pedido));
            btnDetail.addEventListener('click', () => window.exibirModalDetalhesPedido(pedido));
        }
    };

    window.handleFormSubmission = async function(e) {
        e.preventDefault();
        if (!SISTEMA_ABERTO) { document.getElementById('modalPedidosFechados').classList.add('active'); return; }

        const docId = document.getElementById('pedidoDocId').value;
        const isEditing = !!docId;
        const formData = new FormData(document.getElementById('formPedido'));
        const email = formData.get('email').toLowerCase().trim();
        const setor = normalizeString(formData.get('setor'));
        
        if (!isValidEmail(email)) { window.exibirMensagem('mensagemPedido', 'erro', 'E-MAIL INVÁLIDO'); return; }

        // ============================================
        // 1 — VALIDAÇÃO DE CELULAR OBRIGATÓRIO (NOVO)
        // ============================================
        const contatoInput = formData.get('contato');
        const contatoNumeros = contatoInput ? contatoInput.replace(/\D/g, '') : '';
        if (!contatoNumeros || contatoNumeros.length < 11) {
            window.exibirMensagem('mensagemPedido', 'erro', 'O CELULAR É OBRIGATÓRIO (COM DDD)');
            document.getElementById('contato').focus();
            return;
        }

        if (!isEditing) {
            const dup = await window.verificarPedidoPorEmail(email);
            if (dup) { window.exibirMensagem('mensagemPedido', 'erro', 'E-MAIL JÁ TEM PEDIDO'); return; }
        }
        
        const setorOriginal = currentPedidoParaEdicao ? normalizeString(currentPedidoParaEdicao.setor) : null;
        if (!isEditing || setor !== setorOriginal) {
            const dupSetor = await window.verificarPedidoPorSetor(setor);
            if (dupSetor && (isEditing ? dupSetor.docId !== docId : true)) { window.exibirMensagem('mensagemPedido', 'erro', 'SETOR JÁ TEM PEDIDO'); return; }
        }
        
        const totalInputs = Array.from(document.getElementById('formPedido').querySelectorAll('input[type="number"]')).reduce((sum, i) => sum + (parseInt(i.value) || 0), 0);
        if (totalInputs === 0) { window.exibirMensagem('mensagemPedido', 'erro', 'ADICIONE PELO MENOS 1 CAMISETA'); return; }
        
        window.mostrarCarregamento(true);
        try {
            const data = {
                data: new Date().toISOString(),
                nome: formData.get('nome'),
                local: formData.get('local'),
                setor: setor,
                email: email,
                contato: formData.get('contato'),
                
                verdeOliva: {
                    infantil: getQuantidadesFromForm(formData, 'verde_infantil'),
                    babylook: getQuantidadesFromForm(formData, 'verde_babylook'),
                    unissex: getQuantidadesFromForm(formData, 'verde_unissex'),
                },
                
                terracota: {
                    infantil: getQuantidadesFromForm(formData, 'terracota_infantil'),
                    babylook: getQuantidadesFromForm(formData, 'terracota_babylook'),
                    unissex: getQuantidadesFromForm(formData, 'terracota_unissex'),
                },
                
                status: 'Pendente'
            };
            
            data.infantil = {}; data.babylook = {}; data.unissex = {};
            
            let finalNum = '';
            if (isEditing) { await updateDoc(doc(db, "pedidos", docId), data); finalNum = currentPedidoParaEdicao.numPedido; }
            else { const ref = doc(pedidosCollection); data.numPedido = ref.id; await setDoc(ref, data); finalNum = ref.id; }
            
            const pedidoConfirmado = { numPedido: finalNum, ...data };
            window.exibirConfirmacaoPedido(pedidoConfirmado);
            document.getElementById('formPedido').reset();
            
            // CORREÇÃO: Limpa o cache para que o Dashboard seja forçado a recarregar no próximo acesso
            window.pedidosCache = [];
            
        } catch (err) { window.exibirMensagem('mensagemPedido', 'erro', 'ERRO AO SALVAR'); console.error(err); } finally { window.mostrarCarregamento(false); }
    };

    window.handleAdminLogin = async function(e) {
        e.preventDefault(); 
        const email = document.getElementById('emailAdmin').value.trim(); 
        const senha = document.getElementById('senhaAdmin').value;
        
        window.mostrarCarregamento(true, "AUTENTICANDO...");
        console.log("LOG: Tentativa de Login Admin iniciada para:", email); // LOG DE DEBUG

        try { 
            await signInWithEmailAndPassword(auth, email, senha); 
            
            console.log("LOG: Login Firebase BEM-SUCEDIDO."); // LOG DE DEBUG
            
            document.getElementById('loginAdmin').style.display = 'none'; 
            document.getElementById('painelAdmin').style.display = 'block'; 
            
            console.log("LOG: Painel Admin exibido após login manual."); // LOG DE DEBUG

            window.carregarDashboard();
            window.adminAcessouPainel = true;

        } catch (error) { 
            console.error("LOG: Erro no login Firebase:", error.code, error.message); // LOG DE DEBUG
            document.getElementById('modalErroLogin').classList.add('active'); 
        } finally { 
            window.mostrarCarregamento(false); 
        }
    };

    // Altera a função para sempre buscar novos dados, se o cache estiver vazio
    window.carregarTodosPedidos = async function() { 
        if (window.pedidosCache && window.pedidosCache.length > 0) {
            return window.pedidosCache;
        }
        const s = await getDocs(pedidosCollection); 
        window.pedidosCache = s.docs.map(d => ({ docId: d.id, ...d.data() }));
        return window.pedidosCache;
    };

    window.carregarDashboard = async function() {
        window.mostrarCarregamento(true);
        try {
            // Garante que os dados mais recentes sejam carregados, ignorando o cache se vazio
            const p = await window.carregarTodosPedidos();
            
            let tP = p.length, tC = 0, inf = 0, baby = 0, uni = 0;
            let totalRecebidoReal = 0;
            const sumObj = (obj) => Object.values(obj || {}).reduce((a, b) => a + b, 0);

            p.forEach(x => {
                // Legado
                let i = sumObj(x.infantil);
                let b = sumObj(x.babylook);
                let u = sumObj(x.unissex);
                
                // Novo
                if(x.verdeOliva) {
                    i += sumObj(x.verdeOliva.infantil);
                    b += sumObj(x.verdeOliva.babylook);
                    u += sumObj(x.verdeOliva.unissex);
                }
                if(x.terracota) {
                    i += sumObj(x.terracota.infantil);
                    b += sumObj(x.terracota.babylook);
                    u += sumObj(x.terracota.unissex);
                }
                
                tC += i + b + u; inf += i; baby += b; uni += u;

                // SOMA TODAS AS LIQUIDAÇÕES
                if (x.liquidacoes && Array.isArray(x.liquidacoes)) {
                    totalRecebidoReal += x.liquidacoes.reduce((acc, curr) => acc + (curr.valor || 0), 0);
                }
            });
            
            window.atualizarElemento('totalPedidos', tP); window.atualizarElemento('totalCamisetas', tC);
            const totalVal = tC * PRECO_CAMISETA; window.atualizarElemento('totalArrecadado', formatarMoeda(totalVal));
            window.atualizarElemento('totalRecebidoReal', formatarMoeda(totalRecebidoReal));
            window.atualizarElemento('totalInfantis', inf); window.atualizarElemento('totalBabylook', baby); window.atualizarElemento('totalUnissex', uni);
        } catch (e) { console.error(e); } finally { window.mostrarCarregamento(false); }
    };

    window.togglePedidoDetails = function(docId) {
        const detailsDiv = document.getElementById(`details-${docId}`); const icon = document.getElementById(`icon-${docId}`);
        if (detailsDiv.style.display === 'none') { detailsDiv.style.display = 'block'; icon.classList.remove('fa-chevron-right'); icon.classList.add('fa-chevron-down'); }
        else { detailsDiv.style.display = 'none'; icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-right'); }
    };

    // FUNÇÃO QUE ABRE O MODAL DE CONFIRMAÇÃO DE EXCLUSÃO
    window.abrirModalExcluirPedido = function(docId) {
        pedidoParaExcluir = docId;
        document.getElementById('excluirPedidoDocId').value = docId;
        document.getElementById('modalExcluirPedido').classList.add('active');
    };
    
    // FUNÇÃO PARA EXCLUIR O PEDIDO NO FIREBASE
    window.excluirPedido = async function() {
        const docId = document.getElementById('excluirPedidoDocId').value;
        if (!docId) return;

        document.getElementById('modalExcluirPedido').classList.remove('active');
        window.mostrarCarregamento(true, "EXCLUINDO PEDIDO...");

        try {
            await deleteDoc(doc(db, "pedidos", docId));
            
            // Limpa o cache para forçar a recarga
            window.pedidosCache = []; 
            
            // Atualiza a lista de pedidos e o dashboard
            await window.carregarPedidos();
            await window.carregarDashboard();
            
            window.exibirMensagem('mensagemLogin', 'sucesso', `Pedido #${docId} excluído com sucesso.`);
            
        } catch (error) {
            console.error("Erro ao excluir documento: ", error);
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao excluir o pedido. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
        } finally {
            window.mostrarCarregamento(false);
            pedidoParaExcluir = null;
        }
    };


    // FILTRO E BUSCA ATUALIZADOS
// FILTRO E BUSCA ATUALIZADOS (COM SEGURANÇA APLICADA)
// FUNÇÃO DE CARREGAMENTO PAGINADO (10 POR VEZ)
    window.carregarPedidos = async function(modoExpandir = false) {
        const btnExpandirExistente = document.getElementById('btnCarregarMais');
        if (modoExpandir) {
            window.mostrarCarregamento(true, 'CARREGANDO MAIS...');
        } else {
            window.mostrarCarregamento(true, 'BUSCANDO...');
            // Se não for expansão, limpa tudo para começar do zero
            document.getElementById('listaPedidos').innerHTML = '';
            ultimoDocumentoCarregado = null;
            window.pedidosCache = [];
            if(btnExpandirExistente) btnExpandirExistente.remove();
        }

        const lista = document.getElementById('listaPedidos');
        
        // Filtros
        const termoBusca = document.getElementById('buscaInput').value.toLowerCase().trim();
        const filtroLocal = document.querySelector('input[name="filtroLocal"]:checked').value;

        try {
            let q;
            const qtdPorPagina = 10;

            // ESTRATÉGIA:
            // Se tiver busca digitada, infelizmente precisamos buscar com flexibilidade (Query Simples + Filtro JS em lotes maiores seria o ideal, mas aqui faremos busca direta para simplificar).
            // Se NÃO tiver busca (uso comum), usamos a paginação eficiente do banco.

            if (termoBusca) {
                // MODO BUSCA: Tenta buscar pelo termo (Limitado a 50 para não travar)
                // Nota: Busca textual exata em NoSQL é limitada. Focaremos em performance.
                // Se houver busca, ignoramos a paginação complexa e trazemos os matches (limite de segurança).
                q = query(pedidosCollection, orderBy('data', 'desc'), limit(50));
            } else {
                // MODO LISTAGEM: Paginação eficiente 10 em 10
                let constraints = [orderBy('data', 'desc')];
                
                if (filtroLocal !== 'todos') {
                    constraints.push(where('local', '==', filtroLocal));
                }

                if (modoExpandir && ultimoDocumentoCarregado) {
                    constraints.push(startAfter(ultimoDocumentoCarregado));
                }

                constraints.push(limit(qtdPorPagina));
                q = query(pedidosCollection, ...constraints);
            }

            const snapshot = await getDocs(q);
            
            // Atualiza o cursor para a próxima página
            if (!snapshot.empty) {
                ultimoDocumentoCarregado = snapshot.docs[snapshot.docs.length - 1];
            }

            const novosPedidos = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));
            
            // Se for busca, aplicamos filtro extra no client-side para garantir (já que o termo pode estar no nome, email, etc)
            let pedidosProcessados = novosPedidos;
            if (termoBusca) {
                pedidosProcessados = novosPedidos.filter(x => {
                    const searchable = [x.nome, x.numPedido, x.setor, x.local, x.email, x.contato].join(' ').toLowerCase();
                    return searchable.includes(termoBusca);
                });
            }

            // Renderização
            if (pedidosProcessados.length === 0 && !modoExpandir) {
                lista.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding:2rem;">Nenhum pedido encontrado.</p>`;
            } else {
                pedidosProcessados.forEach(x => {
                    const t = calcularTotalPedido(x);
                    
                    let tabelaHTML = `<table class="tabela-detalhe-pedido"><thead><tr><th>Categoria</th><th>Tamanho</th><th>Qtd</th></tr></thead><tbody>`;
                    const addRows = (cat, obj) => { let rows = ''; Object.entries(obj || {}).forEach(([tam, qtd]) => { if(qtd > 0) rows += `<tr><td>${cat}</td><td>${tam}</td><td>${qtd}</td></tr>`; }); return rows; };
                    
                    if(!x.verdeOliva && !x.terracota) {
                        tabelaHTML += addRows('Infantil', x.infantil); tabelaHTML += addRows('Babylook', x.babylook); tabelaHTML += addRows('Unissex', x.unissex);
                    } else {
                        if(x.verdeOliva) {
                            tabelaHTML += addRows('Verde - Inf', x.verdeOliva.infantil);
                            tabelaHTML += addRows('Verde - Baby', x.verdeOliva.babylook);
                            tabelaHTML += addRows('Verde - Uni', x.verdeOliva.unissex);
                        }
                        if(x.terracota) {
                            tabelaHTML += addRows('Terra - Inf', x.terracota.infantil);
                            tabelaHTML += addRows('Terra - Baby', x.terracota.babylook);
                            tabelaHTML += addRows('Terra - Uni', x.terracota.unissex);
                        }
                    }
                    tabelaHTML += `</tbody></table>`;

                    // Usamos escapeHTML para segurança (já implementado)
                    const htmlItem = `
                        <div class="pedido-item pedido-card-expandable" style="margin-bottom:1rem; animation: slideDown 0.3s ease-out;">
                            <div onclick="window.togglePedidoDetails('${x.docId}')" style="cursor:pointer;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                    <span style="color:var(--gold-solid); font-weight:700; font-size:1.1rem;">#${escapeHTML(x.numPedido)}</span>
                                    <i id="icon-${x.docId}" class="fas fa-chevron-right" style="font-size:0.8rem; color:var(--text-muted); transition:0.3s;"></i>
                                </div>
                                <div style="margin-bottom:5px; font-size:1rem; font-weight:600; color:#fff;">
                                    ${t} PÇS - <span style="color:var(--gold-solid);">${formatarMoeda(t * PRECO_CAMISETA)}</span>
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:2px;">
                                    <strong style="color:#fff">${escapeHTML(x.nome)}</strong> | ${escapeHTML(x.local)} - ${escapeHTML(x.setor)}
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-muted);">
                                    <i class="fas fa-phone-alt" style="font-size:0.7rem; margin-right:4px;"></i>${escapeHTML(x.contato || 'S/ Contato')}
                                </div>
                            </div>
                            <div id="details-${x.docId}" class="pedido-details-content" style="display:none;">
                                <h5 style="color:var(--text-muted); margin-bottom:10px; text-transform:uppercase; font-size:0.75rem; letter-spacing:1px;">Detalhamento do Pedido</h5>
                                ${tabelaHTML}
                                <div style="margin-top:15px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                                     <button onclick="window.abrirModalExcluirPedido('${x.docId}')" class="btn-primary" style="background:var(--danger-color); color:#fff; padding: 8px 16px; font-size: 0.75rem; display:inline-flex; align-items:center; gap:8px;">
                                        <i class="fas fa-trash-alt"></i> EXCLUIR
                                    </button>
                                    <button onclick="window.gerarPdfPedidoIndividual({
                                        numPedido: '${escapeHTML(x.numPedido)}',
                                        nome: '${escapeHTML(x.nome)}',
                                        local: '${escapeHTML(x.local)}',
                                        setor: '${escapeHTML(x.setor)}',
                                        email: '${escapeHTML(x.email)}',
                                        contato: '${escapeHTML(x.contato || '')}',
                                        data: '${x.data}',
                                        verdeOliva: ${JSON.stringify(x.verdeOliva || null).replace(/"/g, "&quot;")},
                                        terracota: ${JSON.stringify(x.terracota || null).replace(/"/g, "&quot;")},
                                        infantil: ${JSON.stringify(x.infantil || null).replace(/"/g, "&quot;")},
                                        babylook: ${JSON.stringify(x.babylook || null).replace(/"/g, "&quot;")},
                                        unissex: ${JSON.stringify(x.unissex || null).replace(/"/g, "&quot;")}
                                    })" class="btn-primary" style="padding: 8px 16px; font-size: 0.75rem; display:inline-flex; align-items:center; gap:8px; background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid);">
                                        <i class="fas fa-file-pdf"></i> Gerar PDF
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    lista.insertAdjacentHTML('beforeend', htmlItem);
                });
            }

            // Gerenciamento do Botão "Expandir"
            if (snapshot.docs.length === qtdPorPagina && !termoBusca) {
                // Se retornou uma página cheia, provavelmente tem mais. Adiciona o botão.
                if(btnExpandirExistente) btnExpandirExistente.remove(); // Remove o antigo para mover pro final
                
                const btnHtml = `
                    <div id="containerBtnExpandir" style="text-align:center; margin-top:2rem; margin-bottom:4rem;">
                        <button id="btnCarregarMais" onclick="window.carregarPedidos(true)" class="btn-primary" style="background:transparent; border:1px solid var(--gold-solid); color:var(--gold-solid); width:100%;">
                            <i class="fas fa-chevron-down"></i> EXPANDIR LISTA (+10)
                        </button>
                    </div>`;
                lista.insertAdjacentHTML('beforeend', btnHtml);
            } else {
                // Se não tem mais ou é busca, remove o botão se existir
                if(btnExpandirExistente) btnExpandirExistente.remove();
                if(!termoBusca && pedidosProcessados.length > 0) {
                    lista.insertAdjacentHTML('beforeend', `<div style="text-align:center; color:var(--text-muted); margin-top:2rem; font-size:0.8rem;">--- Fim da Lista ---</div>`);
                }
            }

        } catch (error) {
            console.error(error);
            lista.innerHTML = `<p style="color:var(--danger-color); text-align:center;">Erro ao carregar lista. Tente novamente.</p>`;
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    window.carregarDetalhesTamanho = async function() {
        window.mostrarCarregamento(true);
        // Garante que os dados mais recentes sejam carregados
        const p = await window.carregarTodosPedidos();
        const sizesA = ['PP', 'P', 'M', 'G', 'GG', 'XGG'];
        const sizesI = ['1', '2', '4', '6', '8', '10', '12', '14'];
        
        // Estrutura Detalhada por COR e TIPO
        let adultoVerde = {}, adultoTerra = {};
        let babyVerde = {}, babyTerra = {};
        let infantilVerde = {}, infantilTerra = {};

        sizesA.forEach(s => {
            adultoVerde[s] = 0; adultoTerra[s] = 0;
            babyVerde[s] = 0; babyTerra[s] = 0;
        });
        sizesI.forEach(s => {
            infantilVerde[s] = 0; infantilTerra[s] = 0;
        });
        
        p.forEach(x => {
            const add = (source, target) => Object.entries(source || {}).forEach(([k, v]) => target[k] = (target[k]||0) + v);

            if (x.verdeOliva) {
                add(x.verdeOliva.unissex, adultoVerde);
                add(x.verdeOliva.babylook, babyVerde);
                add(x.verdeOliva.infantil, infantilVerde);
            }
            if (x.terracota) {
                add(x.terracota.unissex, adultoTerra);
                add(x.terracota.babylook, babyTerra);
                add(x.terracota.infantil, infantilTerra);
            }
            // Legado -> assume como "Verde" (ou ignora, conforme regra) - vou somar no Verde para nao perder
            if (!x.verdeOliva && !x.terracota) {
                add(x.unissex, adultoVerde);
                add(x.babylook, babyVerde);
                add(x.infantil, infantilVerde);
            }
        });
        
        const buildRow = (label, data, keys) => `<tr><td style="padding:12px; border-bottom:1px solid var(--border-subtle); text-transform:uppercase; font-weight:600;">${label}</td>${keys.map(s => `<td style="padding:12px; border-bottom:1px solid var(--border-subtle); text-align:center; color:var(--text-muted);">${data[s] || 0}</td>`).join('')}</tr>`;
        
        document.getElementById('adultoVerdeBody').innerHTML = buildRow('Unissex', adultoVerde, sizesA);
        document.getElementById('adultoTerraBody').innerHTML = buildRow('Unissex', adultoTerra, sizesA);
        document.getElementById('babyVerdeBody').innerHTML = buildRow('Babylook', babyVerde, sizesA);
        document.getElementById('babyTerraBody').innerHTML = buildRow('Babylook', babyTerra, sizesA);
        document.getElementById('infantilVerdeBody').innerHTML = buildRow('Infantil', infantilVerde, sizesI);
        document.getElementById('infantilTerraBody').innerHTML = buildRow('Infantil', infantilTerra, sizesI);
        
        window.mostrarCarregamento(false);
    };

    window.togglePagamento = function(id, btn) {
        const el = document.getElementById(`status-${id}`);
        if (el) { el.innerText = "PAGO"; el.style.color = "var(--success-color)"; }
        btn.disabled = true; btn.style.opacity = "0.5";
    };

    // RENOMEADO: carregarDetalhesFinanceiros -> carregarDetalhesEvento
    window.carregarDetalhesEvento = async function() {
        window.mostrarCarregamento(true);
        // Garante que os dados mais recentes sejam carregados
        const p = await window.carregarTodosPedidos();
        const res = {};
        
        p.forEach(x => {
            const k = `${x.local} / ${x.setor}`;
            const t = calcularTotalPedido(x);
            
            if (!res[k]) res[k] = { qtd: 0, val: 0 };
            res[k].qtd += t; res[k].val += t * PRECO_CAMISETA;
        });
        
        let h = '';
        // RENOMEADO ID DO CONTAINER
        const resumoContainer = document.getElementById('resumoEventoLocais');
        
        Object.keys(res).sort().forEach((k, i) => {
            h += `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(255,255,255,0.02); margin-bottom:8px; border-radius:4px; border:1px solid var(--border-subtle);"><div><strong style="color:#fff; font-size:0.9rem;">${k}</strong><br><span style="font-size:0.8rem; color:var(--text-muted);">${res[k].qtd} PÇS - <span style="color:var(--gold-solid);">${formatarMoeda(res[k].val)}</span></span></div><div style="text-align:right;"><span id="status-fin-${i}" style="font-size:0.7rem; color:var(--warning-color); display:block; margin-bottom:5px; font-weight:600;">PENDENTE</span><button onclick="window.togglePagamento('fin-${i}', this)" style="background:var(--success-color); border:none; color:#fff; padding:4px 10px; font-size:0.7rem; cursor:pointer; border-radius:50px; font-weight:600;">PAGO</button></div></div>`;
        });
        resumoContainer.innerHTML = h || '<p style="text-align:center; color:var(--text-muted);">SEM DADOS</p>';
        window.mostrarCarregamento(false);
    };

    // FUNÇÃO PONTE (ALIAS) PARA MANTER COMPATIBILIDADE (Regra 3)
    window.carregarDetalhesFinanceiros = window.carregarDetalhesEvento;
    window.atualizarFinanceiro = window.carregarDetalhesEvento;
    
    // FUNÇÃO PARA RECARREGAR O EVENTO COM FEEDBACK
    window.recarregarDetalhesEventoComFeedback = async function() {
        await window.carregarDetalhesEvento();
        document.getElementById('modalFeedbackSucesso').classList.add('active');
    };

    // =========================================================================
    // IMPLEMENTAÇÃO ENCERRAR EVENTO (2/2)
    // =========================================================================
    window.encerrarEvento = async function() {
        document.getElementById('modalEncerrarEvento').classList.remove('active');
        window.mostrarCarregamento(true, "ENCERRANDO EVENTO E REMOVENDO PEDIDOS...");

        try {
            // 1. Marcar sistema como fechado (se não estiver)
            await setDoc(configSistemaRef, { aberto: false }, { merge: true });

            // 2. Apagar todos os documentos da coleção 'pedidos'
            const snapshot = await getDocs(pedidosCollection);
            const batch = db.batch();

            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });

            await batch.commit();

            // 3. Limpar cache e recarregar painel
            window.pedidosCache = [];
            window.mostrarAdminSecao('dashboard'); // Recarrega o dashboard
            
            window.exibirMensagem('mensagemLogin', 'sucesso', `Evento encerrado e ${snapshot.size} pedidos removidos com sucesso.`);
            
        } catch (error) {
            console.error("Erro ao encerrar evento: ", error);
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro fatal ao encerrar o evento. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
        } finally {
            window.mostrarCarregamento(false);
        }
    };


    // =========================================================================
    // MÓDULO PAGAMENTOS (ANTIGO PENDÊNCIAS FINANCEIRAS)
    // =========================================================================
    
    // FUNÇÃO DE MÁSCARA MONETÁRIA (SHIFT LEFT)
    window.aplicarMascaraMonetaria = function(inputElement) {
        let v = inputElement.value.replace(/\D/g, ""); // Remove tudo que não é dígito

        if (v.length === 0) {
            inputElement.value = "";
            return;
        }

        // Garante que pelo menos 3 dígitos existam para formato 0,00
        while (v.length < 3) {
            v = "0" + v;
        }

        // Separa os centavos
        let integerPart = v.substring(0, v.length - 2);
        let decimalPart = v.substring(v.length - 2);

        // Remove zeros à esquerda desnecessários na parte inteira (ex: 00123 -> 123)
        integerPart = parseInt(integerPart).toString();

        // Adiciona separadores de milhares
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

        // Formato final R$ 1.234,56
        inputElement.value = "R$ " + integerPart + "," + decimalPart;
    };

    // RENOMEADA: carregarPendencias -> carregarPagamentos
    window.carregarPagamentos = async function() {
        window.mostrarCarregamento(true);
        // RENOMEADO ID
        const lista = document.getElementById('listaPagamentos');
        lista.innerHTML = '';
        
        // Obtém valores dos filtros de Pagamento (Regra 1)
        const termoBusca = document.getElementById('buscaPagamentosInput').value.toLowerCase().trim();
        const filtroStatus = document.querySelector('input[name="filtroStatusPagamento"]:checked').value;
        const p = await window.carregarTodosPedidos();
        window.pedidosCache = p; // Atualiza cache
        
        if (p.length === 0) {
            lista.innerHTML = '<p style="text-align:center; color:var(--text-muted);">Nenhum pedido encontrado.</p>';
            window.mostrarCarregamento(false);
            return;
        }

        // 1. Filtragem e Busca
        const pedidosFiltrados = p.filter(pedido => {
            const qtdTotal = calcularTotalPedido(pedido);
            const valorTotal = qtdTotal * PRECO_CAMISETA;
            const valorRecebido = (pedido.liquidacoes || []).reduce((acc, curr) => acc + (curr.valor || 0), 0);
            
            // 1.1 Filtragem por Status (Regra 1)
            let statusCorrente = 'pendente';
            const isQuitado = valorTotal > 0 && valorRecebido >= valorTotal - 0.01;
            const isParcialmentePago = valorRecebido > 0 && !isQuitado;
            
            if (isQuitado) {
                statusCorrente = 'quitado';
            } else if (isParcialmentePago) {
                statusCorrente = 'parcialmente';
            }
            
            if (filtroStatus !== 'todos') {
                if (filtroStatus === 'quitado' && statusCorrente !== 'quitado') return false;
                if (filtroStatus === 'parcialmente' && statusCorrente !== 'parcialmente') return false;
                // Para o filtro 'todos', basta passar. O status 'pendente' é incluído no 'todos'.
            }

            // 1.2 Busca por Termo (Regra 2)
            if (termoBusca) {
                const searchable = [
                    pedido.nome, 
                    pedido.numPedido, 
                    pedido.setor, 
                    pedido.local, 
                    pedido.contato,
                    pedido.email,
                ].join(' ').toLowerCase();
                
                if (!searchable.includes(termoBusca)) return false;
            }
            
            return true;
        });

        // 2. Renderização
        pedidosFiltrados.sort((a, b) => a.setor.localeCompare(b.setor));

        pedidosFiltrados.forEach(pedido => {
            const qtdTotal = calcularTotalPedido(pedido);
            const valorTotal = qtdTotal * PRECO_CAMISETA;
            
            // Calcula total já recebido
            const liquidacoes = pedido.liquidacoes || [];
            const valorRecebido = liquidacoes.reduce((acc, curr) => acc + (curr.valor || 0), 0);
            const valorRestante = valorTotal - valorRecebido;

            let statusText = '';
            
            // Regra de exibição de Status
            if (valorRecebido > 0 && valorRecebido < valorTotal - 0.01) { // tolerância float
                statusText = `<span style="color:var(--warning-color); font-weight:bold; font-size:0.8rem; cursor:pointer; text-decoration:underline; display:block; margin-top:0.5rem;" onclick="window.abrirModalLiquidacao('${pedido.docId}')">PAGO PARCIALMENTE <i class="fas fa-history"></i></span>`;
            } else if (valorRecebido >= valorTotal - 0.01 && valorTotal > 0) {
                statusText = `<span style="color:var(--success-color); font-weight:bold; font-size:0.8rem; cursor:pointer; display:block; margin-top:0.5rem;" onclick="window.abrirModalLiquidacao('${pedido.docId}')">QUITADO <i class="fas fa-check"></i></span>`;
            } else {
                 statusText = `<span style="color:var(--danger-color); font-weight:bold; font-size:0.8rem; display:block; margin-top:0.5rem;" onclick="window.abrirModalLiquidacao('${pedido.docId}')">PENDENTE</span>`;
            }

            lista.innerHTML += `
                <div class="card" style="margin-bottom:1rem; padding:1.5rem;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
                        <div>
                            <!-- CORREÇÃO: Removendo o número do pedido -->
                            <h4 style="margin:0; color:#fff; font-size:1.1rem;">${pedido.setor}</h4>
                            <span style="color:var(--text-muted); font-size:0.9rem;">${qtdTotal} Camisetas | ${pedido.nome}</span>
                            <br><span style="font-size:0.8rem; color:#888;">${pedido.local}</span>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:var(--gold-solid); font-weight:700; font-size:1.2rem;">${formatarMoeda(valorTotal)}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">TOTAL</div>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-top:1px solid var(--border-subtle); padding-top:1rem; margin-top:0.5rem;">
                        <div style="font-size:0.9rem;">
                            <p style="color:var(--success-color); margin-bottom:2px;">Recebido: <strong>${formatarMoeda(valorRecebido)}</strong></p>
                            <p style="color:var(--danger-color);">Restante: <strong>${formatarMoeda(valorRestante > 0 ? valorRestante : 0)}</strong></p>
                            ${statusText}
                        </div>
                        <button onclick="window.abrirModalLiquidacao('${pedido.docId}')" class="btn-primary" style="padding:0.7rem 1.5rem; font-size:0.8rem;">LIQUIDAR</button>
                    </div>
                </div>
            `;
        });
        
        if(pedidosFiltrados.length === 0) lista.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding:2rem;">Nenhum pedido encontrado para o filtro atual.</p>`;

        window.mostrarCarregamento(false);
    };

    // FUNÇÃO PONTE (ALIAS) PARA MANTER COMPATIBILIDADE
    window.carregarPendencias = window.carregarPagamentos;
    window.atualizarPendencias = window.carregarPagamentos;

    
    // ABRIR MODAL
    window.abrirModalLiquidacao = async function(docId) {
        window.mostrarCarregamento(true);
        const docRef = doc(db, "pedidos", docId);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Pedido não encontrado.";
            document.getElementById('modalErroPDF').classList.add('active');
            window.mostrarCarregamento(false);
            return;
        }

        const pedido = { docId: docSnap.id, ...docSnap.data() };
        document.getElementById('liquidacaoDocId').value = pedido.docId;
        
        // Resetar o valor e a data
        const valorInput = document.getElementById('valorLiquidacao');
        valorInput.value = '';
        document.getElementById('dataLiquidacao').value = '';
        
        // Renderizar Histórico
        const histContainer = document.getElementById('historicoLiquidacoesContainer');
        const listaHist = document.getElementById('listaHistoricoLiquidacoes');
        listaHist.innerHTML = '';

        const liquidacoes = pedido.liquidacoes || [];
        
        if (liquidacoes.length > 0) {
            // Mostra do mais recente para o mais antigo
            [...liquidacoes].reverse().forEach(liq => {
                listaHist.innerHTML += `
                    <tr>
                        <td>${formatarDataPTBR(liq.data)}</td>
                        <td>${formatarMoeda(liq.valor)}</td>
                    </tr>
                `;
            });
            histContainer.style.display = 'block';
        } else {
            histContainer.style.display = 'none';
        }

        document.getElementById('modalLiquidacao').classList.add('active');
        
        // Foca no campo de valor
        setTimeout(() => valorInput.focus(), 100);
        
        window.mostrarCarregamento(false);
    };
    
    // FUNÇÃO PARA RECARREGAR LISTA DE PAGAMENTOS COM FEEDBACK
    window.recarregarPagamentosComFeedback = async function() {
        await window.carregarPagamentos();
        document.getElementById('modalFeedbackSucesso').classList.add('active');
    };

    // FUNÇÃO PARA RECARREGAR LISTA DE PEDIDOS COM FEEDBACK
    window.recarregarPedidosComFeedback = async function() {
        await window.carregarPedidos();
        document.getElementById('modalFeedbackSucesso').classList.add('active');
    };

    // CONFIRMAR LIQUIDAÇÃO
    window.confirmarLiquidacao = async function() {
        const docId = document.getElementById('liquidacaoDocId').value;
        const dataInput = document.getElementById('dataLiquidacao').value; // Formato DD/MM/AAAA
        
        // Limpar a máscara para obter o valor numérico puro
        const valorInput = document.getElementById('valorLiquidacao').value;
        const valorLimpo = valorInput.replace(/\D/g, ""); // Remove todos os não-dígitos
        let valorPago = 0;
        
        // Converte para float (Ex: "123456" -> 1234.56)
        if (valorLimpo.length > 0) {
            valorPago = parseFloat(valorLimpo.slice(0, -2) + "." + valorLimpo.slice(-2));
        }

        if (valorPago <= 0) {
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Informe um valor válido maior que zero.";
            document.getElementById('modalErroPDF').classList.add('active');
            return;
        }

        // Validar Formato Data Simples (DD/MM/AAAA)
        const regexData = /^\d{2}\/\d{2}\/\d{4}$/;
        if (!regexData.test(dataInput)) {
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Data inválida. Use o formato DD/MM/AAAA";
            document.getElementById('modalErroPDF').classList.add('active');
            return;
        }
        
        // Salvar string DDMMAAAA ou ISO se preferir, vamos manter string simples para compatibilidade visual
        // Mas para ordenação futura, timestamp é salvo também.
        
        window.mostrarCarregamento(true, "REGISTRANDO PAGAMENTO...");
        
        try {
            const docRef = doc(db, "pedidos", docId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) throw new Error("Pedido não existe");

            const pedido = docSnap.data();
            let liquidacoes = pedido.liquidacoes || [];
            
            liquidacoes.push({
                valor: valorPago, 
                data: dataInput,
                timestamp: new Date().toISOString() // Para controle
            });

            await updateDoc(docRef, { liquidacoes: liquidacoes });
            
            document.getElementById('modalLiquidacao').classList.remove('active');
            
            // REGRA 1 e 2: Exibe o modal de sucesso, que por sua vez acionará o recarregamento da lista ao ser fechado
            document.getElementById('modalSucessoLiquidacao').classList.add('active'); 
            
            // CORREÇÃO: Limpa o cache para que o Dashboard seja forçado a recarregar no próximo acesso
            window.pedidosCache = [];
            
        } catch (error) {
            console.error("Erro ao liquidar:", error);
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao salvar liquidação no banco de dados. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    // CANCELAR ÚLTIMA LIQUIDAÇÃO (LIFO)
    window.cancelarUltimaLiquidacao = async function() {
        const docId = document.getElementById('liquidacaoDocId').value;
        
        // Removendo o 'confirm' nativo para evitar problemas de execução.
        // O clique no botão é considerado a confirmação (com logs de erro internos).

        window.mostrarCarregamento(true, "CANCELANDO...");

        try {
            const docRef = doc(db, "pedidos", docId);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                 console.error("CANCELAR ULTIMA LIQUIDAÇÃO: Pedido não encontrado no DB.");
                 throw new Error("Pedido não encontrado");
            }

            const pedido = docSnap.data();
            let liquidacoes = pedido.liquidacoes || [];
            

            if (liquidacoes.length === 0) {
                document.getElementById('modalErroPDF').querySelector('p').textContent = "Não há liquidações para cancelar.";
                document.getElementById('modalErroPDF').classList.add('active');
                window.mostrarCarregamento(false);
                return;
            }

            // REMOVER A ÚLTIMA (POP)
            liquidacoes.pop();

            await updateDoc(docRef, { liquidacoes: liquidacoes });
            
            // 1. Fecha o modal de liquidação (Regra 2)
            document.getElementById('modalLiquidacao').classList.remove('active');
            
            // 2. Exibe o modal de sucesso de cancelamento (Regra 1)
            document.getElementById('modalSucessoCancelamento').classList.add('active'); 
            
            // A atualização da lista e dos totais (Regra 2) será feita quando o usuário clicar OK no modalSucessoCancelamento

            // CORREÇÃO: Limpa o cache para que o Dashboard seja forçado a recarregar no próximo acesso
            window.pedidosCache = [];

        } catch (error) {
            console.error("ERRO FATAL DURANTE O CANCELAMENTO.", error);
            document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao cancelar liquidação no banco de dados. Tente novamente.";
            document.getElementById('modalErroPDF').classList.add('active');
        } finally {
            window.mostrarCarregamento(false);
        }
    };

    window.confirmarFechamentoPedidos = async function() {
        const senhaInput = document.getElementById('senhaFecharPedidos'); const msgErro = document.getElementById('msgErroSenhaFechar'); const senha = senhaInput.value;
        if (senha !== 'JUBILEU') { msgErro.style.display = 'block'; return; }
        msgErro.style.display = 'none'; document.getElementById('modalFecharPedidos').classList.remove('active'); senhaInput.value = '';
        window.mostrarCarregamento(true, 'FECHANDO SISTEMA...');
        try { await setDoc(configSistemaRef, { aberto: false }, { merge: true }); } catch (error) { console.error("Erro ao fechar pedidos:", error); 
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao fechar pedidos. Tente novamente.";
        document.getElementById('modalErroPDF').classList.add('active');} finally { window.mostrarCarregamento(false); }
    };

    window.confirmarReaberturaPedidos = async function() {
        document.getElementById('modalReabrirPedidos').classList.remove('active');
        window.mostrarCarregamento(true, 'REABRINDO SISTEMA...');
        try { await setDoc(configSistemaRef, { aberto: true }, { merge: true }); } catch (error) { console.error("Erro ao reabrir pedidos:", error); 
        document.getElementById('modalErroPDF').querySelector('p').textContent = "Erro ao reabrir pedidos. Tente novamente.";
        document.getElementById('modalErroPDF').classList.add('active');} finally { window.mostrarCarregamento(false); }
    };

    // Função acionada ao CLICAR no botão "Área Administrativa"
    window.handleAdminAccessClick = function() {
        console.log("LOG: Botão 'Área Administrativa' clicado."); // LOG DE DEBUG
        window.redirecionarComAnimacao('admin', async () => {
            const user = auth.currentUser;
            const loginDiv = document.getElementById('loginAdmin');
            const painelDiv = document.getElementById('painelAdmin');
            
            console.log("LOG: Redirecionando para a seção 'admin'. User logado (não anônimo)?", user && !user.isAnonymous); // LOG DE DEBUG

            if (user && !user.isAnonymous) {
                // Usuário logado (não anônimo) -> Libera acesso imediato ao painel
                loginDiv.style.display = 'none';
                painelDiv.style.display = 'block';
                console.log("LOG: Usuário logado. Exibindo Painel Admin."); // LOG DE DEBUG

                if (!window.adminAcessouPainel) {
                    window.carregarDashboard();
                    window.adminAcessouPainel = true;
                    console.log("LOG: Carregando Dashboard pela primeira vez.");
                }
            } else {
                // Usuário não logado (anônimo) -> Mostra a tela de login
                loginDiv.style.display = 'block';
                painelDiv.style.display = 'none';
                console.log("LOG: Usuário anônimo. Exibindo tela de Login."); // LOG DE DEBUG
            }
        });
    };


    document.addEventListener('DOMContentLoaded', () => {
        const safeOnClick = (id, handler) => { const el = document.getElementById(id); if(el) el.onclick = handler; };
        const safeOnSubmit = (id, handler) => { const el = document.getElementById(id); if(el) el.onsubmit = handler; };
        const safeOnChange = (id, handler) => { const el = document.getElementById(id); if(el) el.onchange = handler; };
        
        // === CORREÇÃO TELA INICIAL MÓVEL ===
        checkAndShowSplash();
        
        // Manipula o clique para iniciar o loading e liberar o sistema
        safeOnClick('btnAcessarSistema', window.handleAccessAndLoading); 
        // ===================================
        
        // ============================================
        // 2 — MÁSCARA AUTOMÁTICA DE CELULAR (MANTIDA)
        // ============================================
        const inputContato = document.getElementById('contato');
        if (inputContato) {
            inputContato.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, ""); // Remove tudo que não é dígito
                
                // Limita a 11 dígitos
                if (v.length > 11) v = v.slice(0, 11);

                // Formatação progressiva (XX) XXXXX-XXXX
                if (v.length > 2) {
                    v = `(${v.substring(0, 2)}) ${v.substring(2)}`;
                }
                if (v.length > 7) { 
                   v = v.replace(/(\d{5})(\d{4})$/, "$1-$2");
                }
                
                e.target.value = v;
            });
        }
        
        // ====================================================
        // MÁSCARA DATA PARA LIQUIDAÇÃO (DD/MM/AAAA)
        // ====================================================
        const inputDataLiq = document.getElementById('dataLiquidacao');
        if (inputDataLiq) {
            inputDataLiq.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, "");
                if (v.length > 2) v = v.replace(/^(\d{2})(\d)/, "$1/$2");
                if (v.length > 5) v = v.replace(/^(\d{2})\/(\d{2})(\d)/, "$1/$2/$3");
                e.target.value = v;
            });
        }
        
        // ====================================================
        // 💰 3 — MÁSCARA MONETÁRIA (R$ 1.234,56)
        // ====================================================
        const inputValorLiq = document.getElementById('valorLiquidacao');
        if (inputValorLiq) {
            inputValorLiq.addEventListener('input', function(e) {
                window.aplicarMascaraMonetaria(e.target);
            });
        }

        safeOnClick('btnNovoPedido', () => { if (!SISTEMA_ABERTO) { document.getElementById('modalPedidosFechados').classList.add('active'); return; } window.setupNovoPedido(); window.redirecionarComAnimacao('pedido'); });
        safeOnClick('btnConsultarPedido', () => { window.redirecionarComAnimacao('consultar'); });
        
        // *** BOTÃO ÁREA ADMINISTRATIVA ***
        safeOnClick('btnAdministrador', window.handleAdminAccessClick);
        
        safeOnClick('voltarHome1', () => window.redirecionarComAnimacao('home'));
        safeOnClick('voltarHomeConsulta', () => window.redirecionarComAnimacao('home'));
        safeOnClick('voltarHome3', () => window.redirecionarComAnimacao('home'));
        
        safeOnClick('fecharConfirmacaoPedido', window.fecharConfirmacaoPedido);
        safeOnClick('voltarInicio', window.fecharConfirmacaoPedido);
        
        safeOnClick('btnEsqueceuId', () => document.getElementById('esqueceuIdOverlay').classList.add('active'));
        safeOnClick('fecharEsqueceuId', () => document.getElementById('esqueceuIdOverlay').classList.remove('active'));
        
        safeOnClick('btnAnaliseIA', () => { document.getElementById('analiseIAOverlay').classList.add('active'); window.handleAnaliseIA(); });
        safeOnClick('fecharAnaliseIA', () => document.getElementById('analiseIAOverlay').classList.remove('active'));
        
        safeOnSubmit('formLoginAdmin', window.handleAdminLogin);
        safeOnSubmit('formPedido', window.handleFormSubmission);
        
        safeOnSubmit('formConsultarNumero', async (e) => { e.preventDefault(); const v = document.getElementById('numPedidoConsultaInput').value; window.mostrarCarregamento(true); const p = await window.verificarPedidoPorNumero(v); window.mostrarCarregamento(false); if (p) window.displayVisualizacaoPedido(p); else {
            document.getElementById('modalErroPDF').querySelector('h2').textContent = "Pedido Não Encontrado";
            document.getElementById('modalErroPDF').querySelector('p').textContent = "O código ou e-mail informado não corresponde a nenhum pedido.";
            document.getElementById('modalErroPDF').classList.add('active'); 
        } });
        
        safeOnSubmit('formConsultarEmail', async (e) => { e.preventDefault(); const v = document.getElementById('emailConsultaInput').value; window.mostrarCarregamento(true); const p = await window.verificarPedidoPorEmail(v); window.mostrarCarregamento(false); if (p) window.displayVisualizacaoPedido(p); else {
            document.getElementById('modalErroPDF').querySelector('h2').textContent = "Pedido Não Encontrado";
            document.getElementById('modalErroPDF').querySelector('p').textContent = "O código ou e-mail informado não corresponde a nenhum pedido.";
            document.getElementById('modalErroPDF').classList.add('active'); 
        } });
        
        safeOnSubmit('formEsqueceuId', window.recuperarIdsPorEmail);
        
        // Listeners do Admin
        safeOnClick('atualizarDashboard', window.recarregarDashboardComFeedback); // Chamando função com feedback
        
        safeOnClick('btnPedidos', () => window.mostrarAdminSecao('pedidos'));
        safeOnClick('atualizarPedidos', window.recarregarPedidosComFeedback); // Chamando função com feedback
        
        // LISTENERS DO MÓDULO EVENTO (Antigo Financeiro)
        safeOnClick('btnEvento', () => window.mostrarAdminSecao('evento'));
        safeOnClick('atualizarEvento', window.recarregarDetalhesEventoComFeedback);
        safeOnClick('btnEncerrarEventoAction', () => { document.getElementById('modalEncerrarEvento').classList.add('active'); });
        safeOnClick('btnConfirmarEncerrarEvento', window.encerrarEvento);

        // LISTENERS DO MÓDULO PAGAMENTOS (Antigo Pendências Financeiras)
        safeOnClick('btnPagamentos', () => window.mostrarAdminSecao('pagamentos'));
        safeOnClick('atualizarPagamentos', window.recarregarPagamentosComFeedback); // Chamando função com feedback

        safeOnClick('btnVerDetalhes', () => { window.mostrarAdminSecao('detalhes-tamanhos'); window.carregarDetalhesTamanho(); });
        safeOnClick('voltarDashboard', () => window.mostrarAdminSecao('dashboard'));
        safeOnClick('atualizarDetalhesTamanho', window.carregarDetalhesTamanho);
        safeOnClick('btnGerarPdf', window.gerarRelatorioPdf);
        
        safeOnClick('btnSalvarValor', () => { document.getElementById('modalConfirmarValor').classList.add('active'); });
        safeOnClick('btnCancelarAlteracao', () => { document.getElementById('modalConfirmarValor').classList.remove('active'); });
        safeOnClick('btnConfirmarAlteracao', () => { document.getElementById('modalConfirmarValor').classList.remove('active'); const val = document.getElementById('valorCamisetaInput').value; window.recalcularValores(val); });
        safeOnClick('btnFecharPedidosAction', () => { document.getElementById('modalFecharPedidos').classList.add('active'); });
        safeOnClick('btnReabrirPedidosAction', () => { document.getElementById('modalReabrirPedidos').classList.add('active'); });
        
        // LISTENERS DO MODAL DE LIQUIDAÇÃO
        safeOnClick('btnConfirmarLiquidacao', window.confirmarLiquidacao);
        safeOnClick('btnCancelarLiquidacao', window.cancelarUltimaLiquidacao);

        // LISTENERS DO MODAL DE EXCLUSÃO DE PEDIDO
        safeOnClick('btnConfirmarExclusao', window.excluirPedido);

        safeOnChange('radioCapital', () => window.updateSetorCidadeInput());
        safeOnChange('radioInterior', () => window.updateSetorCidadeInput());
        
        // LISTENERS DE FILTRO E BUSCA
        const buscaInput = document.getElementById('buscaInput');
        if(buscaInput) buscaInput.addEventListener('input', () => window.carregarPedidos());
        
        document.querySelectorAll('input[name="filtroLocal"]').forEach(radio => {
            radio.addEventListener('change', () => window.carregarPedidos());
        });
        
        // CORREÇÃO: LISTENERS DA TELA PAGAMENTOS
        const buscaPagamentosInput = document.getElementById('buscaPagamentosInput');
        if(buscaPagamentosInput) buscaPagamentosInput.addEventListener('input', () => window.carregarPagamentos());
        
        document.querySelectorAll('input[name="filtroStatusPagamento"]').forEach(radio => {
            radio.addEventListener('change', () => window.carregarPagamentos());
        });

        window.updateSetorCidadeInput();
    });
  </script>
</body>
</html>
